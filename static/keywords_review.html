<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Resume Keywords Review - Human Feedback Feature [v2.0-MODE-FIX]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .job-info {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .job-info h2 {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .job-info p {
            color: #4a5568;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section h3 {
            font-size: 18px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .keyword {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .keyword:hover {
            background: #e2e8f0;
            border-color: #a0aec0;
        }

        .keyword-text {
            color: #2d3748;
        }

        .keyword-remove {
            background: #fc8181;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .keyword-remove:hover {
            background: #f56565;
        }

        .add-keyword-section {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .add-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .add-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #5568d3;
        }

        .actions {
            display: flex;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Review Extracted Keywords</h1>
            <p>Review and edit the keywords extracted from the job description before generating your resume</p>
        </div>

        <div class="content">
            <div class="job-info">
                <h2 id="jobTitle">Loading...</h2>
                <p id="companyName">Loading...</p>
            </div>

            <!-- Technical Keywords Section -->
            <div class="section">
                <div class="section-header">
                    <h3>
                        <span>üíª</span> Technical Keywords
                        <span class="count-badge" id="techCount">0</span>
                    </h3>
                </div>
                <div class="keywords-container" id="techKeywords"></div>
                <div class="add-keyword-section">
                    <input 
                        type="text" 
                        class="add-input" 
                        id="newTechKeyword" 
                        placeholder="Add a technical keyword (e.g., Python, AWS, Docker)..."
                    >
                    <button class="add-btn" onclick="addKeyword('technical')">‚ûï Add</button>
                </div>
            </div>

            <!-- Soft Skills Section -->
            <div class="section">
                <div class="section-header">
                    <h3>
                        <span>ü§ù</span> Soft Skills
                        <span class="count-badge" id="skillsCount">0</span>
                    </h3>
                </div>
                <div class="keywords-container" id="softSkills"></div>
                <div class="add-keyword-section">
                    <input 
                        type="text" 
                        class="add-input" 
                        id="newSoftSkill" 
                        placeholder="Add a soft skill (e.g., Leadership, Communication)..."
                    >
                    <button class="add-btn" onclick="addKeyword('soft')">‚ûï Add</button>
                </div>
            </div>

            <!-- Phrases Section -->
            <div class="section">
                <div class="section-header">
                    <h3>
                        <span>üí¨</span> Key Phrases
                        <span class="count-badge" id="phrasesCount">0</span>
                    </h3>
                </div>
                <div class="keywords-container" id="phrases"></div>
                <div class="add-keyword-section">
                    <input 
                        type="text" 
                        class="add-input" 
                        id="newPhrase" 
                        placeholder="Add a phrase (e.g., drive data-driven decisions)..."
                    >
                    <button class="add-btn" onclick="addKeyword('phrase')">‚ûï Add</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions">
                <button class="btn btn-secondary" onclick="resetToOriginal()">
                    ‚Ü∫ Reset to Original
                </button>
                <button class="btn btn-primary" onclick="submitFeedback()">
                    ‚úì Generate Resume with These Keywords
                </button>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Generating your optimized resume...</p>
                <p style="font-size: 14px; color: #718096; margin-top: 8px;">This may take up to 2 minutes</p>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                ‚úì Resume generated successfully! Redirecting to results...
            </div>
        </div>
    </div>

    <script>
        // Global state
        let requestId = '';
        let jobMode = null;  // Store mode from backend - CRITICAL for correct generation
        let originalKeywords = {
            technical_keywords: [],
            soft_skills: [],
            phrases: []
        };
        let currentKeywords = {
            technical_keywords: [],
            soft_skills: [],
            phrases: []
        };

        // Initialize from URL params or localStorage
        function init() {
            const params = new URLSearchParams(window.location.search);
            requestId = params.get('request_id') || localStorage.getItem('request_id');
            
            if (!requestId) {
                alert('No request ID found. Please start from the main page.');
                window.location.href = '/';
                return;
            }

            // Load keywords from localStorage or fetch from API
            const savedKeywords = localStorage.getItem(`keywords_${requestId}`);
            if (savedKeywords) {
                const data = JSON.parse(savedKeywords);
                loadKeywords(data);
            } else {
                // In a real implementation, fetch from API here
                console.error('Keywords not found. Please extract keywords first.');
            }
        }

        function loadKeywords(data) {
            // CRITICAL: Store the mode from backend response
            jobMode = data.mode;
            console.log('=== KEYWORD EXTRACTION RESPONSE PAYLOAD ===');
            console.log(JSON.stringify(data, null, 2));
            console.log('[MODE] Received mode from backend:', jobMode);
            console.log('==========================================');
            
            // Store original keywords
            originalKeywords = {
                technical_keywords: [...(data.technical_keywords || [])],
                soft_skills: [...(data.soft_skills || [])],
                phrases: [...(data.phrases || [])]
            };

            // Set current keywords
            currentKeywords = JSON.parse(JSON.stringify(originalKeywords));

            // Update UI
            document.getElementById('jobTitle').textContent = data.job_title || 'Job Title';
            document.getElementById('companyName').textContent = data.company_name || 'Company Name';

            renderKeywords();
        }

        function renderKeywords() {
            renderSection('techKeywords', currentKeywords.technical_keywords, 'technical');
            renderSection('softSkills', currentKeywords.soft_skills, 'soft');
            renderSection('phrases', currentKeywords.phrases, 'phrase');

            // Update counts
            document.getElementById('techCount').textContent = currentKeywords.technical_keywords.length;
            document.getElementById('skillsCount').textContent = currentKeywords.soft_skills.length;
            document.getElementById('phrasesCount').textContent = currentKeywords.phrases.length;
        }

        function renderSection(containerId, keywords, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            keywords.forEach((keyword, index) => {
                const keywordEl = document.createElement('div');
                keywordEl.className = 'keyword';
                keywordEl.innerHTML = `
                    <span class="keyword-text">${escapeHtml(keyword)}</span>
                    <button class="keyword-remove" onclick="removeKeyword('${type}', ${index})">√ó</button>
                `;
                container.appendChild(keywordEl);
            });
        }

        function addKeyword(type) {
            let inputId, arrayKey;
            
            if (type === 'technical') {
                inputId = 'newTechKeyword';
                arrayKey = 'technical_keywords';
            } else if (type === 'soft') {
                inputId = 'newSoftSkill';
                arrayKey = 'soft_skills';
            } else if (type === 'phrase') {
                inputId = 'newPhrase';
                arrayKey = 'phrases';
            }

            const input = document.getElementById(inputId);
            const value = input.value.trim();

            if (value && !currentKeywords[arrayKey].includes(value)) {
                currentKeywords[arrayKey].push(value);
                input.value = '';
                renderKeywords();
            }
        }

        function removeKeyword(type, index) {
            let arrayKey;
            
            if (type === 'technical') {
                arrayKey = 'technical_keywords';
            } else if (type === 'soft') {
                arrayKey = 'soft_skills';
            } else if (type === 'phrase') {
                arrayKey = 'phrases';
            }

            currentKeywords[arrayKey].splice(index, 1);
            renderKeywords();
        }

        function resetToOriginal() {
            currentKeywords = JSON.parse(JSON.stringify(originalKeywords));
            renderKeywords();
        }

        async function submitFeedback() {
            document.getElementById('loading').classList.add('active');
            document.querySelector('.content').style.opacity = '0.5';

            try {
                // Get auth token
                const token = localStorage.getItem('access_token');
                
                // Prepare payload
                const feedbackPayload = {
                    request_id: requestId,
                    mode: jobMode,  // CRITICAL: Send mode back to backend
                    feedback: currentKeywords
                };
                
                console.log('=== GENERATE RESUME REQUEST PAYLOAD ===');
                console.log(JSON.stringify(feedbackPayload, null, 2));
                console.log('[MODE] Submitting feedback with mode:', jobMode);
                console.log('======================================');
                
                // Submit feedback to API - INCLUDE MODE!
                const response = await fetch('/api/resume/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(feedbackPayload)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit feedback');
                }

                const result = await response.json();
                
                // Poll for completion
                await pollForCompletion(requestId, token);

                // Show success and redirect
                document.getElementById('successMessage').classList.add('active');
                setTimeout(() => {
                    window.location.href = `/result.html?request_id=${requestId}`;
                }, 2000);

            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Failed to generate resume. Please try again.');
                document.getElementById('loading').classList.remove('active');
                document.querySelector('.content').style.opacity = '1';
            }
        }

        async function pollForCompletion(requestId, token) {
            const maxAttempts = 60; // 3 minutes max
            let attempts = 0;

            while (attempts < maxAttempts) {
                const response = await fetch(`/api/jobs/${requestId}/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const status = await response.json();

                if (status.status === 'completed') {
                    return;
                } else if (status.status === 'failed') {
                    throw new Error(status.error_message || 'Generation failed');
                }

                await new Promise(resolve => setTimeout(resolve, 3000));
                attempts++;
            }

            throw new Error('Timeout waiting for resume generation');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.classList.contains('add-input')) {
                const type = e.target.id.includes('Tech') ? 'technical' : 
                           e.target.id.includes('Soft') ? 'soft' : 'phrase';
                addKeyword(type);
            }
        });

        // Initialize on load
        init();
    </script>
</body>
</html>
