<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume Builder Pro</title>
<link rel="stylesheet" href="/static/css/main.css?v=49.0">
</head>
<body>
<!-- Loading Overlay for Document Parsing -->
<div id="parseLoadingOverlay" class="parse-loading-overlay" style="display: none;">
  <div class="parse-loading-content">
    <div class="parse-loading-spinner"></div>
    <h2 class="parse-loading-title">Parsing Your Resume</h2>
    <p class="parse-loading-message">Extracting text and structuring your resume data...</p>
    <div class="parse-loading-progress">
      <div class="parse-progress-bar">
        <div id="parseProgressFill" class="parse-progress-fill"></div>
      </div>
      <p id="parseProgressText" class="parse-progress-text">0%</p>
    </div>
  </div>
</div>

<!-- Resume/JD View Modal -->
<div id="viewModal" class="view-modal" style="display: none;">
  <div class="view-modal-content">
    <div class="view-modal-header">
      <div class="view-modal-title-section">
        <h2 id="viewModalTitle"></h2>
        <p id="viewModalSubtitle"></p>
      </div>
      <button class="view-modal-close" onclick="closeViewModal()">âœ•</button>
    </div>
    <div class="view-modal-body" id="viewModalBody">
      <!-- Content will be loaded here -->
    </div>
    <div class="view-modal-footer">
      <button id="viewModalEditBtn" class="view-modal-btn primary" style="display: none;" onclick="toggleEditMode()">
        <span class="btn-icon">âœï¸</span>
        <span id="editBtnText">Edit</span>
      </button>
      <button id="viewModalSaveBtn" class="view-modal-btn primary" style="display: none;" onclick="saveResumeChanges()">
        <span class="btn-icon">ğŸ’¾</span>
        <span>Save Changes</span>
      </button>
      <button id="viewModalDownloadResume" class="view-modal-btn success" style="display: none;">
        <span class="btn-icon">ğŸ“„</span>
        <span>Download Resume</span>
      </button>
      <button id="viewModalDownloadJD" class="view-modal-btn success" style="display: none;">
        <span class="btn-icon">ğŸ“‹</span>
        <span>Download JD</span>
      </button>
      <button class="view-modal-btn cancel" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- Help/Tutorial Modal -->
<div id="helpModal" class="view-modal" style="display: none;">
  <div class="view-modal-content" style="max-width: 900px;">
    <div class="view-modal-header">
      <h2>ğŸ“š How to Use Resume Builder Pro</h2>
      <button class="view-modal-close" onclick="closeHelpModal()">âœ•</button>
    </div>
    <div class="view-modal-body" style="max-height: 70vh; overflow-y: auto;">
      <div style="padding: 20px; color: var(--text-primary);">
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
          <h3 style="margin-top: 0; color: var(--primary);">ğŸ¯ Welcome to Resume Builder Pro!</h3>
          <p style="line-height: 1.6;">An AI-powered platform that helps you create perfectly tailored resumes for every job application. Our intelligent system analyzes job descriptions and optimizes your resume to match exactly what employers are looking for.</p>
          <p style="line-height: 1.6; margin-top: 10px;"><strong>âœ¨ New Features:</strong> View & edit generated resumes, manage technical skills, track all applications in your personal dashboard!</p>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">1</span>
            Choose Your Generation Mode
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p><strong>ğŸ“ Complete JD Mode:</strong> Generate a resume entirely from a job description. Best when starting from scratch.</p>
            <p><strong>ğŸ”„ Resume + JD Mode:</strong> Apply targeted edits to your existing resume based on a job description. Best for tailoring an existing resume.</p>
            <p style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 4px;">ğŸ’¡ <em>Tip: Use Resume + JD mode for better results when you have an existing resume!</em></p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">2</span>
            Fill in Job Description
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>Paste the complete job description including:</p>
            <ul style="line-height: 1.8;">
              <li>ğŸ“‹ Job responsibilities and requirements</li>
              <li>ğŸ”§ Required skills and technologies</li>
              <li>ğŸ“ Qualifications and experience needed</li>
            </ul>
            <p style="margin-top: 10px;"><strong>Company Name:</strong> Enter the company name</p>
            <p><strong>Job Title:</strong> Enter the exact position title</p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">3</span>
            Add Your Resume Data (Resume + JD Mode)
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>If using <strong>Resume + JD Mode</strong>, fill in your resume sections:</p>
            <ul style="line-height: 1.8;">
              <li>ğŸ‘¤ <strong>Personal Info:</strong> Name, email, phone, LinkedIn, location</li>
              <li>ğŸ“ <strong>Summary:</strong> Professional summary (50+ characters)</li>
              <li>ğŸ’» <strong>Technical Skills:</strong> Add categories (e.g., Languages, Frameworks) and skills</li>
              <li>ğŸ’¼ <strong>Experience:</strong> Add roles with bullet points describing achievements</li>
              <li>ğŸ“ <strong>Education:</strong> Add degrees and institutions</li>
              <li>ğŸš€ <strong>Projects:</strong> Optional - showcase your work</li>
              <li>ğŸ“œ <strong>Certifications:</strong> Optional - add relevant certifications</li>
            </ul>
            <p style="margin-top: 10px; padding: 10px; background: var(--warning-bg); border-radius: 4px; border-left: 4px solid #f59e0b;">
              âš ï¸ <strong>Important:</strong> All required fields must be filled (minimum 50 characters for summary and job description).
            </p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">4</span>
            Generate Your Resume
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>Click <strong>"ğŸš€ Generate Resume"</strong> to start processing.</p>
            <p style="margin-top: 10px;">â±ï¸ Generation takes <strong>30-90 seconds</strong>. You'll see:</p>
            <ul style="line-height: 1.8;">
              <li>âœ… Green notification when ready</li>
              <li>ğŸ“Š Progress in the dashboard</li>
              <li>ğŸ”” Real-time status updates</li>
            </ul>
            <p style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 4px;">ğŸ’¡ <em>You can generate up to 2 resumes simultaneously! Additional requests will queue automatically.</em></p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">5</span>
            View, Edit & Download Your Resume
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p><strong>ğŸ‰ Your resume is ready!</strong> Access it from the dashboard with these powerful options:</p>
            
            <p style="margin-top: 15px;"><strong>ğŸ“‹ Dashboard Actions (â‹® Menu):</strong></p>
            <ul style="line-height: 1.8;">
              <li>ğŸ‘ï¸ <strong>View Resume:</strong> Opens an interactive preview modal</li>
              <li>ğŸ‘ï¸ <strong>View Job Description:</strong> Review the original JD you submitted</li>
              <li>ï¿½ <strong>Download Resume:</strong> Get your DOCX file instantly</li>
              <li>ï¿½ <strong>Download JD:</strong> Save the job description as text</li>
              <li>ğŸ—‘ï¸ <strong>Delete:</strong> Remove entries you no longer need</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>âœï¸ Edit Mode (NEW!):</strong></p>
            <p style="margin-top: 10px;">Click the <strong>"Edit"</strong> button in the view modal to unlock powerful editing:</p>
            <ul style="line-height: 1.8;">
              <li>âœ… <strong>All Text Fields:</strong> Click any text to edit (name, email, phone, LinkedIn, summary, etc.)</li>
              <li>ğŸ’¼ <strong>Experience Bullets:</strong> Modify job descriptions and achievements</li>
              <li>ğŸ“ <strong>Education & Certifications:</strong> Update degrees, schools, dates</li>
              <li>ğŸš€ <strong>Projects:</strong> Edit project descriptions and details</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>ğŸ”§ Advanced Technical Skills Editing:</strong></p>
            <ul style="line-height: 1.8;">
              <li>ğŸ“ <strong>Edit Category Names:</strong> Click skill category names (e.g., "Programming Languages") to rename them</li>
              <li>ğŸ’¡ <strong>Edit Skills:</strong> Click skill values to add/remove/modify skills</li>
              <li>â• <strong>Add Categories:</strong> Click "Add Category" button to create new skill groups</li>
              <li>ğŸ—‘ï¸ <strong>Remove Categories:</strong> Delete unwanted skill categories with one click</li>
            </ul>
            
            <p style="margin-top: 15px; padding: 12px; background: var(--success-bg); border-radius: 6px; border-left: 4px solid #10b981;">
              ğŸ’¾ <strong>Auto-Save:</strong> Click "Save Changes" to persist all edits to the database. Changes are permanent and will reflect in future downloads!
            </p>
            
            <p style="margin-top: 15px; padding: 12px; background: var(--bg); border-radius: 6px;">
              ğŸ“¥ <strong>Download Anytime:</strong> Both Resume and Job Description can be downloaded from the view modal or dashboard menu.
            </p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            âš™ï¸ Additional Features
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            
            <p><strong>ğŸ“‚ Import/Export JSON:</strong> Reuse your resume data across applications</p>
            <ul style="line-height: 1.8;">
              <li>ğŸ’¾ <strong>Download JSON:</strong> Export your resume data to save locally</li>
              <li>ğŸ“‚ <strong>Upload JSON:</strong> Import previously saved data instantly</li>
              <li>ğŸ”„ <strong>Version Control:</strong> Maintain different resume versions for different roles</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>ğŸ” Dashboard Search & Filter:</strong></p>
            <ul style="line-height: 1.8;">
              <li>ğŸ” <strong>Search:</strong> Find resumes by company name or job title</li>
              <li>ğŸ“Š <strong>Filter by Status:</strong> View All, Completed, Processing, or Failed jobs</li>
              <li>ğŸ“… <strong>Sort by Date:</strong> Most recent resumes appear first</li>
              <li>ğŸ”„ <strong>Real-time Updates:</strong> Dashboard refreshes automatically</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>ğŸ‘¤ User Account Management:</strong></p>
            <ul style="line-height: 1.8;">
              <li>ğŸ” <strong>Secure Login:</strong> Your resumes are private and secure</li>
              <li>ğŸ‘¥ <strong>Multi-User:</strong> Each user has isolated resume history</li>
              <li>ğŸšª <strong>Logout:</strong> End session securely anytime</li>
              <li>ğŸ“Š <strong>Job Limits:</strong> Up to 2 concurrent generations per user</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>ğŸ¨ Customization:</strong></p>
            <ul style="line-height: 1.8;">
              <li>ğŸŒ™ <strong>Dark Mode:</strong> Toggle between light/dark themes</li>
              <li>ğŸ’« <strong>Smooth Animations:</strong> Polished UI with transitions</li>
              <li>ğŸ“± <strong>Responsive:</strong> Works on desktop, tablet, and mobile</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>ğŸ”” Notifications & Feedback:</strong></p>
            <ul style="line-height: 1.8;">
              <li>âœ… <strong>Success Messages:</strong> Confirmation for all actions</li>
              <li>âŒ <strong>Error Alerts:</strong> Clear explanations when issues occur</li>
              <li>â±ï¸ <strong>Progress Indicators:</strong> Visual feedback during generation</li>
              <li>ğŸ¯ <strong>Status Badges:</strong> Color-coded job statuses</li>
            </ul>
          </div>
        </div>

        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); padding: 20px; border-radius: 8px; color: white; margin-top: 30px;">
          <h3 style="margin-top: 0; color: white;">ğŸ’¡ Pro Tips for Best Results</h3>
          <ul style="line-height: 2;">
            <li>ğŸ¯ <strong>Use Resume + JD Mode:</strong> Better results when you have existing resume data</li>
            <li>ğŸ“ <strong>Complete Job Descriptions:</strong> Paste entire job postings for best AI matching</li>
            <li>ğŸ’ª <strong>Action Verbs:</strong> Use Led, Developed, Achieved, Implemented, Increased in bullets</li>
            <li>ğŸ“Š <strong>Quantify Everything:</strong> Add numbers, percentages, and metrics (e.g., "Increased sales by 40%")</li>
            <li>ğŸ”„ <strong>Try Multiple Times:</strong> Each generation varies - regenerate if not satisfied</li>
            <li>âœï¸ <strong>Edit Mode is Powerful:</strong> Fine-tune AI content, rename skill categories, add new sections</li>
            <li>ğŸ’¾ <strong>Save Best Versions:</strong> Export winning resumes as JSON to reuse structure</li>
            <li>ğŸ” <strong>Review Before Download:</strong> Use view mode to check everything before downloading DOCX</li>
            <li>ğŸ¨ <strong>Customize Skills:</strong> Add niche technologies and tools employers mention</li>
            <li>ï¿½ <strong>Track Applications:</strong> Use dashboard to remember which companies you've applied to</li>
            <li>âš¡ <strong>Concurrent Jobs:</strong> Generate 2 resumes at once for different applications</li>
            <li>ğŸ›¡ï¸ <strong>Fill Required Fields:</strong> Summary and JD need 50+ characters to pass validation</li>
          </ul>
        </div>

        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-top: 30px; border: 2px solid var(--border);">
          <h3 style="color: var(--primary); margin-top: 0;">âš ï¸ Important Notes</h3>
          <ul style="line-height: 1.8;">
            <li>â±ï¸ <strong>Generation Time:</strong> Expect 30-90 seconds per resume</li>
            <li>ğŸ”¢ <strong>Concurrent Limits:</strong> Maximum 2 active jobs per user (additional requests queue automatically)</li>
            <li>âœ… <strong>Validation Required:</strong> Summary and Job Description must be 50+ characters</li>
            <li>ğŸ’¾ <strong>Changes Are Permanent:</strong> Edit mode saves directly to database - no undo!</li>
            <li>ğŸ“± <strong>Browser Required:</strong> Works best in Chrome, Firefox, Safari, or Edge</li>
            <li>ğŸ”’ <strong>Private & Secure:</strong> Your data is isolated per user account</li>
          </ul>
        </div>

        <div style="text-align: center; margin-top: 30px; padding: 20px; border-top: 2px solid var(--border);">
          <p style="color: var(--text-secondary); font-size: 16px;">
            ğŸ“– Need more help? Check the <strong>README.md</strong> file for technical details, API configuration, and troubleshooting.<br>
            â“ Questions? Re-open this guide anytime by clicking the <strong>â“ Help</strong> button in the header!
          </p>
        </div>

      </div>
    </div>
    <div class="view-modal-footer">
      <button class="view-modal-btn success" onclick="closeHelpModal()">Got it! Let's Start</button>
    </div>
  </div>
</div>

<header id="mainHeader" style="display: none;">
  <h1>Resume Builder Pro</h1>
  <div id="menuActions">
    <span id="headerUserInfo" style="margin-right: 15px; color: var(--text-secondary); display: none;"></span>
    <button id="helpBtn" onclick="showHelpModal()" style="background: var(--primary); margin-right: 10px;">â“ Help</button>
    <button id="logoutBtn" onclick="handleMainLogout()" style="background: var(--danger); display: none;">ğŸšª Logout</button>
    <button id="toggleTheme">ğŸŒ™ Dark</button>
  </div>
</header>

<main>
  <!-- Login/Register Screen (shown first) -->
  <div id="authScreen" class="auth-screen">
    <!-- Left Column: Brand/Visual -->
    <div class="auth-brand">
      <div class="auth-brand-content">
        <div class="brand-logo">
          <h1>Resume Builder Pro</h1>
          <p class="brand-tagline">AI-Powered Resume Optimization</p>
        </div>
        
        <div class="brand-features">
          <div class="feature-item">
            <div class="feature-icon">âœ¨</div>
            <div class="feature-text">
              <h3>Smart Tracking</h3>
              <p>Track all your resume versions in one place</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">ğŸ¯</div>
            <div class="feature-text">
              <h3>AI Optimization</h3>
              <p>Tailor resumes to match job descriptions</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">ğŸ“„</div>
            <div class="feature-text">
              <h3>Instant Downloads</h3>
              <p>Export professional resumes anytime</p>
            </div>
          </div>
        </div>

        <div class="brand-stats">
          <div class="stat-item">
            <div class="stat-number">1K+</div>
            <div class="stat-label">Resumes Created</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">95%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">24/7</div>
            <div class="stat-label">Available</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Form -->
    <div class="auth-form-column">
      <div class="auth-form-container">
        <div class="auth-header">
          <h2>Welcome</h2>
          <p>Enter your credentials to access your account</p>
        </div>

        <!-- Login Form -->
        <div id="mainLoginForm" class="auth-form active">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="mainLoginUsername" placeholder="Enter your username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="mainLoginPassword" placeholder="Enter your password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handleMainLogin()">Sign In</button>
          
          <div style="text-align: center; margin-top: 12px;">
            <a href="#" onclick="switchMainAuthTab('reset'); return false;" style="font-size: 13px; color: var(--accent); text-decoration: none;">Forgot Password?</a>
          </div>
          
          <div class="auth-switch">
            <span>Don't have an account?</span>
            <a href="#" onclick="switchMainAuthTab('register'); return false;">Create account</a>
          </div>
        </div>

        <!-- Reset Password Form -->
        <div id="mainResetForm" class="auth-form">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="mainResetUsername" placeholder="Enter your username">
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="mainResetNewPassword" placeholder="Enter new password (min 8 characters)">
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="mainResetConfirmPassword" placeholder="Confirm new password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handlePasswordReset()">Reset Password</button>
          
          <div class="auth-switch">
            <span>Remember your password?</span>
            <a href="#" onclick="switchMainAuthTab('login'); return false;">Sign in</a>
          </div>
        </div>

        <!-- Register Form -->
        <div id="mainRegisterForm" class="auth-form">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="mainRegisterUsername" placeholder="Choose a username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="mainRegisterPassword" placeholder="Choose a password (min 8 characters)">
          </div>
          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="mainRegisterPasswordConfirm" placeholder="Confirm your password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handleMainRegister()">Create Account</button>
          
          <div class="auth-switch">
            <span>Already have an account?</span>
            <a href="#" onclick="switchMainAuthTab('login'); return false;">Sign in</a>
          </div>
        </div>

        <div id="mainAuthMessage" style="margin-top: 20px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>
        
        <!-- Minimal Footer -->
        <div class="auth-footer-links">
          <a href="#">Privacy Policy</a>
          <span>Â·</span>
          <a href="#">Terms of Service</a>
          <span>Â·</span>
          <a href="#">Help Center</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div id="mainApp" style="display: none;">
    <div id="tabContainer">
      <nav id="sidebar">
        <button class="tab-btn active" id="tabResumeBtn" type="button">View Resume</button>
        <button class="tab-btn" id="tabEditJDBtn" type="button">Generate Resume</button>
        <button class="tab-btn" id="tabDashboardBtn" type="button">My Dashboard</button>
      </nav>

      <section id="tabContentArea">
      <div id="resumeFormContainer" class="active">
        <input type="file" id="uploadJSON" accept=".json" style="display: none;">
        <input type="file" id="uploadResume" accept=".pdf,.docx" style="display: none;">
        
        <!-- Action Buttons - Top Right -->
        <div class="top-action-buttons">
          <button class="top-action-btn primary" onclick="saveResumeTemplate()" title="Save current resume as template">
            <span class="icon">ğŸ’¾</span>
            <span>Save</span>
          </button>
          
          <button class="top-action-btn" onclick="triggerResumeUpload()" title="Upload resume from PDF/DOCX file">
            <span class="icon">ğŸ“‚</span>
            <span>Upload</span>
          </button>
          
          <div class="download-group-top">
            <div class="download-options-top" id="downloadOptionsTop">
              <button class="download-option-top" onclick="downloadJSON(); toggleDownloadMenuTop();">
                <span class="icon">ğŸ“„</span>
                <span>Download JSON</span>
              </button>
              <button class="download-option-top" onclick="downloadWordDoc(); toggleDownloadMenuTop();">
                <span class="icon">ğŸ“</span>
                <span>Download Word</span>
              </button>
            </div>
            <button class="top-action-btn" onclick="toggleDownloadMenuTop()" title="Download resume">
              <span class="icon">â¬‡ï¸</span>
              <span>Download</span>
            </button>
          </div>
          
          <button class="top-action-btn danger" onclick="clearAll()" title="Clear all form fields">
            <span class="icon">ğŸ§¹</span>
            <span>Clear All</span>
          </button>
        </div>

        <form id="resumeForm">
          <!-- Side Navigation & Content -->
          <div class="form-nav-container">
            <!-- Side Navigation -->
            <div class="form-nav">
              <button type="button" class="form-nav-btn active" onclick="showFormSection('basic')">
                <span class="icon">ğŸ“</span>
                <span>Basic Info</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('contact')">
                <span class="icon">ğŸ“</span>
                <span>Contact</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('skills')">
                <span class="icon">ğŸ› ï¸</span>
                <span>Skills</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('experience')">
                <span class="icon">ğŸ’¼</span>
                <span>Experience</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('education')">
                <span class="icon">ğŸ“</span>
                <span>Education</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('projects')">
                <span class="icon">ğŸš€</span>
                <span>Projects</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('certifications')">
                <span class="icon">ğŸ†</span>
                <span>Certifications</span>
              </button>
            </div>

            <!-- Content Panels -->
            <div class="form-sections">
              <!-- Basic Information Section -->
              <div id="section-basic" class="form-section-panel active">
                <h3><span>ğŸ“</span> Basic Information</h3>
                <label>Name</label>
                <input name="name" placeholder="e.g., Gachibowli Diwakar" required="">
                
                <label style="margin-top: 12px;">Summary</label>
                <textarea name="summary" rows="10" placeholder="Professional summary ..." required=""></textarea>
              </div>

              <!-- Contact Information Section -->
              <div id="section-contact" class="form-section-panel">
                <h3><span>ğŸ“</span> Contact Information</h3>
                <div id="contactList"><div class="entry"><input placeholder="Label (e.g., phone, email, linkedin)" class="contact-key" value="">
    <input placeholder="Value" class="contact-value" value=""></div></div>
                <button type="button" class="sub-btn" onclick="addContact()">+ Add Contact Field</button>
              </div>

              <!-- Technical Skills Section -->
              <div id="section-skills" class="form-section-panel">
                <h3><span>ğŸ› ï¸</span> Technical Skills</h3>
                <div id="skillsList"><div class="entry"><input placeholder="Category" class="skill-key" value="">
    <input placeholder="Values (comma-separated)" class="skill-value" value=""></div></div>
                <button type="button" class="sub-btn" onclick="addSkill()">+ Add Skill</button>
              </div>

              <!-- Experience Section -->
              <div id="section-experience" class="form-section-panel">
                <h3><span>ğŸ’¼</span> Experience</h3>
                <div id="experienceList"><div class="entry"><input placeholder="Company" class="exp-company" value="">
  <input placeholder="Role" class="exp-role" value="">
  <input placeholder="Period" class="exp-period" value="">
  <div class="bullets"><div class="bullet"><input placeholder="Achievement..." class="exp-point" value="">
    <button class="remove-btn" onclick="this.parentElement.remove()">ğŸ—‘</button></div></div><button type="button" class="sub-btn" onclick="addBullet(this)">+ Add Bullet</button></div></div>
                <button type="button" class="sub-btn" onclick="addExperience()">+ Add Experience</button>
              </div>

              <!-- Education Section -->
              <div id="section-education" class="form-section-panel">
                <h3><span>ğŸ“</span> Education</h3>
                <div id="educationList"><div class="entry"><input placeholder="Degree" class="edu-degree" value="">
    <input placeholder="Institution" class="edu-inst" value="">
    <input placeholder="Year" class="edu-year" value=""></div></div>
                <button type="button" class="sub-btn" onclick="addEducation()">+ Add Education</button>
              </div>

              <!-- Projects Section -->
              <div id="section-projects" class="form-section-panel">
                <h3><span>ğŸš€</span> Projects</h3>
                <div id="projectsList"></div>
                <button type="button" class="sub-btn" onclick="addProject()">+ Add Project</button>
              </div>

              <!-- Certifications Section -->
              <div id="section-certifications" class="form-section-panel">
                <h3><span>ğŸ†</span> Certifications</h3>
                <div id="certificationsList"></div>
                <button type="button" class="sub-btn" onclick="addCertification()">+ Add Certification</button>
              </div>
            </div>
          </div>
        </form>

        <!-- Scroll to Top Button -->
        <button id="scrollToTop" onclick="scrollToTop()">â†‘</button>
        
        <!-- Action Bar (shown in View Resume tab) -->
        <div class="action-bar" id="actionBar">
          <input type="file" id="uploadJSON" accept=".json">
          
          <!-- Save Template Button -->
          <button class="action-btn primary" onclick="saveResumeTemplate()">
            <span class="icon">ğŸ’¾</span>
            <span>Save</span>
          </button>
          
          <!-- Upload Button -->
          <button class="action-btn" onclick="triggerUpload()">
            <span class="icon">ğŸ“‚</span>
            <span>Upload JSON</span>
          </button>
          
          <!-- Download Group with Dropdown -->
          <div class="download-group">
            <div class="download-options" id="downloadOptions">
              <button class="download-option" onclick="downloadJSON(); toggleDownloadMenu();">
                <span class="icon">ğŸ“„</span>
                <span>Download JSON</span>
              </button>
              <button class="download-option" onclick="downloadWordDoc(); toggleDownloadMenu();">
                <span class="icon">ğŸ“</span>
                <span>Download Word</span>
              </button>
            </div>
            <button class="action-btn" onclick="toggleDownloadMenu()">
              <span class="icon">â¬‡ï¸</span>
              <span>Download</span>
            </button>
          </div>
          
          <!-- Clear All Button -->
          <button class="action-btn danger" onclick="clearAll()">
            <span class="icon">ğŸ§¹</span>
            <span>Clear All</span>
          </button>
        </div>
        
        <!-- Status Modal Popup -->
        <div id="statusModal" class="modal" style="display:none;z-index:3000;">
          <div class="modal-content" style="width:280px;min-height:80px;padding:24px;">
            <span id="statusText" style="font-weight:600; color:var(--accent); font-size:15px;"></span>
          </div>
        </div>
      </div>

      <div id="jobDescTabPanel">
        <div class="jd-form-container">
          <!-- Compact Top Section with Input Fields -->
          <div class="jd-form-header">
            <div class="jd-input-row">
              <div class="jd-input-col">
                <label for="companyNameJD"><b>Company Name *</b></label>
                <input id="companyNameJD" name="companyNameJD" placeholder="e.g., Microsoft, Google" type="text" required>
              </div>
              <div class="jd-input-col">
                <label for="jobTitleJD"><b>Job Title *</b></label>
                <input id="jobTitleJD" name="jobTitleJD" placeholder="e.g., Software Engineer" type="text" required>
              </div>
            </div>
            
            <!-- Compact Mode Selection with Generate Button -->
            <div class="jd-mode-generate-row">
              <div class="jd-mode-section">
                <label class="mode-label">Mode:</label>
                <div class="mode-options">
                  <label class="mode-option">
                    <input type="radio" name="resumeMode" value="resume_jd" onchange="updateModeDescription()">
                    <span>Resume + JD</span>
                  </label>
                  <label class="mode-option">
                    <input type="radio" name="resumeMode" value="complete_jd" checked onchange="updateModeDescription()">
                    <span>Complete JD</span>
                  </label>
                </div>
                <p id="modeDescription" class="mode-description">
                  Creates a complete resume from scratch using only the job description
                </p>
              </div>
              <button id="generateJDResumeBtn" type="button" class="generate-btn-inline">
                <span class="btn-icon">ğŸš€</span>
                <span class="btn-text">Generate Resume</span>
              </button>
            </div>
          </div>
          
          <!-- Job Description Text Area - Takes Most Space -->
          <div class="jd-textarea-container">
            <label for="jobDescriptionTab"><b>Job Description *</b></label>
            <textarea id="jobDescriptionTab" placeholder="Paste the job description here...&#10;&#10;Include:&#10;â€¢ Job responsibilities&#10;â€¢ Required skills & qualifications&#10;â€¢ Nice-to-have skills&#10;â€¢ Company information"></textarea>
          </div>
        </div>
      </div>

      <!-- Dashboard Tab Panel -->
      <div id="dashboardTabPanel">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <h2>ğŸ“Š My Dashboard</h2>
        </div>
        
        <div id="dashboardMessage" style="margin-bottom: 20px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>

        <!-- Stats Cards -->
        <div id="statsCards" class="stats-grid">
          <!-- Stats will be loaded here -->
        </div>

        <!-- Resume History Table -->
        <div class="resume-table-container">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 24px 16px 24px;">
            <div>
              <h3 style="margin: 0; padding: 0;">My Resumes</h3>
              <span id="resultCount" style="font-size: 13px; color: var(--text-secondary); display: block; margin-top: 4px;"></span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 13px; color: var(--text-secondary);">Show:</span>
              <select id="pageSizeSelect" onchange="changePageSize()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer;">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
          
          <!-- Filter Section -->
          <div style="padding: 0 24px 16px 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="filterCompany" placeholder="ğŸ” Filter by Company" 
              oninput="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; flex: 1; min-width: 150px;">
            
            <input type="text" id="filterJobTitle" placeholder="ğŸ” Filter by Job Title" 
              oninput="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; flex: 1; min-width: 150px;">
            
            <select id="filterStatus" onchange="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer;">
              <option value="">All Status</option>
              <option value="completed">Completed</option>
              <option value="processing">Processing</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
            </select>
            
            <button onclick="clearDashboardFilters()" 
              style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer; white-space: nowrap;">
              âœ• Clear Filters
            </button>
          </div>
          
          <div class="resume-table-wrapper">
            <table class="resume-table" id="resumeHistoryTable">
              <thead>
                <tr>
                  <th style="padding: 12px 16px;">Company</th>
                  <th style="padding: 12px 16px;">Job Title</th>
                  <th style="padding: 12px 16px;">Status</th>
                  <th style="padding: 12px 16px; text-align: center;">Progress</th>
                  <th style="padding: 12px 16px;">Created</th>
                  <th style="padding: 12px 16px; text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="resumeHistoryBody">
                <!-- Resume rows will be loaded here -->
              </tbody>
            </table>
          </div>
          <div class="pagination-container" id="paginationContainer">
            <!-- Pagination will be loaded here -->
          </div>
        </div>
      </div>
    </section>
  </div>
  </div> <!-- Close mainApp -->
</main>

<!-- Processing Banner -->
<div id="processingBanner">
  <div class="banner-header">
    <div class="banner-title">
      <div class="spinner-small"></div>
      <span id="bannerCount">Processing resumes...</span>
    </div>
    <button class="close-banner" onclick="closeProcessingBanner()" title="Minimize">Ã—</button>
  </div>
  <div class="requests-list" id="requestsList">
    <!-- Request items will be added here dynamically -->
  </div>
</div>

<!-- ===== ABOUT MODAL ===== -->
<div id="aboutModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAbout()">Ã—</span>
    <h3>About Resume Builder Pro</h3>
    <p>Created by Sushmitha for generating professional Word resumes with FastAPI backend integration.</p>
    <p>Version: 1.0.0</p>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer id="mainFooter" style="display: none;">
  <!-- FAQ SECTION (collapsible) -->
  <section class="faq-section" id="faqSection">
    <div class="faq-header">
      <h2>Frequently Asked Questions</h2>
      <button class="faq-close" onclick="toggleFAQSection()">âœ•</button>
    </div>
    
    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How does Resume Builder Pro work?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Resume Builder Pro uses AI to tailor your resume to specific job descriptions. Fill in your resume details, paste a job description, and our AI will analyze and optimize your resume content to match the job requirements using advanced LLM technology.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What's the difference between "Complete JD" and "Resume + JD" modes?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        <strong>Complete JD Mode:</strong> Generates brand new content from scratch using the job description, preserving only company names, dates, and titles. Best for maximum ATS alignment.<br><br>
        <strong>Resume + JD Mode:</strong> Makes targeted edits to your existing resume content while keeping most of your original writing. Best when you have a strong resume that needs minor adjustments.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How many resumes can I generate at once?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        You can generate up to 4 resumes concurrently! Just fill in different job descriptions and click "Generate Resume" multiple times. The processing banner in the top-right corner shows all active requests.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>Can I save and reuse my resume data?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Yes! Use the floating "Download JSON" button (ğŸ’¾) to save your resume data as a JSON file. Later, use "Upload JSON" (ğŸ“‚) to reload all your information instantly. This lets you maintain multiple resume versions for different roles.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What format is the generated resume?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Resumes are generated as professional Microsoft Word (.docx) files with proper formatting, including clickable hyperlinks for emails and URLs in the contact section. Download from the "generated_resumes" folder.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How does the AI optimize my resume?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        The AI analyzes the job description to extract keywords, required skills, and responsibilities. It then rewrites your Summary, Skills, and Experience sections to align with these requirements while maintaining truthfulness. Each experience role gets 6-8 optimized bullet points with measurable impacts.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What LLM provider is used?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Currently configured to use Google Gemini (gemini-2.5-flash) via the Google Generative AI API. The system is provider-agnostic and can be configured to use OpenAI or other LLM providers through the .env file.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How do I clear all my data?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Click the floating "Clear All" button (ğŸ§¹) at the bottom right. This will reset all fields in both the Resume and Job Description tabs. Make sure to download your JSON first if you want to save your data!
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>Is my information private?</span>
        <span class="faq-icon">â–¼</span>
      </button>
      <div class="faq-answer">
        Yes, we take your privacy seriously. Your data is never shared, and all resume content is processed securely. We don't store any personal information on our servers.
      </div>
    </div>
  </section>

  <div class="footer-content">
    <div class="footer-about">
      <h3>Resume Builder Pro</h3>
      <p>Create stunning, professional resumes in minutes. Our intuitive platform helps you showcase your skills and experience with beautifully designed templates.</p>
      <a href="#" onclick="openAbout(); return false;">Learn More â†’</a>
      <div class="social-links">
        <a href="https://linkedin.com" target="_blank" title="LinkedIn">ğŸ’¼</a>
        <a href="https://github.com" target="_blank" title="GitHub">ğŸ™</a>
        <a href="https://twitter.com" target="_blank" title="Twitter">ğŸ¦</a>
        <a href="mailto:support@resumebuilder.pro" title="Email">ğŸ“§</a>
      </div>
    </div>

    <div class="footer-section">
      <h4>Product</h4>
      <ul class="footer-links">
        <li><a href="#" onclick="document.querySelector('.dropdown-btn').click(); return false;">Templates</a></li>
        <li><a href="#" onclick="switchTab('resume'); return false;">View Resume</a></li>
        <li><a href="#" onclick="switchTab('jd'); return false;">Generate Resume</a></li>
        <li><a href="#" onclick="toggleFAQSection(); return false;">FAQ</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Legal</h4>
      <ul class="footer-links">
        <li><a href="#privacy">Privacy Policy</a></li>
        <li><a href="#terms">Terms of Service</a></li>
        <li><a href="#cookies">Cookie Policy</a></li>
        <li><a href="#license">License</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Support</h4>
      <ul class="footer-links">
        <li><a href="#contact">Contact Us</a></li>
        <li><a href="#help">Help Center</a></li>
        <li><a href="#feedback">Send Feedback</a></li>
        <li><a href="#report">Report Issue</a></li>
      </ul>
    </div>
  </div>

  <div class="footer-bottom">
    <p>Â© 2025 Resume Builder Pro. All Rights Reserved.</p>
  </div>
</footer>

<script>
  /* ---------- REQUEST TRACKING ---------- */
  // Track all active resume generation requests
  const activeRequests = new Map(); // key: requestId, value: {company, status, element}
  let requestIdCounter = 0;

  function generateRequestId() {
    return `req_${Date.now()}_${++requestIdCounter}`;
  }

  function updateBannerCount() {
    const banner = document.getElementById('processingBanner');
    const bannerCount = document.getElementById('bannerCount');
    const activeCount = Array.from(activeRequests.values()).filter(r => r.status === 'processing').length;
    
    console.log('[DEBUG] Updating banner count. Active:', activeCount, 'Total:', activeRequests.size);
    
    if (activeCount > 0) {
      banner.classList.add('active');
      bannerCount.textContent = activeCount === 1 
        ? 'Processing 1 resume...' 
        : `Processing ${activeCount} resumes...`;
    } else {
      // Keep banner open for 3 seconds to show completed items
      setTimeout(() => {
        const stillActive = Array.from(activeRequests.values()).filter(r => r.status === 'processing').length;
        if (stillActive === 0) {
          banner.classList.remove('active');
        }
      }, 3000);
    }
  }

  function addRequestToUI(requestId, companyName) {
    console.log('[DEBUG] Adding request to UI:', requestId, companyName);
    
    const requestsList = document.getElementById('requestsList');
    if (!requestsList) {
      console.error('[DEBUG] requestsList element not found!');
      return;
    }
    
    const requestItem = document.createElement('div');
    requestItem.className = 'request-item';
    requestItem.id = `request_${requestId}`;
    requestItem.innerHTML = `
      <div class="item-icon">
        <div class="spinner-small"></div>
      </div>
      <div class="item-text">
        <div class="item-company">${companyName || 'Unknown Company'}</div>
        <div class="item-progress" style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">Starting...</div>
      </div>
    `;
    requestsList.appendChild(requestItem);
    
    console.log('[DEBUG] Request item added to DOM, total items:', requestsList.children.length);
    
    activeRequests.set(requestId, {
      company: companyName,
      status: 'processing',
      element: requestItem
    });
    
    console.log('[DEBUG] Active requests count:', activeRequests.size);
    
    updateBannerCount();
  }

  function updateRequestProgress(requestId, progress, message) {
    const request = activeRequests.get(requestId);
    if (request && request.status === 'processing') {
      const progressDiv = request.element.querySelector('.item-progress');
      if (progressDiv) {
        progressDiv.textContent = `${progress}% - ${message || 'Processing...'}`;
        console.log('[BANNER UPDATE] Updated progress for', requestId, ':', progress, '%', message);
      }
    }
  }

  function markRequestComplete(requestId, fileName) {
    const request = activeRequests.get(requestId);
    if (request) {
      request.status = 'completed';
      request.element.classList.add('completed');
      request.element.innerHTML = `
        <div class="item-icon">âœ“</div>
        <div class="item-text">
          <div class="item-company">${request.company}</div>
          <div class="item-progress" style="color: var(--success);">Completed - ${fileName}</div>
        </div>
      `;
      
      updateBannerCount();
      
      // Remove completed item after 5 seconds
      setTimeout(() => {
        request.element.style.opacity = '0';
        setTimeout(() => {
          request.element.remove();
          activeRequests.delete(requestId);
          updateBannerCount();
        }, 300);
      }, 5000);
    }
  }

  function markRequestFailed(requestId, error) {
    const request = activeRequests.get(requestId);
    if (request) {
      request.status = 'failed';
      request.element.classList.add('failed');
      request.element.innerHTML = `
        <div class="item-icon" style="color: var(--danger);">âœ—</div>
        <div class="item-text">
          <div class="item-company" style="color: var(--danger);">${request.company}</div>
          <div class="item-progress" style="color: var(--danger);">Failed</div>
        </div>
      `;
      
      updateBannerCount();
      
      // Remove failed item after 8 seconds
      setTimeout(() => {
        request.element.style.opacity = '0';
        setTimeout(() => {
          request.element.remove();
          activeRequests.delete(requestId);
          updateBannerCount();
        }, 300);
      }, 8000);
    }
  }

  function closeProcessingBanner() {
    const banner = document.getElementById('processingBanner');
    banner.classList.remove('active');
  }

  // Alias for backwards compatibility
  function addRequestToBanner(requestId, companyName) {
    return addRequestToUI(requestId, companyName);
  }

  /* ---------- FORM SECTION NAVIGATION ---------- */
  function showFormSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.form-section-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    
    // Remove active from all nav buttons
    document.querySelectorAll('.form-nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(`section-${sectionId}`);
    if (section) {
      section.classList.add('active');
    }
    
    // Mark button as active
    event.target.closest('.form-nav-btn').classList.add('active');
  }

  /* ---------- SCROLL TO TOP ---------- */
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Show/hide scroll button based on scroll position
  window.addEventListener('scroll', () => {
    const scrollBtn = document.getElementById('scrollToTop');
    if (window.pageYOffset > 300) {
      scrollBtn.classList.add('visible');
    } else {
      scrollBtn.classList.remove('visible');
    }
  });

  /* ---------- THEME ---------- */
  const themeBtn = document.getElementById('toggleTheme');
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
  themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ Day' : 'ğŸŒ™ Night';
  themeBtn.addEventListener('click', ()=>{
    const dark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', dark ? 'light' : 'dark');
    localStorage.setItem('theme', dark ? 'light' : 'dark');
    themeBtn.textContent = dark ? 'ğŸŒ™ Night' : 'â˜€ï¸ Day';
  });

  /* ---------- FORM BUILDERS ---------- */
  function addContact(k='',v=''){
    const d=document.createElement('div');
    d.className='entry';
    // Determine placeholder based on key
    let valuePlaceholder = 'Value';
    if (k === 'Phone') valuePlaceholder = '+1 999 999 9999';
    else if (k === 'Email') valuePlaceholder = 'abc@mail.com';
    else if (k === 'LinkedIn') valuePlaceholder = 'https://linkedin.com/in/yourprofile';
    else if (k === 'Portfolio') valuePlaceholder = 'https://yourportfolio.com';
    else if (v) valuePlaceholder = 'URL or value';

    d.innerHTML=`<input placeholder="Label (Phone, Email, LinkedIn, Portfolio)" class="contact-key" value="${k}" ${k ? 'readonly' : ''}>
    <input placeholder="${valuePlaceholder}" class="contact-value" value="${v}">`;
    document.getElementById('contactList').appendChild(d);
  }
  function addSkill(k='',v=''){const d=document.createElement('div');
    d.className='entry';d.innerHTML=`<input placeholder="Category" class="skill-key" value="${k}">
    <input placeholder="Values (comma-separated)" class="skill-value" value="${v}">`;
    document.getElementById('skillsList').appendChild(d);}
  function addExperience(exp=null){const d=document.createElement('div');
  d.className='entry';d.innerHTML=`<input placeholder="Company" class="exp-company" value="${exp?.company||''}">
  <input placeholder="Role" class="exp-role" value="${exp?.role||''}">
  <input placeholder="Period" class="exp-period" value="${exp?.period||''}">
  <div class="bullets"></div><button type="button" class="sub-btn" onclick="addBullet(this)">+ Add Bullet</button>`;
  document.getElementById('experienceList').appendChild(d);
  const bulletsDiv = d.querySelector('.bullets');
  let pts = Array.isArray(exp?.points) ? exp.points : [''];
  // If no points, add one empty bullet
  if (!pts.length) pts = [''];
  // Pass the bulletsDiv directly to addBullet for correct population
  pts.forEach(p => addBullet(bulletsDiv, p));
  }
  function addBullet(btn,text=''){const b=document.createElement('div');b.className='bullet';
    b.innerHTML=`<input placeholder="Achievement..." class="exp-point" value="${text||''}">
    <button class="remove-btn" onclick="this.parentElement.remove()">ğŸ—‘</button>`;
    // If btn is a .bullets container, append directly; else fallback to previous logic
    if (btn && btn.classList && btn.classList.contains('bullets')) {
      btn.appendChild(b);
    } else if (btn && btn.parentElement && btn.parentElement.querySelector('.bullets')) {
      btn.parentElement.querySelector('.bullets').appendChild(b);
    }
}
  function addEducation(e=null){const d=document.createElement('div');
    d.className='entry';d.innerHTML=`<input placeholder="Degree" class="edu-degree" value="${e?.degree||''}">
    <input placeholder="Institution" class="edu-inst" value="${e?.institution||''}">
    <input placeholder="Year" class="edu-year" value="${e?.year||''}">`;
    document.getElementById('educationList').appendChild(d);}

  function addProject(proj=null){
    const d=document.createElement('div');
    d.className='entry';
    d.innerHTML=`<input placeholder="Project Title" class="proj-title" value="${proj?.title||''}">
    <div class="bullets"></div>
    <button type="button" class="sub-btn" onclick="addProjectBullet(this)">+ Add Bullet</button>`;
    document.getElementById('projectsList').appendChild(d);
    const bulletsDiv = d.querySelector('.bullets');
    let pts = Array.isArray(proj?.bullets) ? proj.bullets : [''];
    if (!pts.length) pts = [''];
    pts.forEach(p => addProjectBullet(bulletsDiv, p));
  }

  function addProjectBullet(btn, text=''){
    const b=document.createElement('div');
    b.className='bullet';
    b.innerHTML=`<input placeholder="Project detail..." class="proj-point" value="${text||''}">
    <button class="remove-btn" onclick="this.parentElement.remove()">ğŸ—‘</button>`;
    if (btn && btn.classList && btn.classList.contains('bullets')) {
      btn.appendChild(b);
    } else if (btn && btn.parentElement && btn.parentElement.querySelector('.bullets')) {
      btn.parentElement.querySelector('.bullets').appendChild(b);
    }
  }

  function addCertification(cert=null){
    const d=document.createElement('div');
    d.className='entry';
    d.innerHTML=`<input placeholder="Certification Name" class="cert-name" value="${cert?.name||''}">
    <input placeholder="Issuing Organization" class="cert-org" value="${cert?.organization||''}">
    <input placeholder="Year" class="cert-year" value="${cert?.year||''}">`;
    document.getElementById('certificationsList').appendChild(d);
  }

  /* ---------- JSON HANDLERS ---------- */
  function buildJSON(){
    const f=document.getElementById('resumeForm');
    const resume_data = {name:f.name.value,contact:{},summary:f.summary.value,
      technical_skills:{},experience:[],education:[],projects:[],certifications:[]};
    document.querySelectorAll('#contactList .entry').forEach(x=>{
      const k=x.querySelector('.contact-key').value.trim(),v=x.querySelector('.contact-value').value.trim();if(k&&v)resume_data.contact[k.toLowerCase()]=v;});
    document.querySelectorAll('#skillsList .entry').forEach(x=>{
      const k=x.querySelector('.skill-key').value,v=x.querySelector('.skill-value').value;if(k&&v)resume_data.technical_skills[k]=v;});
    document.querySelectorAll('#experienceList .entry').forEach(x=>{
      resume_data.experience.push({company:x.querySelector('.exp-company').value,
        role:x.querySelector('.exp-role').value,period:x.querySelector('.exp-period').value,
        points:Array.from(x.querySelectorAll('.exp-point')).map(i=>i.value.trim()).filter(Boolean)});});
    document.querySelectorAll('#educationList .entry').forEach(x=>{
      resume_data.education.push({degree:x.querySelector('.edu-degree').value,
        institution:x.querySelector('.edu-inst').value,year:x.querySelector('.edu-year').value});});
    document.querySelectorAll('#projectsList .entry').forEach(x=>{
      resume_data.projects.push({title:x.querySelector('.proj-title').value,
        bullets:Array.from(x.querySelectorAll('.proj-point')).map(i=>i.value.trim()).filter(Boolean)});});
    document.querySelectorAll('#certificationsList .entry').forEach(x=>{
      resume_data.certifications.push({name:x.querySelector('.cert-name').value,
        organization:x.querySelector('.cert-org').value,year:x.querySelector('.cert-year').value});});
    const companyNameJD = document.getElementById('companyNameJD') ? document.getElementById('companyNameJD').value : '';
    const jobTitleJD = document.getElementById('jobTitleJD') ? document.getElementById('jobTitleJD').value : '';
    const jobDescriptionElem = document.getElementById('jobDescriptionTab');
    const job_description_data = {
      job_description: jobDescriptionElem ? jobDescriptionElem.value : '',
      company_name: companyNameJD,
      job_title: jobTitleJD
    };
    return {resume_data, job_description_data};
  }

  // Helper function to get just the resume data
  function getResumeData() {
    const { resume_data } = buildJSON();
    return resume_data;
  }

  /* ---------- SAVE/LOAD RESUME TEMPLATE ---------- */
  async function saveResumeTemplate() {
    try {
      const resumeData = getResumeData();
      
      // Basic validation
      if (!resumeData.name || resumeData.name.trim() === '') {
        alert('âš ï¸ Please enter your name before saving the template.');
        return;
      }

      const response = await fetch('/api/user/resume-template', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        },
        body: JSON.stringify({ resume_data: resumeData })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Failed to save' }));
        throw new Error(error.detail || 'Failed to save resume template');
      }

      const result = await response.json();
      alert('âœ… Resume template saved successfully!\n\nIt will auto-load the next time you log in.');
      console.log('Template saved:', result);
      
    } catch (error) {
      console.error('Save failed:', error);
      alert(`âŒ Error saving template: ${error.message}`);
    }
  }

  async function loadResumeTemplate() {
    try {
      console.log('Loading resume template...');
      
      const response = await fetch('/api/user/resume-template', {
        method: 'GET',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });

      if (!response.ok) {
        console.log('No template found or error loading');
        return;
      }

      const result = await response.json();
      
      if (result.has_template && result.resume_data) {
        console.log('Template loaded, populating form...');
        populateForm(result.resume_data);
        showResult('âœ… Resume template loaded!');
        console.log('Template last updated:', result.updated_at);
      } else {
        console.log('No template saved yet');
      }
      
    } catch (error) {
      console.error('Load template failed:', error);
      // Silently fail - don't show error on login if template doesn't exist
    }
  }

  // Trigger JSON upload (legacy)
  function triggerUpload(){document.getElementById('uploadJSON').click();}
  document.getElementById('uploadJSON').addEventListener('change', e=>{
    const file=e.target.files[0];if(!file)return;
    const r=new FileReader();r.onload=ev=>{try{
      const d=JSON.parse(ev.target.result);
      // Only populate resume data, not job description data
      if(d.resume_data) {
        populateForm(d.resume_data);
      } else {
        populateForm(d);
      }
      // Do NOT populate job description fields from upload
      showResult('âœ… Resume JSON Uploaded');
    }catch{alert("Invalid JSON");}};r.readAsText(file);});

  // Trigger resume document upload (PDF/DOCX)
  function triggerResumeUpload() {
    document.getElementById('uploadResume').click();
  }

  // Handle resume document upload with loading screen
  document.getElementById('uploadResume').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['.pdf', '.docx'];
    const fileName = file.name.toLowerCase();
    const isValid = validTypes.some(type => fileName.endsWith(type));
    
    if (!isValid) {
      alert('Please upload a PDF or DOCX file');
      e.target.value = ''; // Clear the input
      return;
    }

    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
      alert('File too large. Maximum size is 10MB');
      e.target.value = '';
      return;
    }

    try {
      // Show loading overlay
      showParseLoading();

      // Create form data
      const formData = new FormData();
      formData.append('file', file);

      // Simulate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
          updateParseProgress(progress, 'Extracting text from document...');
        }
      }, 200);

      // Upload and parse
      const response = await fetch('/api/parse-resume', {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        },
        body: formData
      });

      clearInterval(progressInterval);

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ detail: 'Failed to parse resume' }));
        throw new Error(errorData.detail || `Server error: ${response.status}`);
      }

      const data = await response.json();
      updateParseProgress(100, 'Parsing complete!');

      if (data.success && data.resume_data) {
        // Populate form with parsed data
        setTimeout(() => {
          populateForm(data.resume_data);
          hideParseLoading();
          showResult('âœ… Resume uploaded and parsed successfully!');
          e.target.value = ''; // Clear the input
        }, 500);
      } else {
        throw new Error(data.message || 'Failed to parse resume');
      }

    } catch (error) {
      hideParseLoading();
      console.error('Resume upload error:', error);
      alert(`Failed to parse resume: ${error.message || 'Unknown error'}`);
      e.target.value = '';
    }
  });

  // Loading overlay functions
  function showParseLoading() {
    const overlay = document.getElementById('parseLoadingOverlay');
    overlay.style.display = 'flex';
    updateParseProgress(0, 'Uploading document...');
  }

  function hideParseLoading() {
    const overlay = document.getElementById('parseLoadingOverlay');
    overlay.style.display = 'none';
  }

  function updateParseProgress(percent, message) {
    const fill = document.getElementById('parseProgressFill');
    const text = document.getElementById('parseProgressText');
    const messageEl = document.querySelector('.parse-loading-message');
    
    fill.style.width = `${percent}%`;
    text.textContent = `${Math.round(percent)}%`;
    if (message) {
      messageEl.textContent = message;
    }
  }

  // Update mode description based on selected mode
  function updateModeDescription() {
    const modeDescription = document.getElementById('modeDescription');
    const selectedMode = document.querySelector('input[name="resumeMode"]:checked').value;
    
    if (selectedMode === 'complete_jd') {
      modeDescription.innerHTML = 'ğŸ“ <strong>Complete JD:</strong> Creates a complete resume from scratch using only the job description';
    } else {
      modeDescription.innerHTML = 'âœï¸ <strong>Resume + JD:</strong> Takes your existing resume data and tailors it to match the job description';
    }
  }

  // Global variables for edit mode
  let currentResumeData = null;
  let currentRequestId = null;
  let isEditMode = false;

  // View modal functions
  async function viewResumeContent(requestId, company, title) {
    try {
      currentRequestId = requestId;
      isEditMode = false;
      
      const modal = document.getElementById('viewModal');
      const modalTitle = document.getElementById('viewModalTitle');
      const modalSubtitle = document.getElementById('viewModalSubtitle');
      const modalBody = document.getElementById('viewModalBody');
      const downloadResumeBtn = document.getElementById('viewModalDownloadResume');
      const downloadJDBtn = document.getElementById('viewModalDownloadJD');
      const editBtn = document.getElementById('viewModalEditBtn');
      const saveBtn = document.getElementById('viewModalSaveBtn');
      
      // Show modal with loading state
      modalTitle.textContent = 'Resume Preview';
      modalSubtitle.textContent = `${company} - ${title}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="parse-loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading resume...</p></div>';
      modal.style.display = 'flex';
      
      // Set up buttons
      downloadResumeBtn.onclick = () => downloadResumeDocx(requestId, company, title);
      downloadResumeBtn.style.display = 'inline-block';
      downloadJDBtn.style.display = 'inline-block';
      downloadJDBtn.onclick = () => downloadJobDescription(requestId, company, title);
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      document.getElementById('editBtnText').textContent = 'Edit';
      
      // Fetch resume data
      const response = await fetch(`/api/jobs/${requestId}/result`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load resume');
      
      const result = await response.json();
      const data = result.final_resume || result; // Handle both nested and direct format
      currentResumeData = data; // Store for editing
      
      // Render the resume
      renderResumeContent(data);
      
    } catch (error) {
      console.error('Error viewing resume:', error);
      document.getElementById('viewModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--danger);">
          <p>âŒ Failed to load resume content</p>
          <p style="font-size: 14px; color: var(--text-secondary);">${error.message}</p>
        </div>
      `;
    }
  }

  function renderResumeContent(data) {
    const modalBody = document.getElementById('viewModalBody');
    let html = '<div id="resumeContentWrapper" style="max-width: 800px; margin: 0 auto; padding: 20px; font-size: 14px; line-height: 1.6; color: var(--text-primary);">';
    
    if (data.name) {
      html += `<h2 contenteditable="${isEditMode}" data-field="name" style="margin-top: 0; color: var(--accent); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '4px' : '0'};">${data.name}</h2>`;
    }
    
    if (data.contact) {
      html += '<div style="margin-bottom: 20px; color: var(--text-secondary);">';
      if (data.contact.email) html += `<span contenteditable="${isEditMode}" data-field="contact.email" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${data.contact.email}</span> `;
      if (data.contact.phone) html += `<span contenteditable="${isEditMode}" data-field="contact.phone" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${data.contact.phone}</span> `;
      if (data.contact.linkedin) html += `<span contenteditable="${isEditMode}" data-field="contact.linkedin" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">ğŸ”— ${data.contact.linkedin}</span>`;
      html += '</div>';
    }
    
    if (data.summary) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Professional Summary</h3>`;
      html += `<p contenteditable="${isEditMode}" data-field="summary" style="color: var(--text-primary); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '4px' : '0'};">${data.summary}</p>`;
    }
    
    if (data.technical_skills) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Technical Skills ${isEditMode ? '<button onclick="addSkillCategory()" style="margin-left: 10px; padding: 4px 8px; font-size: 12px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">â• Add Category</button>' : ''}</h3>`;
      html += '<div id="technicalSkillsContainer">';
      let skillIndex = 0;
      for (const [category, skills] of Object.entries(data.technical_skills)) {
        if (Array.isArray(skills) && skills.length > 0) {
          html += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;" data-skill-category="${category}" data-skill-index="${skillIndex}">`;
          html += `<p style="flex: 1; color: var(--text-primary); margin: 0;">`;
          html += `<strong contenteditable="${isEditMode}" data-field="technical_skills_key.${skillIndex}" data-original-key="${category}" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${category}</strong>: `;
          html += `<span contenteditable="${isEditMode}" data-field="technical_skills.${category}" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${skills.join(', ')}</span>`;
          html += `</p>`;
          if (isEditMode) {
            html += `<button onclick="removeSkillCategory('${category}')" style="padding: 4px 8px; font-size: 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸</button>`;
          }
          html += `</div>`;
          skillIndex++;
        }
      }
      html += '</div>';
    }
    
    if (data.experience && data.experience.length > 0) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Experience</h3>`;
      data.experience.forEach((exp, idx) => {
        html += `<div style="margin-bottom: 15px;" data-exp-index="${idx}">`;
        const jobTitle = exp.job_title || exp.title || exp.role || 'Position';
        const company = exp.company || exp.organization || 'Company';
        const duration = exp.duration || exp.dates || exp.period || '';
        
        html += `<h4 contenteditable="${isEditMode}" data-field="experience.${idx}.title" style="margin: 5px 0; color: var(--text-primary); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${jobTitle}</h4>`;
        html += `<p style="color: var(--text-secondary); margin: 3px 0;"><span contenteditable="${isEditMode}" data-field="experience.${idx}.company" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${company}</span>${duration ? ' | ' : ''}<span contenteditable="${isEditMode}" data-field="experience.${idx}.duration" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${duration}</span></p>`;
        
        const bullets = exp.bullets || exp.points || exp.responsibilities || [];
        if (bullets && bullets.length > 0) {
          html += '<ul style="margin: 8px 0 8px 20px; color: var(--text-primary); padding-left: 0;">';
          bullets.forEach((bullet, bidx) => {
            html += `<li contenteditable="${isEditMode}" data-field="experience.${idx}.bullets.${bidx}" style="margin-bottom: 4px; outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${bullet}</li>`;
          });
          html += '</ul>';
        }
        html += `</div>`;
      });
    }
    
    if (data.education && data.education.length > 0) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Education</h3>`;
      data.education.forEach((edu, idx) => {
        html += `<p contenteditable="${isEditMode}" data-field="education.${idx}" style="color: var(--text-primary); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};"><strong>${edu.degree}</strong> - ${edu.institution} (${edu.year || edu.graduation_date})</p>`;
      });
    }
    
    if (data.certifications && data.certifications.length > 0) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Certifications</h3>`;
      html += '<ul style="color: var(--text-primary);">';
      data.certifications.forEach((cert, idx) => {
        html += `<li contenteditable="${isEditMode}" data-field="certifications.${idx}" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${typeof cert === 'string' ? cert : cert.name}</li>`;
      });
      html += '</ul>';
    }
    
    if (data.projects && data.projects.length > 0) {
      html += `<h3 style="color: var(--primary); margin-top: 20px;">Projects</h3>`;
      data.projects.forEach((proj, idx) => {
        html += `<div style="margin-bottom: 15px;">`;
        html += `<h4 contenteditable="${isEditMode}" data-field="projects.${idx}.name" style="margin: 5px 0; color: var(--text-primary); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${proj.name}</h4>`;
        if (proj.description) html += `<p contenteditable="${isEditMode}" data-field="projects.${idx}.description" style="color: var(--text-primary); outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${proj.description}</p>`;
        if (proj.technologies) html += `<p style="color: var(--text-secondary);"><em>Technologies: <span contenteditable="${isEditMode}" data-field="projects.${idx}.technologies" style="outline: ${isEditMode ? '1px dashed var(--border)' : 'none'}; padding: ${isEditMode ? '2px' : '0'};">${Array.isArray(proj.technologies) ? proj.technologies.join(', ') : proj.technologies}</span></em></p>`;
        html += `</div>`;
      });
    }
    
    html += '</div>';
    modalBody.innerHTML = html;
  }

  function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('viewModalEditBtn');
    const saveBtn = document.getElementById('viewModalSaveBtn');
    const editBtnText = document.getElementById('editBtnText');
    
    if (isEditMode) {
      editBtnText.textContent = 'Cancel';
      saveBtn.style.display = 'inline-block';
      renderResumeContent(currentResumeData);
    } else {
      editBtnText.textContent = 'Edit';
      saveBtn.style.display = 'none';
      renderResumeContent(currentResumeData);
    }
  }

  async function saveResumeChanges() {
    try {
      // First, rebuild technical_skills from scratch to handle key renames
      const newTechnicalSkills = {};
      const skillContainers = document.querySelectorAll('[data-skill-category]');
      
      skillContainers.forEach(container => {
        const keyElem = container.querySelector('[data-field^="technical_skills_key"]');
        const valueElem = container.querySelector('[data-field^="technical_skills."]');
        
        if (keyElem && valueElem) {
          const newKey = keyElem.textContent.trim();
          const valuesText = valueElem.textContent.trim();
          
          if (newKey && valuesText) {
            const values = valuesText.split(',').map(s => s.trim()).filter(s => s);
            if (values.length > 0) {
              newTechnicalSkills[newKey] = values;
            }
          }
        }
      });
      
      // Update technical_skills in currentResumeData
      if (Object.keys(newTechnicalSkills).length > 0) {
        currentResumeData.technical_skills = newTechnicalSkills;
      }
      
      // Collect all other edited content
      const editableElements = document.querySelectorAll('[contenteditable="true"]');
      
      editableElements.forEach(elem => {
        const field = elem.getAttribute('data-field');
        const value = elem.textContent.trim();
        
        // Skip technical_skills fields as we've already handled them above
        if (!field || field.includes('technical_skills')) return;
        
        // Parse nested field paths like "experience.0.title" or "experience.0.bullets.1"
        const parts = field.split('.');
        let current = currentResumeData;
        
        for (let i = 0; i < parts.length - 1; i++) {
          const part = parts[i];
          const nextPart = parts[i + 1];
          
          // Check if next part is an array index
          if (!isNaN(nextPart)) {
            // Ensure current[part] is an array
            if (!Array.isArray(current[part])) {
              current[part] = [];
            }
            const index = parseInt(nextPart);
            // Ensure the array element exists
            if (!current[part][index]) {
              current[part][index] = {};
            }
            current = current[part][index];
            i++; // Skip the index in next iteration
          } else {
            // Regular object property
            if (!current[part]) {
              current[part] = {};
            }
            current = current[part];
          }
        }
        
        const lastPart = parts[parts.length - 1];
        
        // Handle special cases
        if (field.includes('bullets') && !isNaN(lastPart)) {
          // Updating a specific bullet point in an array
          const bulletIndex = parseInt(lastPart);
          // The current object should have a 'bullets' array
          const parentKey = parts[parts.length - 2]; // Should be 'bullets'
          // Go back one level to set the array element
          const parentParts = parts.slice(0, -2);
          let parent = currentResumeData;
          
          for (let i = 0; i < parentParts.length; i++) {
            const part = parentParts[i];
            const nextPart = parentParts[i + 1];
            
            if (!isNaN(nextPart)) {
              parent = parent[part][parseInt(nextPart)];
              i++;
            } else {
              parent = parent[part];
            }
          }
          
          // Ensure bullets array exists
          if (!Array.isArray(parent.bullets)) {
            parent.bullets = [];
          }
          parent.bullets[bulletIndex] = value;
        } else {
          // Regular field update
          current[lastPart] = value;
        }
      });
      
      // Send update to server
      const resultDiv = document.getElementById('result');
      if (resultDiv) {
        resultDiv.textContent = 'ğŸ’¾ Saving changes...';
        resultDiv.style.display = 'block';
      }
      
      const response = await fetch(`/api/jobs/${currentRequestId}/update`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ final_resume: currentResumeData })
      });
      
      if (!response.ok) {
        throw new Error('Failed to save changes');
      }
      
      if (resultDiv) {
        resultDiv.textContent = 'âœ… Changes saved successfully!';
        setTimeout(() => {
          resultDiv.style.display = 'none';
        }, 3000);
      }
      
      isEditMode = false;
      const editBtnText = document.getElementById('editBtnText');
      if (editBtnText) {
        editBtnText.textContent = 'Edit';
      }
      const saveBtn = document.getElementById('viewModalSaveBtn');
      if (saveBtn) {
        saveBtn.style.display = 'none';
      }
      renderResumeContent(currentResumeData);
      
    } catch (error) {
      console.error('Error saving changes:', error);
      alert(`Failed to save changes: ${error.message}`);
    }
  }

  async function viewJobDescription(requestId, company, title) {
    try {
      const modal = document.getElementById('viewModal');
      const modalTitle = document.getElementById('viewModalTitle');
      const modalSubtitle = document.getElementById('viewModalSubtitle');
      const modalBody = document.getElementById('viewModalBody');
      const downloadResumeBtn = document.getElementById('viewModalDownloadResume');
      const downloadJDBtn = document.getElementById('viewModalDownloadJD');
      
      // Show modal with loading state
      modalTitle.textContent = 'Job Description';
      modalSubtitle.textContent = `${company} - ${title}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="parse-loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading job description...</p></div>';
      modal.style.display = 'flex';
      
      // Set up download buttons
      downloadResumeBtn.onclick = () => downloadResumeDocx(requestId, company, title);
      downloadResumeBtn.style.display = 'inline-block';
      downloadJDBtn.style.display = 'inline-block';
      downloadJDBtn.onclick = () => downloadJobDescription(requestId, company, title);
      
      // Fetch JD data
      const response = await fetch(`/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load job description');
      
      const text = await response.text();
      
      // Format JD text for display (preserve line breaks)
      const formattedText = text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => `<p style="color: var(--text-primary);">${line}</p>`)
        .join('');
      
      modalBody.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-size: 14px; line-height: 1.8; color: var(--text-primary);">
          ${formattedText}
        </div>
      `;
      
    } catch (error) {
      console.error('Error viewing job description:', error);
      document.getElementById('viewModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--danger);">
          <p>âŒ Failed to load job description</p>
          <p style="font-size: 14px; color: var(--text-secondary);">${error.message}</p>
        </div>
      `;
    }
  }

  function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
  }

  // Close modal when clicking outside
  document.getElementById('viewModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'viewModal') {
      closeViewModal();
    }
  });

  // Add new skill category
  function addSkillCategory() {
    const categoryName = prompt('Enter new skill category name (e.g., "Frameworks", "Cloud Platforms"):');
    
    if (!categoryName || categoryName.trim() === '') {
      return; // User cancelled or entered empty name
    }
    
    const trimmedCategory = categoryName.trim();
    
    // Check if category already exists
    if (currentResumeData.technical_skills && currentResumeData.technical_skills[trimmedCategory]) {
      alert('âš ï¸ This category already exists!');
      return;
    }
    
    // Get skills for this category
    const skillsInput = prompt(`Enter skills for "${trimmedCategory}" (comma-separated):`);
    
    if (!skillsInput || skillsInput.trim() === '') {
      return; // User cancelled or entered empty skills
    }
    
    const skills = skillsInput.split(',').map(s => s.trim()).filter(s => s);
    
    if (skills.length === 0) {
      alert('âš ï¸ Please enter at least one skill!');
      return;
    }
    
    // Add to data
    if (!currentResumeData.technical_skills) {
      currentResumeData.technical_skills = {};
    }
    currentResumeData.technical_skills[trimmedCategory] = skills;
    
    // Re-render to show the new category
    renderResumeContent(currentResumeData);
  }

  // Remove skill category
  function removeSkillCategory(category) {
    if (!confirm(`Are you sure you want to remove "${category}"?`)) {
      return;
    }
    
    // Remove from data
    if (currentResumeData.technical_skills && currentResumeData.technical_skills[category]) {
      delete currentResumeData.technical_skills[category];
    }
    
    // Re-render to reflect changes
    renderResumeContent(currentResumeData);
  }

  // Help modal functions
  function showHelpModal() {
    document.getElementById('helpModal').style.display = 'flex';
  }

  function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
  }

  // Close help modal when clicking outside
  document.getElementById('helpModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'helpModal') {
      closeHelpModal();
    }
  });

  function populateForm(d){
    const f = document.getElementById('resumeForm');
    f.name.value = d.name || '';
    f.summary.value = d.summary || '';
    
    // Handle contact - both old format (string) and new format (object)
    document.getElementById('contactList').innerHTML = '';
    const contact = d.contact || {};
    if (typeof contact === 'string') {
      // Old format: single string - convert to phone field
      addContact('Phone', contact);
    } else if (typeof contact === 'object') {
      // New format: structured object
      Object.entries(contact).forEach(([k, v]) => addContact(k, v));
    }
    if (document.querySelectorAll('#contactList .entry').length === 0) {
      addContact(); // Add empty field if no contact data
    }
    
    document.getElementById('skillsList').innerHTML = '';
    const skills = d.technical_skills || d.skills || {};
    if (Object.keys(skills).length) {
      Object.entries(skills).forEach(([k, v]) => addSkill(k, v));
    } else {
      addSkill();
    }
    document.getElementById('experienceList').innerHTML = '';
    if (d.experience && d.experience.length) {
      d.experience.forEach(e => addExperience(e));
    } else {
      addExperience();
    }
    document.getElementById('educationList').innerHTML = '';
    if (d.education && d.education.length) {
      d.education.forEach(e => addEducation(e));
    } else {
      addEducation();
    }
    document.getElementById('projectsList').innerHTML = '';
    if (d.projects && d.projects.length) {
      d.projects.forEach(p => addProject(p));
    } else {
      addProject();
    }
    document.getElementById('certificationsList').innerHTML = '';
    if (d.certifications && d.certifications.length) {
      d.certifications.forEach(c => addCertification(c));
    } else {
      addCertification();
    }
  }

  function downloadJSON(){
    // Only download resume data (not job description)
    const { resume_data } = buildJSON();
    const blob=new Blob([JSON.stringify(resume_data,null,2)],{type:"application/json"});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download="resume_data.json";a.click();URL.revokeObjectURL(a.href);showResult('ğŸ’¾ Resume JSON Downloaded');}

  async function downloadWordDoc() {
    try {
      console.log('Generating Word document from current resume data...');
      
      const { resume_data } = buildJSON();
      
      // Validate resume data
      if (!resume_data.name || resume_data.name.trim() === '') {
        alert('âš ï¸ Please enter your name before generating a Word document.');
        return;
      }
      
      // Show loading message
      showResult('â³ Generating Word document...');
      
      const response = await fetch('/create_resume', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ resume_data })
      });
      
      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Failed to generate document' }));
        throw new Error(error.detail || 'Failed to generate Word document');
      }
      
      // Get the blob from response
      const blob = await response.blob();
      
      // Create download link
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${resume_data.name.replace(/\s+/g, '_')}_Resume.docx`;
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showResult('âœ… Word document downloaded!');
      console.log('Word document generated successfully');
      
    } catch (error) {
      console.error('Word generation failed:', error);
      showResult(`âŒ Error: ${error.message}`);
    }
  }

  function toggleDownloadMenu() {
    const menu = document.getElementById('downloadOptions');
    menu.classList.toggle('show');
  }

  function toggleDownloadMenuTop() {
    const menu = document.getElementById('downloadOptionsTop');
    menu.classList.toggle('show');
  }

  // Close download menu when clicking outside
  document.addEventListener('click', function(event) {
    const downloadGroup = document.querySelector('.download-group');
    const menu = document.getElementById('downloadOptions');
    
    if (menu && downloadGroup && !downloadGroup.contains(event.target)) {
      menu.classList.remove('show');
    }

    // Close top download menu when clicking outside
    const downloadGroupTop = document.querySelector('.download-group-top');
    const menuTop = document.getElementById('downloadOptionsTop');
    
    if (menuTop && downloadGroupTop && !downloadGroupTop.contains(event.target)) {
      menuTop.classList.remove('show');
    }
  });

  function validateResumeInput(resumeData, jobData, mode) {
    const errors = [];
    
    // Validate Job Description (required for both modes)
    if (!jobData.job_description || jobData.job_description.trim().length < 50) {
      errors.push('â€¢ Job Description must be at least 50 characters long');
    }
    
    if (!jobData.company_name || jobData.company_name.trim().length === 0) {
      errors.push('â€¢ Company Name is required');
    }
    
    if (!jobData.job_title || jobData.job_title.trim().length === 0) {
      errors.push('â€¢ Job Title is required');
    }
    
    // Validate Resume Data (only for resume+jd mode)
    if (mode === 'resume_jd') {
      if (!resumeData.name || resumeData.name.trim().length === 0) {
        errors.push('â€¢ Name is required in Resume+JD mode');
      }
      
      if (!resumeData.summary || resumeData.summary.trim().length < 50) {
        errors.push('â€¢ Professional Summary must be at least 50 characters long');
      }
      
      // Check contact info
      const contact = resumeData.contact || {};
      if (!contact.email && !contact.phone) {
        errors.push('â€¢ At least one contact method (Email or Phone) is required');
      }
      
      // Validate email format if provided
      if (contact.email && !isValidEmail(contact.email)) {
        errors.push('â€¢ Email format is invalid');
      }
      
      // Check technical skills
      const skills = resumeData.technical_skills || {};
      if (Object.keys(skills).length === 0) {
        errors.push('â€¢ At least one Technical Skill category is required');
      } else {
        // Check if any skill category has values
        let hasSkills = false;
        for (const category in skills) {
          if (Array.isArray(skills[category]) && skills[category].length > 0) {
            hasSkills = true;
            break;
          }
        }
        if (!hasSkills) {
          errors.push('â€¢ Technical Skills must have at least one skill listed');
        }
      }
      
      // Check experience
      if (!resumeData.experience || resumeData.experience.length === 0) {
        errors.push('â€¢ At least one Experience entry is required');
      } else {
        resumeData.experience.forEach((exp, idx) => {
          if (!exp.company || exp.company.trim().length === 0) {
            errors.push(`â€¢ Experience ${idx + 1}: Company name is required`);
          }
          if (!exp.role && !exp.title && !exp.job_title) {
            errors.push(`â€¢ Experience ${idx + 1}: Job title/role is required`);
          }
          const bullets = exp.bullets || exp.points || exp.responsibilities || [];
          if (bullets.length === 0) {
            errors.push(`â€¢ Experience ${idx + 1}: At least one responsibility/bullet point is required`);
          }
        });
      }
      
      // Check education
      if (!resumeData.education || resumeData.education.length === 0) {
        errors.push('â€¢ At least one Education entry is required');
      } else {
        resumeData.education.forEach((edu, idx) => {
          if (!edu.degree || edu.degree.trim().length === 0) {
            errors.push(`â€¢ Education ${idx + 1}: Degree is required`);
          }
          if (!edu.institution || edu.institution.trim().length === 0) {
            errors.push(`â€¢ Education ${idx + 1}: Institution is required`);
          }
        });
      }
    }
    
    return errors;
  }
  
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  async function generateResume(){
    console.log('[DEBUG] Generate Resume clicked');
    
    // Get selected resume mode
    const resumeModeRadio = document.querySelector('input[name="resumeMode"]:checked');
    const resumeMode = resumeModeRadio ? resumeModeRadio.value : 'complete_jd'; // Default to complete_jd
    
    const {resume_data: resumeObj, job_description_data: jobObj} = buildJSON();
    
    // Validate based on mode with better feedback
    const validationErrors = validateResumeInput(resumeObj, jobObj, resumeMode);
    if (validationErrors.length > 0) {
      const errorList = validationErrors.map((err, idx) => `${idx + 1}. ${err}`).join('\n');
      const errorMessage = 'âŒ Please fix the following issues:\n\n' + errorList;
      alert(errorMessage);
      showResult('âŒ Validation failed - check required fields');
      
      // Highlight first error field if possible
      if (validationErrors[0].includes('Summary')) {
        document.querySelector('textarea[name="summary"]')?.focus();
      } else if (validationErrors[0].includes('Job Description')) {
        document.getElementById('jobDescriptionTab')?.focus();
      }
      return;
    }
    
    // Generate unique request ID
    const requestId = generateRequestId();
    const companyName = jobObj.company_name || 'Unknown Company';
    
    console.log('[DEBUG] Request ID:', requestId, 'Company:', companyName);
    
    // Add request to UI tracking
    addRequestToUI(requestId, companyName);
    
    const payload = {
      resume_data: resumeObj,
      job_description_data: jobObj,
      mode: resumeMode  // Add mode to payload
    };
    
    // Call new endpoint for JSON output (use correct backend port)
    const apiUrl = 'http://localhost:5001/api/generate_resume_json';
    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok){
        const json = await res.json();
        // Show success message with file name
        const fileName = json.file_name || 'resume.docx';
        const result = json.result || 'Resume generated successfully';
        
        // Mark request as complete in UI
        markRequestComplete(requestId, fileName);
        
        showResult(`âœ… ${result} - ${fileName}`);
      }
      else {
        const errorText = await res.text();
        console.error('API Error:', errorText);
        
        // Mark request as failed in UI
        markRequestFailed(requestId, errorText);
        
        showResult('âŒ Error generating resume.');
      }
    } catch (error) {
      console.error('Request failed:', error);
      
      // Mark request as failed in UI
      markRequestFailed(requestId, error.message);
      
      showResult('âŒ Failed to connect to server.');
    }
  }
  

  function clearAll(){if(!confirm("Clear all fields?"))return;
    document.getElementById('resumeForm').reset();
    document.getElementById('contactList').innerHTML='';
    document.getElementById('skillsList').innerHTML='';
    document.getElementById('experienceList').innerHTML='';
    document.getElementById('educationList').innerHTML='';
    document.getElementById('projectsList').innerHTML='';
    document.getElementById('certificationsList').innerHTML='';
    const jobDescTab = document.getElementById('jobDescriptionTab');
    const companyNameJD = document.getElementById('companyNameJD');
    if (jobDescTab) jobDescTab.value = '';
    if (companyNameJD) companyNameJD.value = '';
    addContact('Phone', '');addContact('Email', '');addContact('LinkedIn', '');
    addSkill();addExperience();addEducation();addProject();addCertification();showResult('ğŸ§¹ Cleared all fields');}

  function showResult(msg){const r=document.getElementById('result');r.textContent=msg;setTimeout(()=>r.textContent='',4000);}

  /* ---------- ABOUT MODAL ---------- */
  const modal=document.getElementById("aboutModal");
  function openAbout(){modal.style.display="block";}
  function closeAbout(){modal.style.display="none";}
  window.onclick=function(e){if(e.target==modal)modal.style.display="none";}

  /* ---------- FAQ ACCORDION ---------- */
  function toggleFAQ(button) {
    const faqItem = button.parentElement;
    const isActive = faqItem.classList.contains('active');
    
    // Close all FAQ items
    document.querySelectorAll('.faq-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Open clicked item if it wasn't active
    if (!isActive) {
      faqItem.classList.add('active');
    }
  }

  /* ---------- FAQ SECTION TOGGLE ---------- */
  function toggleFAQSection() {
    const faqSection = document.getElementById('faqSection');
    if (faqSection.classList.contains('active')) {
      faqSection.classList.remove('active');
    } else {
      faqSection.classList.add('active');
      // Scroll to FAQ section smoothly
      setTimeout(() => {
        faqSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
  }

  // --------- TAB SWITCHING LOGIC ---------
  const tabResumeBtn = document.getElementById('tabResumeBtn');
  const tabEditJDBtn = document.getElementById('tabEditJDBtn');
  const tabDashboardBtn = document.getElementById('tabDashboardBtn');
  const resumeFormContainer = document.getElementById('resumeFormContainer');
  const jobDescTabPanel = document.getElementById('jobDescTabPanel');
  const dashboardTabPanel = document.getElementById('dashboardTabPanel');

  function switchTab(tab) {
    // Remove active from all tabs
    tabResumeBtn.classList.remove('active');
    tabEditJDBtn.classList.remove('active');
    tabDashboardBtn.classList.remove('active');
    resumeFormContainer.classList.remove('active');
    jobDescTabPanel.classList.remove('active');
    dashboardTabPanel.classList.remove('active');

    // Get action bar
    const actionBar = document.getElementById('actionBar');
    
    // Activate the selected tab
    if (tab === 'resume') {
      tabResumeBtn.classList.add('active');
      resumeFormContainer.classList.add('active');
      actionBar.style.display = 'flex'; // Show in View Resume
    } else if (tab === 'jd') {
      tabEditJDBtn.classList.add('active');
      jobDescTabPanel.classList.add('active');
      actionBar.style.display = 'none'; // Hide in Generate Resume
    } else if (tab === 'dashboard') {
      tabDashboardBtn.classList.add('active');
      dashboardTabPanel.classList.add('active');
      actionBar.style.display = 'none'; // Hide in Dashboard
      loadDashboardStats(); // Load stats when dashboard tab is opened
      loadDashboardHistory(); // Load resume history
    }
  }
  
  tabResumeBtn.addEventListener('click', () => switchTab('resume'));
  tabEditJDBtn.addEventListener('click', () => switchTab('jd'));
  tabDashboardBtn.addEventListener('click', () => switchTab('dashboard'));

  // --------- INIT ---------
  // Initialize with common contact fields
  document.getElementById('contactList').innerHTML = '';
  addContact('Phone', '');
  addContact('Email', '');
  addContact('LinkedIn', '');
  addSkill();addExperience();addEducation();addProject();addCertification();
  // Default: show Resume tab
  switchTab('resume');

  // --------- JOB DESC TAB PANEL LOGIC ---------
  const jobDescriptionTab = document.getElementById('jobDescriptionTab');
  
  // Generate Resume Based on JD button
  const generateJDResumeBtn = document.getElementById('generateJDResumeBtn');
  console.log('Generate JD Resume Button found:', generateJDResumeBtn);
  
  if (generateJDResumeBtn) {
    console.log('Adding click listener to Generate JD Resume button');
    generateJDResumeBtn.addEventListener('click', async function() {
      console.log('Generate JD Resume button clicked!');
      
      const jdText = jobDescriptionTab.value.trim();
      const companyName = document.getElementById('companyNameJD').value.trim();
      const jobTitle = document.getElementById('jobTitleJD').value.trim();
      
      console.log('Form values:', { companyName, jobTitle, jdTextLength: jdText.length });
      
      if (!companyName) {
        alert('Please enter the company name!');
        document.getElementById('companyNameJD').focus();
        return;
      }
      
      if (!jobTitle) {
        alert('Please enter the job title!');
        document.getElementById('jobTitleJD').focus();
        return;
      }
      
      if (!jdText) {
        alert('Please paste a job description first!');
        return;
      }

      // Check if user is logged in
      if (!dashboardCredentials) {
        alert('Please login first to generate resumes!');
        switchTab('dashboard');
        return;
      }

      // Get resume data from form
      const resumeData = getResumeData();
      
      // Generate using authenticated endpoint
      try {
        const requestData = {
          mode: "complete_jd",
          resume_data: resumeData,
          job_description_data: {
            company_name: companyName,
            job_title: jobTitle,
            job_description: jdText
          },
          request_id: `req_${Date.now()}_${dashboardCredentials.username}`
        };

        console.log('Sending request:', requestData);

        const response = await fetch(`${API_BASE_URL}/api/generate_resume_json`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
          },
          body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const error = await response.json().catch(() => ({ detail: 'Request failed' }));
          throw new Error(error.detail || 'Failed to generate resume');
        }

        const result = await response.json();
        console.log('Success:', result);
        
        // Add to processing banner
        addRequestToUI(result.request_id, companyName);
        
        // Show success message and switch to dashboard
        alert(`Resume generation started! Request ID: ${result.request_id}\n\nGo to Dashboard to track progress.`);
        switchTab('dashboard');
        loadDashboardHistory();
        
      } catch (error) {
        console.error('Generation failed:', error);
        alert(`Error: ${error.message}`);
      }
    });
  } else {
    console.error('Generate JD Resume button NOT found in DOM!');
  }

  // Load Sample JD for the tab textarea
  function loadSampleJobDescTab() {
    const sampleText = `We are looking for a skilled Software Engineer with experience in JavaScript, React, and Node.js. The candidate should have strong problem-solving skills and the ability to work in a fast-paced environment. Responsibilities include developing new features, optimizing performance, and collaborating with cross-functional teams.`;
    if (jobDescriptionTab) jobDescriptionTab.value = sampleText;
  }
  // Optionally, allow loading sample JD when double-clicking the textarea
  if (jobDescriptionTab) {
    jobDescriptionTab.addEventListener('dblclick', loadSampleJobDescTab);
  }

  /* ---------- INITIALIZE PAGE ---------- */
  // Show Basic Info section by default
  window.addEventListener('DOMContentLoaded', function() {
    const basicSection = document.getElementById('section-basic');
    const basicBtn = document.querySelector('.form-nav-btn');
    
    if (basicSection) {
      basicSection.classList.add('active');
    }
    if (basicBtn) {
      basicBtn.classList.add('active');
    }
  });

  /* ---------- DASHBOARD FUNCTIONALITY ---------- */
  const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:5001'
    : '';

  let dashboardCredentials = null;
  let dashboardPollIntervals = {};
  let currentUsername = null;
  let currentPassword = null;
  let dashboardPageSize = 20; // Default page size
  let currentPage = 1; // Current page number
  let totalJobs = 0; // Total number of jobs
  let allDashboardJobs = []; // Store all jobs for filtering

  // Change page size function
  function changePageSize() {
    const select = document.getElementById('pageSizeSelect');
    dashboardPageSize = parseInt(select.value);
    currentPage = 1; // Reset to first page when changing page size
    loadDashboardHistory();
  }

  // Change page function
  function changePage(page) {
    currentPage = page;
    loadDashboardHistory();
  }

  // Render pagination controls
  function renderPagination() {
    const totalPages = Math.ceil(totalJobs / dashboardPageSize);
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let paginationHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px;">';
    
    // Previous button
    paginationHTML += `
      <button onclick="changePage(${currentPage - 1})" 
        ${currentPage === 1 ? 'disabled' : ''} 
        style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === 1 ? '0.5' : '1'};">
        â† Previous
      </button>
    `;
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page
    if (startPage > 1) {
      paginationHTML += `
        <button onclick="changePage(1)" 
          style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: pointer;">
          1
        </button>
      `;
      if (startPage > 2) {
        paginationHTML += '<span style="padding: 8px;">...</span>';
      }
    }
    
    // Visible page numbers
    for (let i = startPage; i <= endPage; i++) {
      paginationHTML += `
        <button onclick="changePage(${i})" 
          style="padding: 8px 12px; border: 1px solid ${i === currentPage ? 'var(--accent)' : 'var(--border)'}; border-radius: var(--radius-sm); background: ${i === currentPage ? 'var(--accent)' : 'var(--bg)'}; color: ${i === currentPage ? 'white' : 'var(--text)'}; cursor: pointer; font-weight: ${i === currentPage ? '600' : '400'};">
          ${i}
        </button>
      `;
    }
    
    // Last page
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML += '<span style="padding: 8px;">...</span>';
      }
      paginationHTML += `
        <button onclick="changePage(${totalPages})" 
          style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: pointer;">
          ${totalPages}
        </button>
      `;
    }
    
    // Next button
    paginationHTML += `
      <button onclick="changePage(${currentPage + 1})" 
        ${currentPage === totalPages ? 'disabled' : ''} 
        style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === totalPages ? '0.5' : '1'};">
        Next â†’
      </button>
    `;
    
    paginationHTML += '</div>';
    paginationHTML += `<div style="text-align: center; padding: 0 0 20px 0; font-size: 13px; color: var(--text-secondary);">
      Page ${currentPage} of ${totalPages} (${totalJobs} total results)
    </div>`;
    
    paginationContainer.innerHTML = paginationHTML;
  }

  // Filter dashboard table - reload from server with filters
  function filterDashboardTable() {
    currentPage = 1; // Reset to first page when filtering
    loadDashboardHistory();
  }

  // Clear all filters
  function clearDashboardFilters() {
    document.getElementById('filterCompany').value = '';
    document.getElementById('filterJobTitle').value = '';
    document.getElementById('filterStatus').value = '';
    currentPage = 1; // Reset to first page when clearing filters
    filterDashboardTable();
  }

  // Auth Tab Switching
  function switchAuthTab(tab) {
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');

    if (tab === 'login') {
      loginTabBtn.classList.add('active');
      registerTabBtn.classList.remove('active');
      loginForm.classList.add('active');
      registerForm.classList.remove('active');
    } else {
      registerTabBtn.classList.add('active');
      loginTabBtn.classList.remove('active');
      registerForm.classList.add('active');
      loginForm.classList.remove('active');
    }
  }

  // Dashboard Panels Switching
  function switchDashTab(tab) {
    const genBtn = document.getElementById('dashGenTab');
    const histBtn = document.getElementById('dashHistTab');
    const genPanel = document.getElementById('dashGeneratePanel');
    const histPanel = document.getElementById('dashHistoryPanel');

    if (tab === 'generate') {
      genBtn.classList.add('active');
      histBtn.classList.remove('active');
      genPanel.classList.add('active');
      histPanel.style.display = 'none';
    } else {
      histBtn.classList.add('active');
      genBtn.classList.remove('active');
      histPanel.style.display = 'block';
      genPanel.classList.remove('active');
      loadDashboardHistory();
    }
  }

  // Show Message
  function showDashMessage(message, type = 'info') {
    const authMsg = document.getElementById('authMessage');
    const dashMsg = document.getElementById('dashboardMessage');
    
    const msgBox = dashboardCredentials ? dashMsg : authMsg;
    msgBox.style.display = 'block';
    msgBox.style.background = type === 'error' ? '#fed7d7' : type === 'success' ? '#c6f6d5' : '#bee3f8';
    msgBox.style.color = type === 'error' ? '#742a2a' : type === 'success' ? '#22543d' : '#2c5282';
    msgBox.style.border = `1px solid ${type === 'error' ? '#fc8181' : type === 'success' ? '#9ae6b4' : '#90cdf4'}`;
    msgBox.textContent = message;
    setTimeout(() => msgBox.style.display = 'none', 5000);
  }

  // API Call Helper
  async function dashApiCall(endpoint, options = {}) {
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers
    };

    if (dashboardCredentials) {
      headers['Authorization'] = 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`);
    }

    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ detail: 'Request failed' }));
      
      // Extract the error message from backend
      const errorMessage = error.detail || error.message || 'Request failed';
      
      throw new Error(errorMessage);
    }

    return response.json();
  }

  // Handle Register
  async function handleDashboardRegister() {
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerPasswordConfirm').value;

    if (!username || !password) {
      showDashMessage('Please fill in all fields', 'error');
      return;
    }

    if (password !== confirm) {
      showDashMessage('Passwords do not match!', 'error');
      return;
    }

    try {
      await dashApiCall('/api/auth/register', {
        method: 'POST',
        body: JSON.stringify({ user_id: username, password })
      });

      showDashMessage('Account created! Please login.', 'success');
      switchAuthTab('login');
      document.getElementById('loginUsername').value = username;
    } catch (error) {
      showDashMessage(error.message, 'error');
    }
  }

  // Handle Login
  async function handleDashboardLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
      showDashMessage('Please enter username and password', 'error');
      return;
    }

    dashboardCredentials = { username, password };

    try {
      await dashApiCall('/api/auth/login', { method: 'POST' });
      
      // Show dashboard view
      document.getElementById('authView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'block';
      
      loadDashboardStats();
      loadDashboardHistory();
    } catch (error) {
      dashboardCredentials = null;
      // Display specific error message from backend
      const errorMessage = error.message || 'Login failed. Please try again.';
      showDashMessage(errorMessage, 'error');
    }
  }

  // Handle Logout
  function handleDashboardLogout() {
    dashboardCredentials = null;
    document.getElementById('authView').style.display = 'block';
    document.getElementById('dashboardView').style.display = 'none';
    
    // Clear poll intervals
    Object.values(dashboardPollIntervals).forEach(clearInterval);
    dashboardPollIntervals = {};
    
    // Clear forms
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
  }

  // Load User Stats
  async function loadDashboardStats() {
    try {
      const stats = await dashApiCall('/api/user/stats');
      
      // Calculate progress percentages for visual effect
      const totalProgress = Math.min((stats.total_resumes / 50) * 100, 100); // Scale to 50 resumes
      const todayProgress = Math.min((stats.today_resumes / 10) * 100, 100); // Scale to 10 per day
      const activeProgress = (stats.active_jobs / stats.limits.max_concurrent_jobs) * 100;
      
      document.getElementById('statsCards').innerHTML = `
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #667eea; stroke-dashoffset: ${327 - (327 * totalProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.total_resumes}</div>
          </div>
          <div class="stat-label-modern">TOTAL RESUMES</div>
        </div>
        
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #f5576c; stroke-dashoffset: ${327 - (327 * todayProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.today_resumes}</div>
          </div>
          <div class="stat-label-modern">TODAY</div>
        </div>
        
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #00f2fe; stroke-dashoffset: ${327 - (327 * activeProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.active_jobs}</div>
          </div>
          <div class="stat-label-modern">PROCESSING</div>
        </div>
      `;
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  }

  // Load Resume File
  function loadDashResumeFile(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('dashResumeJSON').value = e.target.result;
      };
      reader.readAsText(file);
    }
  }

  // Handle Generate Resume
  async function handleDashboardGenerate() {
    const companyName = document.getElementById('dashCompanyName').value;
    const jobTitle = document.getElementById('dashJobTitle').value;
    const jd = document.getElementById('dashJobDescription').value;
    const mode = document.getElementById('dashMode').value;
    const resumeJSONText = document.getElementById('dashResumeJSON').value;

    if (!companyName || !jobTitle || !jd) {
      showDashMessage('Please fill in company name, job title, and job description', 'error');
      return;
    }

    let resumeData;
    try {
      resumeData = resumeJSONText ? JSON.parse(resumeJSONText) : {};
    } catch (e) {
      showDashMessage('Invalid JSON format in resume data!', 'error');
      return;
    }

    const requestData = {
      mode: mode,
      resume_data: resumeData,
      job_description_data: {
        company_name: companyName,
        job_title: jobTitle,
        job_description: jd
      }
    };

    const btn = document.getElementById('dashGenerateBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    try {
      const result = await dashApiCall('/api/generate_resume_json', {
        method: 'POST',
        body: JSON.stringify(requestData)
      });

      showDashMessage(`Resume generation started! Request ID: ${result.request_id}`, 'success');
      
      // Switch to history tab
      switchDashTab('history');
      
      // Start polling for this job
      startDashboardPolling(result.request_id);
      
    } catch (error) {
      showDashMessage(error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate Resume';
    }
  }

  // Kebab Menu Functions
  function toggleKebabMenu(event, requestId) {
    event.stopPropagation();
    const dropdown = document.getElementById(`kebab-${requestId}`);
    const allDropdowns = document.querySelectorAll('.kebab-dropdown');
    
    // Close all other dropdowns
    allDropdowns.forEach(d => {
      if (d !== dropdown) d.style.display = 'none';
    });
    
    // Toggle current dropdown
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  }

  function closeKebabMenu(requestId) {
    const dropdown = document.getElementById(`kebab-${requestId}`);
    if (dropdown) {
      dropdown.style.display = 'none';
    }
  }

  // Close kebab menus when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.kebab-menu-btn')) {
      document.querySelectorAll('.kebab-dropdown').forEach(d => {
        d.style.display = 'none';
      });
    }
  });

  // Start Polling Job Status
  function startDashboardPolling(requestId) {
    // Stop existing polling if it exists
    if (dashboardPollIntervals[requestId]) {
      console.log('[POLLING] Polling already exists for:', requestId, '- skipping');
      return;
    }

    console.log('[POLLING] Starting polling for:', requestId);
    
    let pollCount = 0;
    const maxPolls = 150; // 5 minutes max (150 * 2s = 300s)
    
    dashboardPollIntervals[requestId] = setInterval(async () => {
      pollCount++;
      
      // Stop polling after 5 minutes
      if (pollCount > maxPolls) {
        console.log('[POLLING] Max polling duration reached (5 minutes), stopping for:', requestId);
        clearInterval(dashboardPollIntervals[requestId]);
        delete dashboardPollIntervals[requestId];
        showDashMessage('Job is taking longer than expected. Please refresh to check status.', 'warning');
        return;
      }
      
      try {
        const status = await dashApiCall(`/api/jobs/${requestId}/status`);
        console.log('[POLLING] Update received for', requestId);
        console.log('[POLLING] Status:', status.status);
        console.log('[POLLING] Progress:', status.progress);
        console.log('[POLLING] Message:', status.message);
        
        // Update processing banner with progress
        if (status.status === 'processing' && status.progress !== undefined) {
          updateRequestProgress(requestId, status.progress, status.message);
        }
        
        updateDashboardJobCard(requestId, status);

        if (status.status === 'completed') {
          console.log('[POLLING] Job completed, stopping polling for:', requestId);
          clearInterval(dashboardPollIntervals[requestId]);
          delete dashboardPollIntervals[requestId];
          markRequestComplete(requestId, `${status.company_name}_${status.job_title}_Resume.docx`);
          loadDashboardStats();
          // Reload history to update UI without restarting polling
          setTimeout(() => loadDashboardHistory(), 100);
        } else if (status.status === 'failed') {
          console.log('[POLLING] Job failed, stopping polling for:', requestId);
          clearInterval(dashboardPollIntervals[requestId]);
          delete dashboardPollIntervals[requestId];
          markRequestFailed(requestId, status.error_message);
          loadDashboardStats();
          // Reload history to update UI without restarting polling
          setTimeout(() => loadDashboardHistory(), 100);
        }
      } catch (error) {
        console.error('[POLLING] Polling error:', error);
      }
    }, 2000); // Poll every 2 seconds
  }

  // Update Job Card/Row
  function updateDashboardJobCard(requestId, data) {
    console.log('[DASHBOARD UPDATE] Request ID:', requestId);
    console.log('[DASHBOARD UPDATE] Data received:', JSON.stringify(data, null, 2));
    
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    console.log('[DASHBOARD UPDATE] Found row:', row ? 'YES' : 'NO');
    
    if (!row) {
      console.log('[DASHBOARD UPDATE] Row not found, reloading history');
      loadDashboardHistory();
      return;
    }

    // Update status badge (3rd column)
    const statusCell = row.cells[2];
    if (statusCell) {
      const badge = statusCell.querySelector('.status-badge');
      if (badge) {
        badge.className = `status-badge status-${data.status}`;
        badge.textContent = data.status;
        console.log('[DASHBOARD UPDATE] Updated status badge to:', data.status);
      }
    }

    // Update progress (4th column)
    const progressCell = row.cells[3];
    console.log('[DASHBOARD UPDATE] Progress cell exists:', !!progressCell);
    console.log('[DASHBOARD UPDATE] Current status:', data.status);
    console.log('[DASHBOARD UPDATE] Progress value:', data.progress);
    
    if (progressCell) {
      if (data.status === 'processing' || data.status === 'pending') {
        const progressFill = progressCell.querySelector('.progress-fill');
        const progressText = progressCell.querySelector('.progress-text');
        
        console.log('[DASHBOARD UPDATE] Progress fill element:', !!progressFill);
        console.log('[DASHBOARD UPDATE] Progress text element:', !!progressText);
        
        if (progressFill) {
          const newWidth = `${data.progress}%`;
          progressFill.style.width = newWidth;
          console.log('[DASHBOARD UPDATE] Set progress bar width to:', newWidth);
          console.log('[DASHBOARD UPDATE] Actual width after set:', progressFill.style.width);
        }
        if (progressText) {
          const newText = `${data.progress}%`;
          progressText.textContent = newText;
          console.log('[DASHBOARD UPDATE] Set progress text to:', newText);
          console.log('[DASHBOARD UPDATE] Actual text after set:', progressText.textContent);
        }
      } else if (data.status === 'completed') {
        progressCell.innerHTML = '<span style="color: var(--success); font-weight: 600;">âœ“ 100%</span>';
        console.log('[DASHBOARD UPDATE] Set completed status');
      } else if (data.status === 'failed') {
        progressCell.innerHTML = '<span style="color: var(--danger);">âœ— Failed</span>';
        console.log('[DASHBOARD UPDATE] Set failed status');
      }
    }

    // Update actions (6th column)
    const actionsCell = row.cells[5];
    if (actionsCell) {
      const companyName = row.cells[0].textContent;
      const jobTitle = row.cells[1].textContent;
      
      if (data.status === 'completed') {
        actionsCell.style.position = 'relative';
        actionsCell.innerHTML = `
          <button class="kebab-menu-btn" onclick="toggleKebabMenu(event, '${requestId}')">â‹®</button>
          <div class="kebab-dropdown" id="kebab-${requestId}">
            <button class="primary" onclick="viewResumeContent('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span class="menu-icon">ï¿½ï¸</span>
              <span>View Resume</span>
            </button>
            <button class="secondary" onclick="viewJobDescription('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span class="menu-icon">ğŸ“‹</span>
              <span>View Job Description</span>
            </button>
            <button class="success" onclick="downloadResumeDocx('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span class="menu-icon">ğŸ“¥</span>
              <span>Download Resume</span>
            </button>
            <button class="danger" onclick="if(confirm('Delete this resume?')) { deleteResume('${requestId}'); closeKebabMenu('${requestId}'); }">
              <span class="menu-icon">ğŸ—‘ï¸</span>
              <span>Delete</span>
            </button>
          </div>
        `;
      } else if (data.status === 'failed') {
        actionsCell.innerHTML = `
          <div style="color: var(--danger); font-size: 0.85em; padding: 6px; background: #fed7d7; border-radius: 4px;" title="${data.error_message || 'Generation failed'}">
            âŒ Error
          </div>
        `;
      }
    }
  }

  // Load Job History
  async function loadDashboardHistory() {
    try {
      // Build query params with filters and pagination
      const params = new URLSearchParams();
      params.append('limit', dashboardPageSize);
      params.append('offset', (currentPage - 1) * dashboardPageSize);
      
      const companyFilter = document.getElementById('filterCompany')?.value || '';
      const jobTitleFilter = document.getElementById('filterJobTitle')?.value || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      
      if (companyFilter) params.append('company', companyFilter);
      if (jobTitleFilter) params.append('job_title', jobTitleFilter);
      if (statusFilter) params.append('status', statusFilter);
      
      const data = await dashApiCall(`/api/user/jobs?${params.toString()}`);
      
      // Store total count for pagination
      totalJobs = data.count;
      const tbody = document.getElementById('resumeHistoryBody');
      const resultCount = document.getElementById('resultCount');

      // Update result count display
      const isFiltered = companyFilter || jobTitleFilter || statusFilter;
      if (isFiltered) {
        resultCount.textContent = `Found ${data.count} resume${data.count !== 1 ? 's' : ''} matching your search`;
      } else {
        resultCount.textContent = data.count > 0 ? `Total: ${data.count} resume${data.count !== 1 ? 's' : ''}` : '';
      }

      if (data.count === 0) {
        const noResultsMsg = isFiltered 
          ? '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">ğŸ” No resumes match your search</p><p style="margin: 8px 0 0 0;">Try different search terms or clear filters</p></td></tr>'
          : '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">ğŸ“„ No resumes yet</p><p style="margin: 8px 0 0 0;">Start creating your first resume!</p></td></tr>';
        tbody.innerHTML = noResultsMsg;
        return;
      }

      tbody.innerHTML = data.jobs.map(job => `
        <tr data-request-id="${job.request_id}" style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseenter="this.style.background='var(--card)'" onmouseleave="this.style.background=''">
          <td style="padding: 12px 16px; color: var(--text-primary); font-weight: 500;">${job.company_name}</td>
          <td style="padding: 12px 16px; color: var(--text-primary);">${job.job_title}</td>
          <td style="padding: 12px 16px;">
            <span class="status-badge status-${job.status}" style="font-size: 0.85em; padding: 4px 12px; border-radius: 12px; display: inline-block;">${job.status}</span>
          </td>
          <td style="padding: 12px 16px; text-align: center;">
            ${job.status === 'processing' || job.status === 'pending' ? `
              <div style="width: 100%; max-width: 150px; margin: 0 auto;">
                <div class="progress-bar" style="height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                  <div class="progress-fill" style="width: ${job.progress}%; height: 100%; background: var(--accent); transition: width 0.3s;"></div>
                </div>
                <div class="progress-text" style="font-size: 0.75em; color: var(--text-secondary); margin-top: 4px;">${job.progress}%</div>
              </div>
            ` : job.status === 'completed' ? `
              <span style="color: var(--success); font-weight: 600;">âœ“ 100%</span>
            ` : `
              <span style="color: var(--danger);">âœ— Failed</span>
            `}
          </td>
          <td style="padding: 12px 16px; font-size: 0.85em; color: var(--text-secondary); white-space: nowrap;">
            ${new Date(job.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ${new Date(job.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}
          </td>
          <td style="padding: 12px 16px; text-align: right; position: relative;">
            ${job.status === 'completed' ? `
              <button class="kebab-menu-btn" onclick="toggleKebabMenu(event, '${job.request_id}')">â‹®</button>
              <div class="kebab-dropdown" id="kebab-${job.request_id}">
                <button class="primary" onclick="viewResumeContent('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span class="menu-icon">ï¿½ï¸</span>
                  <span>View Resume</span>
                </button>
                <button class="secondary" onclick="viewJobDescription('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span class="menu-icon">ğŸ“‹</span>
                  <span>View Job Description</span>
                </button>
                <button class="success" onclick="downloadResumeDocx('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span class="menu-icon">ğŸ“¥</span>
                  <span>Download Resume</span>
                </button>
                <button class="danger" onclick="if(confirm('Delete this resume?')) { deleteResume('${job.request_id}'); closeKebabMenu('${job.request_id}'); }">
                  <span class="menu-icon">ğŸ—‘ï¸</span>
                  <span>Delete</span>
                </button>
              </div>
            ` : job.status === 'processing' || job.status === 'pending' ? `
              <button class="sub-btn" style="padding: 6px 16px; font-size: 0.9em;" onclick="checkDashboardStatus('${job.request_id}')">
                ğŸ”„ Refresh
              </button>
            ` : `
              <div style="color: var(--danger); font-size: 0.85em; padding: 6px; background: #fed7d7; border-radius: 4px; display: inline-block;" title="${job.error_message || 'Generation failed'}">
                âŒ Error
              </div>
            `}
          </td>
        </tr>
      `).join('');

      // Start polling for active jobs
      data.jobs.forEach(job => {
        if (job.status === 'processing' || job.status === 'pending') {
          startDashboardPolling(job.request_id);
        }
      });

      // Render pagination controls
      renderPagination();

    } catch (error) {
      console.error('Failed to load history:', error);
    }
  }

  // Download Resume as DOCX (on-the-fly generation)
  async function downloadResumeDocx(requestId, companyName, jobTitle) {
    try {
      // Fetch the resume JSON
      const data = await dashApiCall(`/api/jobs/${requestId}/result`);
      
      if (!data.final_resume) {
        showDashMessage('Resume data not found', 'error');
        return;
      }

      // Call the backend to generate DOCX on-the-fly
      const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}/download`, {
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      });

      if (!response.ok) {
        throw new Error('Failed to generate resume');
      }

      // Download the file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${companyName}_${jobTitle}_Resume.docx`.replace(/[^a-z0-9_\-\.]/gi, '_');
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showDashMessage('Resume downloaded successfully!', 'success');
    } catch (error) {
      console.error('Download failed:', error);
      showDashMessage('Failed to download resume', 'error');
    }
  }

  // Download Job Description
  async function downloadJobDescription(requestId, companyName, jobTitle) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      });

      if (!response.ok) {
        throw new Error('Failed to download job description');
      }

      // Download the file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${companyName}_${jobTitle}_JD.txt`.replace(/[^a-z0-9_\-\.]/gi, '_');
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showDashMessage('Job description downloaded successfully!', 'success');
    } catch (error) {
      console.error('JD download failed:', error);
      showDashMessage('Failed to download job description', 'error');
    }
  }

  // Delete Resume
  async function deleteResume(requestId) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to delete resume');
      }

      // Remove the row from the table
      const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
      if (row) {
        row.remove();
      }

      // Reload dashboard stats and history
      loadDashboardStats();
      loadDashboardHistory();
      
      showDashMessage('Resume deleted successfully!', 'success');
    } catch (error) {
      console.error('Delete failed:', error);
      showDashMessage(error.message || 'Failed to delete resume', 'error');
    }
  }

  // Check Status
  async function checkDashboardStatus(requestId) {
    console.log('Checking status for:', requestId);
    try {
      const status = await dashApiCall(`/api/jobs/${requestId}/status`);
      console.log('Status received:', status);
      updateDashboardJobCard(requestId, status);
      showDashMessage(`Progress: ${status.progress}%`, 'success');
    } catch (error) {
      console.error('Status check failed:', error);
      showDashMessage(error.message, 'error');
    }
  }

  // View Resume JSON
  async function viewDashboardResume(requestId) {
    try {
      const data = await dashApiCall(`/api/jobs/${requestId}/result`);
      const json = JSON.stringify(data.final_resume, null, 2);
      
      const newWindow = window.open('', '_blank');
      newWindow.document.write(`
        <html>
        <head><title>Resume JSON - ${data.company_name}</title></head>
        <body style="font-family: monospace; padding: 20px; background: #1a202c; color: #e2e8f0;">
          <h2 style="color: #90cdf4;">${data.company_name} - ${data.job_title}</h2>
          <pre style="background: #2d3748; padding: 20px; border-radius: 8px; overflow: auto;">${json}</pre>
        </body>
        </html>
      `);
    } catch (error) {
      showDashMessage(error.message, 'error');
    }
  }

  // Download Resume
  function downloadDashboardResume(requestId) {
    const url = `${API_BASE_URL}/api/jobs/${requestId}/download`;
    
    if (dashboardCredentials) {
      fetch(url, {
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      })
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resume_${requestId}.docx`;
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch(error => {
        showDashMessage('Download failed: ' + error.message, 'error');
      });
    }
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    Object.values(dashboardPollIntervals).forEach(clearInterval);
  });

  /* ---------- MAIN AUTH FUNCTIONALITY ---------- */
  
  // Switch Main Auth Forms
  function switchMainAuthTab(tab) {
    const loginForm = document.getElementById('mainLoginForm');
    const registerForm = document.getElementById('mainRegisterForm');
    const resetForm = document.getElementById('mainResetForm');

    // Hide all forms
    loginForm.classList.remove('active');
    registerForm.classList.remove('active');
    resetForm.classList.remove('active');

    // Show selected form
    if (tab === 'login') {
      loginForm.classList.add('active');
    } else if (tab === 'register') {
      registerForm.classList.add('active');
    } else if (tab === 'reset') {
      resetForm.classList.add('active');
    }
  }

  // Show Main Auth Message
  function showMainAuthMessage(message, type = 'info') {
    const msgBox = document.getElementById('mainAuthMessage');
    msgBox.style.display = 'block';
    msgBox.style.background = type === 'error' ? '#fed7d7' : type === 'success' ? '#c6f6d5' : '#bee3f8';
    msgBox.style.color = type === 'error' ? '#742a2a' : type === 'success' ? '#22543d' : '#2c5282';
    msgBox.style.border = `1px solid ${type === 'error' ? '#fc8181' : type === 'success' ? '#9ae6b4' : '#90cdf4'}`;
    msgBox.textContent = message;
    setTimeout(() => msgBox.style.display = 'none', 5000);
  }

  // Handle Main Register
  async function handleMainRegister() {
    const username = document.getElementById('mainRegisterUsername').value;
    const password = document.getElementById('mainRegisterPassword').value;
    const confirm = document.getElementById('mainRegisterPasswordConfirm').value;

    if (!username || !password) {
      showMainAuthMessage('Please fill in all fields', 'error');
      return;
    }

    if (password !== confirm) {
      showMainAuthMessage('Passwords do not match!', 'error');
      return;
    }

    try {
      await dashApiCall('/api/auth/register', {
        method: 'POST',
        body: JSON.stringify({ user_id: username, password })
      });

      showMainAuthMessage('Account created! Please login.', 'success');
      switchMainAuthTab('login');
      document.getElementById('mainLoginUsername').value = username;
    } catch (error) {
      showMainAuthMessage(error.message, 'error');
    }
  }

  // Handle Password Reset
  async function handlePasswordReset() {
    const username = document.getElementById('mainResetUsername').value;
    const newPassword = document.getElementById('mainResetNewPassword').value;
    const confirmPassword = document.getElementById('mainResetConfirmPassword').value;

    if (!username || !newPassword || !confirmPassword) {
      showMainAuthMessage('Please fill in all fields', 'error');
      return;
    }

    if (newPassword.length < 8) {
      showMainAuthMessage('Password must be at least 8 characters', 'error');
      return;
    }

    if (newPassword !== confirmPassword) {
      showMainAuthMessage('Passwords do not match', 'error');
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, new_password: newPassword })
      });

      const result = await response.json();

      if (response.ok) {
        showMainAuthMessage('Password reset successful! Please sign in.', 'success');
        // Clear form
        document.getElementById('mainResetUsername').value = '';
        document.getElementById('mainResetNewPassword').value = '';
        document.getElementById('mainResetConfirmPassword').value = '';
        // Switch to login after 2 seconds
        setTimeout(() => switchMainAuthTab('login'), 2000);
      } else {
        showMainAuthMessage(result.detail || 'Password reset failed', 'error');
      }
    } catch (error) {
      console.error('Password reset error:', error);
      showMainAuthMessage('Password reset failed', 'error');
    }
  }

  // Handle Main Login
  async function handleMainLogin() {
    const username = document.getElementById('mainLoginUsername').value;
    const password = document.getElementById('mainLoginPassword').value;

    if (!username || !password) {
      showMainAuthMessage('Please enter username and password', 'error');
      return;
    }

    console.log('Attempting login for user:', username);
    dashboardCredentials = { username, password };
    
    // Store credentials globally for template load
    currentUsername = username;
    currentPassword = password;

    try {
      const result = await dashApiCall('/api/auth/login', { method: 'POST' });
      console.log('Login successful:', result);
      
      // Hide auth screen, show main app
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Show logout button and username in header
      document.getElementById('headerUserInfo').textContent = `ğŸ‘¤ ${username}`;
      document.getElementById('headerUserInfo').style.display = 'inline';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      
      // Show header and footer
      document.getElementById('mainHeader').style.display = 'flex';
      document.getElementById('mainFooter').style.display = 'block';
      
      // Load stats (for dashboard tab)
      loadDashboardStats();
      loadDashboardHistory();
      
      // Auto-load saved resume template
      await loadResumeTemplate();
      
    } catch (error) {
      console.error('Login failed:', error);
      dashboardCredentials = null;
      currentUsername = null;
      currentPassword = null;
      showMainAuthMessage(error.message || 'Login failed', 'error');
    }
  }

  // Handle Main Logout
  function handleMainLogout() {
    if (!confirm('Are you sure you want to logout?')) return;
    
    dashboardCredentials = null;
    currentUsername = null;
    currentPassword = null;
    
    // Show auth screen, hide main app
    document.getElementById('authScreen').style.display = 'grid';
    document.getElementById('mainApp').style.display = 'none';
    
    // Hide logout button and username in header
    document.getElementById('headerUserInfo').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    
    // Hide header and footer
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainFooter').style.display = 'none';
    
    // Clear forms
    document.getElementById('mainLoginUsername').value = '';
    document.getElementById('mainLoginPassword').value = '';
    document.getElementById('mainRegisterUsername').value = '';
    document.getElementById('mainRegisterPassword').value = '';
    document.getElementById('mainRegisterPasswordConfirm').value = '';
    
    // Clear poll intervals
    Object.values(dashboardPollIntervals).forEach(clearInterval);
    dashboardPollIntervals = {};
    
    // Switch back to login tab
    switchMainAuthTab('login');
  }

  // On page load, check if user is already logged in (from sessionStorage)
  window.addEventListener('DOMContentLoaded', () => {
    // Auth screen is shown by default (no auto-login)
  });

</script>
<script src="/static/js/main.js?v=23.0"></script>
</html>
