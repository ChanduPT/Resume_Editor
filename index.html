<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume Builder Pro</title>
<link rel="stylesheet" href="/static/css/main.css?v=74.0">
</head>
<body>
<!-- Loading Overlay for Document Parsing -->
<div id="parseLoadingOverlay" class="parse-loading-overlay" style="display: none;">
  <div class="parse-loading-content">
    <div class="parse-loading-spinner"></div>
    <h2 class="parse-loading-title">Parsing Your Resume</h2>
    <p class="parse-loading-message">Extracting text and structuring your resume data...</p>
    <div class="parse-loading-progress">
      <div class="parse-progress-bar">
        <div id="parseProgressFill" class="parse-progress-fill"></div>
      </div>
      <p id="parseProgressText" class="parse-progress-text">0%</p>
    </div>
  </div>
</div>

<!-- Resume/JD View Modal -->
<div id="viewModal" class="view-modal" style="display: none;">
  <div class="view-modal-content">
    <div class="view-modal-header">
      <div class="view-modal-title-section">
        <h2 id="viewModalTitle"></h2>
        <p id="viewModalSubtitle"></p>
      </div>
      <button class="view-modal-close" onclick="closeViewModal()">‚úï</button>
    </div>
    
    <!-- Resume Formatting Toolbar -->
    <div class="resume-toolbar" id="resumeToolbar" style="display: none;">
      <div class="resume-toolbar-left">
        <div style="display: flex; align-items: center; gap: 6px;">
          <span class="toolbar-label">Format:</span>
          <select id="resumeFormatSelect" class="toolbar-select" onchange="changeResumeFormat(this.value)">
            <option value="classic">Classic (Times)</option>
            <option value="modern" selected>Modern (Calibri)</option>
          </select>
        </div>
        
        <div style="display: flex; align-items: center; gap: 6px;">
          <span class="toolbar-label">Font Size:</span>
          <select id="resumeFontSizeSelect" class="toolbar-select" onchange="changeResumeFontSize(this.value)">
            <option value="small">10pt</option>
            <option value="medium" selected>11pt</option>
            <option value="large">12pt</option>
          </select>
        </div>
        
        <button class="toolbar-btn" onclick="window.print()" title="Print Resume">
          <span>üñ®Ô∏è</span>
          <span>Print</span>
        </button>
        
        <button class="toolbar-btn" onclick="exportToPDF()" title="Save as PDF">
          <span>üìÑ</span>
          <span>Save PDF</span>
        </button>
      </div>
      
      <div class="resume-toolbar-right">
        <button class="toolbar-btn" id="compactModeBtn" onclick="toggleCompactMode()" title="Toggle section spacing">
          <span>üìè</span>
          <span>Compact</span>
        </button>
      </div>
    </div>
    
    <div class="view-modal-body" id="viewModalBody">
      <!-- Content will be loaded here -->
    </div>
    <div class="view-modal-footer">
      <button id="viewModalEditBtn" class="view-modal-btn primary" style="display: none;" onclick="toggleEditMode()">
        <span class="btn-icon"></span>
        <span id="editBtnText">Edit</span>
      </button>
      <button id="viewModalSaveBtn" class="view-modal-btn primary" style="display: none; background: #4a5568; border: none;" onclick="saveResumeChanges()" onmouseover="this.style.background='#2d3748'" onmouseout="this.style.background='#4a5568'">
        <span class="btn-icon"></span>
        <span>Save Changes</span>
      </button>
      <button id="viewModalDownloadResume" class="view-modal-btn success" style="display: none;">
        <span class="btn-icon"></span>
        <span>Download Resume</span>
      </button>
      <button id="viewModalDownloadJD" class="view-modal-btn success" style="display: none;">
        <span class="btn-icon"></span>
        <span>Download JD</span>
      </button>
      <button class="view-modal-btn cancel" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- Format Selection Modal -->
<div id="formatModal" class="view-modal" style="display: none;">
  <div class="view-modal-content" style="max-width: 480px;">
    <div class="view-modal-header" style="padding: 20px 24px; border-bottom: 1px solid var(--border); position: relative;">
      <h2 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text);">
        <span>Choose Resume Format</span>
      </h2>
      <button class="view-modal-close" onclick="closeFormatModal()" style="position: absolute; top: 18px; right: 20px; background: transparent; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--hover)'; this.style.color='var(--text)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">‚úï</button>
    </div>
    <div class="view-modal-body" style="padding: 20px 24px;">
      <p style="margin: 0 0 16px 0; color: var(--text-secondary); font-size: 13px;">Select the format for your resume download:</p>
      
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <label class="format-choice-card" style="cursor: pointer; padding: 14px; border: 2px solid var(--border); border-radius: 6px; transition: all 0.2s; display: flex; align-items: start; gap: 10px; background: var(--bg);" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--hover)'" onmouseout="if(!this.querySelector('input').checked) { this.style.borderColor='var(--border)'; this.style.background='var(--bg)' }">
          <input type="radio" name="downloadFormat" value="classic" checked style="margin-top: 3px; width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;">
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
              <h3 style="margin: 0; color: var(--text); font-size: 15px; font-weight: 600;">Classic</h3>
            </div>
            <p style="margin: 0 0 6px 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">Traditional Times New Roman with underlined headers</p>
          </div>
        </label>
        
        <label class="format-choice-card" style="cursor: pointer; padding: 14px; border: 2px solid var(--border); border-radius: 6px; transition: all 0.2s; display: flex; align-items: start; gap: 10px; background: var(--bg);" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--hover)'" onmouseout="if(!this.querySelector('input').checked) { this.style.borderColor='var(--border)'; this.style.background='var(--bg)' }">
          <input type="radio" name="downloadFormat" value="modern" style="margin-top: 3px; width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;">
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
              <h3 style="margin: 0; color: var(--text); font-size: 15px; font-weight: 600;">Modern</h3>
            </div>
            <p style="margin: 0 0 6px 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">Contemporary Calibri with bold headers</p>
          </div>
        </label>
      </div>
    </div>
    <div class="view-modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg);">
      <button class="view-modal-btn cancel" onclick="closeFormatModal()" style="padding: 9px 18px; border-radius: 6px; font-size: 13px; font-weight: 500; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='transparent'">Cancel</button>
      <button class="view-modal-btn primary" onclick="confirmFormatDownload()" style="padding: 9px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; border: none; background: #4F46E5; color: #ffffff; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#4338CA'" onmouseout="this.style.background='#4F46E5'">
        <span>Download</span>
        <span>Download Resume</span>
      </button>
    </div>
  </div>
</div>

<!-- Profile Edit Modal -->
<div id="profileModal" class="view-modal" style="display: none;">
  <div class="view-modal-content" style="max-width: 480px;">
    <div class="view-modal-header" style="padding: 20px 24px; border-bottom: 1px solid var(--border); position: relative;">
      <h2 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text);">
        <span>Edit Profile</span>
      </h2>
      <button class="view-modal-close" onclick="closeProfileModal()" style="position: absolute; top: 18px; right: 20px; background: transparent; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--hover)'; this.style.color='var(--text)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">‚úï</button>
    </div>
    <div class="view-modal-body" style="padding: 20px 24px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <div class="form-group">
          <label style="display: block; margin-bottom: 6px; color: var(--text); font-size: 13px; font-weight: 500;">First Name</label>
          <input type="text" id="profileFirstName" placeholder="Enter first name" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
        </div>
        <div class="form-group">
          <label style="display: block; margin-bottom: 6px; color: var(--text); font-size: 13px; font-weight: 500;">Last Name</label>
          <input type="text" id="profileLastName" placeholder="Enter last name" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
        </div>
      </div>
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; color: var(--text); font-size: 13px; font-weight: 500;">Email</label>
        <input type="email" id="profileEmail" disabled style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--hover); color: var(--text-secondary); font-size: 14px; cursor: not-allowed;">
        <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 12px;">Email cannot be changed</small>
      </div>
      <div id="profileMessage" style="margin-top: 12px; padding: 10px; border-radius: 6px; display: none; font-size: 13px;"></div>
    </div>
    <div class="view-modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg);">
      <button class="view-modal-btn cancel" onclick="closeProfileModal()" style="padding: 9px 18px; border-radius: 6px; font-size: 13px; font-weight: 500; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='transparent'">Cancel</button>
      <button class="view-modal-btn primary" onclick="saveProfile()" style="padding: 9px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; border: none; background: #4F46E5; color: #ffffff; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#4338CA'" onmouseout="this.style.background='#4F46E5'">
        <span>Save Changes</span>
      </button>
    </div>
  </div>
</div>

<!-- Keyword Review Modal -->
<div id="keywordReviewModal" class="view-modal" style="display: none;">
  <div class="view-modal-content" style="max-width: 1000px; position: relative;">
    <!-- Close button in top right corner -->
    <button class="view-modal-close" onclick="closeKeywordReviewModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; color: white; background: rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; border: none; cursor: pointer; transition: all 0.2s; backdrop-filter: blur(8px);" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">‚úï</button>
    
    <div class="view-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 28px 32px; border-radius: 12px 12px 0 0;">
      <div>
        <h2 style="margin: 0; font-size: 26px; font-weight: 600; letter-spacing: -0.5px;">Review & Customize Keywords</h2>
        <p style="margin: 6px 0 0 0; font-size: 14px; opacity: 0.9;">Click keywords to edit or remove them ‚Ä¢ Add new ones to match your experience</p>
      </div>
    </div>
    <div class="view-modal-body" style="padding: 32px; max-height: 65vh; overflow-y: auto; background: var(--bg);">
      
      <!-- Technical Keywords Section -->
      <div class="keyword-section" style="margin-bottom: 28px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
          <h3 style="margin: 0; color: var(--text); display: flex; align-items: center; gap: 10px; font-size: 18px;">
            <span style="font-size: 24px;"></span>
            <span>Technical Keywords</span>
            <span id="technicalCount" class="keyword-count" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px; padding: 4px 12px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(102,126,234,0.3);">0</span>
          </h3>
        </div>
        <div id="technicalKeywordsList" class="keywords-list" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 50px; padding: 16px; background: var(--bg); border-radius: 8px; border: 2px dashed var(--border);"></div>
        <div style="display: flex; gap: 10px; margin-top: 12px;">
          <input type="text" id="technicalInput" placeholder="e.g., Python, React, AWS..." style="flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; transition: border-color 0.2s;" onkeypress="if(event.key==='Enter') addKeywordToList('technicalKeywordsList', 'technicalInput')" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='var(--border)'">
          <button onclick="addKeywordToList('technicalKeywordsList', 'technicalInput')" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">+ Add</button>
        </div>
      </div>

      <!-- Soft Skills Section -->
      <div class="keyword-section" style="margin-bottom: 28px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
          <h3 style="margin: 0; color: var(--text); display: flex; align-items: center; gap: 10px; font-size: 18px;">
            <span style="font-size: 24px;">ü§ù</span>
            <span>Soft Skills</span>
            <span id="softSkillsCount" class="keyword-count" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 16px; padding: 4px 12px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(16,185,129,0.3);">0</span>
          </h3>
        </div>
        <div id="softSkillsList" class="keywords-list" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 50px; padding: 16px; background: var(--bg); border-radius: 8px; border: 2px dashed var(--border);"></div>
        <div style="display: flex; gap: 10px; margin-top: 12px;">
          <input type="text" id="softSkillsInput" placeholder="e.g., Leadership, Communication..." style="flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; transition: border-color 0.2s;" onkeypress="if(event.key==='Enter') addKeywordToList('softSkillsList', 'softSkillsInput')" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='var(--border)'">
          <button onclick="addKeywordToList('softSkillsList', 'softSkillsInput')" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">+ Add</button>
        </div>
      </div>

      <!-- Phrases Section -->
      <div class="keyword-section" style="background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
          <h3 style="margin: 0; color: var(--text); display: flex; align-items: center; gap: 10px; font-size: 18px;">
            <span style="font-size: 24px;">üí¨</span>
            <span>Key Phrases</span>
            <span id="phrasesCount" class="keyword-count" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px; padding: 4px 12px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(245,158,11,0.3);">0</span>
          </h3>
        </div>
        <div id="phrasesList" class="keywords-list" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 50px; padding: 16px; background: var(--bg); border-radius: 8px; border: 2px dashed var(--border);"></div>
        <div style="display: flex; gap: 10px; margin-top: 12px;">
          <input type="text" id="phrasesInput" placeholder="e.g., data-driven solutions, cross-functional teams..." style="flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px; transition: border-color 0.2s;" onkeypress="if(event.key==='Enter') addKeywordToList('phrasesList', 'phrasesInput')" onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='var(--border)'">
          <button onclick="addKeywordToList('phrasesList', 'phrasesInput')" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(245,158,11,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245,158,11,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'">+ Add</button>
        </div>
      </div>

      <div style="margin-top: 24px; padding: 16px 20px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border-radius: 12px; border-left: 4px solid #667eea;">
        <p style="margin: 0; font-size: 14px; color: var(--text); line-height: 1.6;">
          <strong>Pro Tip:</strong> Click any keyword to edit it inline. Add relevant skills and phrases that match both your experience and the job requirements for better ATS optimization.
        </p>
      </div>

    </div>
    <div class="view-modal-footer" style="padding: 20px 32px; display: flex; gap: 12px; justify-content: space-between; align-items: center; background: var(--card); border-top: 2px solid var(--border);">
      <div style="display: flex; align-items: center; gap: 16px;">
        <div style="font-size: 13px; color: var(--text-secondary);">
          <span id="totalKeywordsCount" style="font-weight: 600; color: var(--text);">0</span> keywords total
        </div>
        <button onclick="regenerateKeywords()" style="padding: 8px 16px; background: transparent; color: var(--primary); border: 2px solid var(--primary); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='var(--primary)';">
          <span>Regenerate Keywords</span>
        </button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="view-modal-btn cancel" onclick="closeKeywordReviewModal()" style="padding: 12px 24px; font-size: 15px; border: 2px solid var(--border); background: transparent; color: var(--text); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--border)';" onmouseout="this.style.background='transparent';">Cancel</button>
        <button class="view-modal-btn primary" onclick="continueToGeneration()" style="padding: 12px 28px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 16px rgba(102,126,234,0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(102,126,234,0.4)'">
          <span>Generate Resume</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Help/Tutorial Modal -->
<div id="helpModal" class="view-modal" style="display: none;">
  <div class="view-modal-content" style="max-width: 1200px;">
    <div class="view-modal-header">
      <h2>How to Use Resume Builder Pro</h2>
      <button class="view-modal-close" onclick="closeHelpModal()">‚úï</button>
    </div>
    <div class="view-modal-body" style="max-height: 70vh; overflow-y: auto;">
      <div style="padding: 20px; color: var(--text-primary);">
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
          <h3 style="margin-top: 0; color: var(--primary);">to Resume Builder Pro!</h3>
          <p style="line-height: 1.6;">An AI-powered platform that helps you create perfectly tailored resumes for every job application. Our intelligent system analyzes job descriptions and optimizes your resume to match exactly what employers are looking for.</p>
          <p style="line-height: 1.6; margin-top: 10px;"><strong>New Features:</strong> View & edit generated resumes, manage technical skills, track all applications in your personal dashboard!</p>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">1</span>
            Choose Your Generation Mode
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p><strong>Complete JD Mode:</strong> Generate a resume entirely from a job description. Best when starting from scratch.</p>
            <p><strong>Resume + JD Mode:</strong> Apply targeted edits to your existing resume based on a job description. Best for tailoring an existing resume.</p>
            <p style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 4px;"><em>Tip: Use Resume + JD mode for better results when you have an existing resume!</em></p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">2</span>
            Choose Resume Format
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p><strong>Classic Format:</strong> Traditional layout with Times New Roman and underlined headers.</p>
            <p><strong>Modern Format:</strong> Contemporary design with Calibri and bold headers.</p>
            <p style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 4px;"><em>Tip: Choose Classic if you're unsure about company culture!</em></p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">3</span>
            Fill in Job Description
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>Paste the complete job description including:</p>
            <ul style="line-height: 1.8;">
              <li><strong>Job responsibilities and requirements</strong></li>
              <li><strong>Required skills and technologies</strong></li>
              <li><strong>Qualifications and experience needed</strong></li>
            </ul>
            <p style="margin-top: 10px;"><strong>Company Name:</strong> Enter the company name</p>
            <p><strong>Job Title:</strong> Enter the exact position title</p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">4</span>
            Add Your Resume Data (Resume + JD Mode)
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>If using <strong>Resume + JD Mode</strong>, fill in your resume sections:</p>
            <ul style="line-height: 1.8;">
              <li><strong>Personal Info:</strong> Name, email, phone, LinkedIn, location</li>
              <li><strong>Summary:</strong> Professional summary (50+ characters)</li>
              <li><strong>Technical Skills:</strong> Add categories (e.g., Languages, Frameworks) and skills</li>
              <li><strong>Experience:</strong> Add roles with bullet points describing achievements</li>
              <li><strong>Education:</strong> Add degrees and institutions</li>
              <li><strong>Projects:</strong> Optional - showcase your work</li>
              <li><strong>Certifications:</strong> Optional - add relevant certifications</li>
            </ul>
            <p style="margin-top: 10px; padding: 10px; background: var(--warning-bg); border-radius: 4px; border-left: 4px solid #f59e0b;">
              ‚ö†Ô∏è <strong>Important:</strong> All required fields must be filled (minimum 50 characters for summary and job description).
            </p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">5</span>
            Generate Your Resume
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p>Click <strong>"Generate Resume"</strong> to start processing.</p>
            <p style="margin-top: 10px;">Generation takes <strong>30-90 seconds</strong>. You'll see:</p>
            <ul style="line-height: 1.8;">
              <li>‚úÖ Green notification when ready</li>
              <li>Progress in the dashboard</li>
              <li>Real-time status updates</li>
            </ul>
            <p style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 4px;"><em>You can generate up to 2 resumes simultaneously! Additional requests will queue automatically.</em></p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            <span style="background: var(--primary); color: white; border-radius: 50%; padding: 5px 12px; margin-right: 10px;">6</span>
            View, Edit & Download Your Resume
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            <p><strong>Your resume is ready!</strong> Access it from the dashboard with these powerful options:</p>
            
            <p style="margin-top: 15px;"><strong>Dashboard Actions (Menu):</strong></p>
            <ul style="line-height: 1.8;">
              <li><strong>View Resume:</strong> Opens an interactive preview modal</li>
              <li><strong>View Job Description:</strong> Review the original JD you submitted</li>
              <li><strong>Download Resume:</strong> Get your DOCX file instantly</li>
              <li><strong>Download JD:</strong> Save the job description as text</li>
              <li><strong>Delete:</strong> Remove entries you no longer need</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>Edit Mode:</strong></p>
            <p style="margin-top: 10px;">Click the <strong>"Edit"</strong> button in the view modal to unlock powerful editing:</p>
            <ul style="line-height: 1.8;">
              <li><strong>All Text Fields:</strong> Click any text to edit (name, email, phone, LinkedIn, summary, etc.)</li>
              <li><strong>Experience Bullets:</strong> Modify job descriptions and achievements</li>
              <li><strong>Education & Certifications:</strong> Update degrees, schools, dates</li>
              <li><strong>Projects:</strong> Edit project descriptions and details</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>Advanced Technical Skills Editing:</strong></p>
            <ul style="line-height: 1.8;">
              <li><strong>Edit Category Names:</strong> Click skill category names (e.g., "Programming Languages") to rename them</li>
              <li><strong>Edit Skills:</strong> Click skill values to add/remove/modify skills</li>
              <li><strong>Add Categories:</strong> Click "Add Category" button to create new skill groups</li>
              <li><strong>Remove Categories:</strong> Delete unwanted skill categories with one click</li>
            </ul>
            
            <p style="margin-top: 15px; padding: 12px; background: var(--success-bg); border-radius: 6px; border-left: 4px solid #10b981;">
              <strong>Auto-Save:</strong> Click "Save Changes" to persist all edits to the database. Changes are permanent and will reflect in future downloads!
            </p>
            
            <p style="margin-top: 15px; padding: 12px; background: var(--bg); border-radius: 6px;">
              <strong>Download Anytime:</strong> Both Resume and Job Description can be downloaded from the view modal or dashboard menu.
            </p>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px;">
            Additional Features
          </h3>
          <div style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-top: 10px;">
            
            <p><strong>Import/Export JSON:</strong> Reuse your resume data across applications</p>
            <ul style="line-height: 1.8;">
              <li><strong>Download JSON:</strong> Export your resume data to save locally</li>
              <li><strong>Upload JSON:</strong> Import previously saved data instantly</li>
              <li><strong>Version Control:</strong> Maintain different resume versions for different roles</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>Dashboard Search & Filter:</strong></p>
            <ul style="line-height: 1.8;">
              <li><strong>Search:</strong> Find resumes by company name or job title</li>
              <li><strong>Filter by Status:</strong> View All, Completed, Processing, or Failed jobs</li>
              <li><strong>Sort by Date:</strong> Most recent resumes appear first</li>
              <li><strong>Real-time Updates:</strong> Dashboard refreshes automatically</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>User Account Management:</strong></p>
            <ul style="line-height: 1.8;">
              <li><strong>Secure Login:</strong> Your resumes are private and secure</li>
              <li><strong>Multi-User:</strong> Each user has isolated resume history</li>
              <li><strong>Logout:</strong> End session securely anytime</li>
              <li><strong>Job Limits:</strong> Up to 2 concurrent generations per user</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>Customization:</strong></p>
            <ul style="line-height: 1.8;">
              <li><strong>Dark Mode:</strong> Toggle between light/dark themes</li>
              <li><strong>Smooth Animations:</strong> Polished UI with transitions</li>
              <li><strong>Responsive:</strong> Works on desktop, tablet, and mobile</li>
            </ul>
            
            <p style="margin-top: 20px;"><strong>Notifications & Feedback:</strong></p>
            <ul style="line-height: 1.8;">
              <li>‚úÖ <strong>Success Messages:</strong> Confirmation for all actions</li>
              <li>‚ùå <strong>Error Alerts:</strong> Clear explanations when issues occur</li>
              <li><strong>Progress Indicators:</strong> Visual feedback during generation</li>
              <li><strong>Status Badges:</strong> Color-coded job statuses</li>
            </ul>
          </div>
        </div>

        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-top: 30px; border: 2px solid var(--border);">
          <h3 style="color: var(--primary); margin-top: 0;">Important Notes</h3>
          <ul style="line-height: 1.8;">
            <li><strong>Generation Time:</strong> Expect 30-90 seconds per resume</li>
            <li><strong>Concurrent Limits:</strong> Maximum 2 active jobs per user (additional requests queue automatically)</li>
            <li><strong>Validation Required:</strong> Summary and Job Description must be 50+ characters</li>
            <li><strong>Changes Are Permanent:</strong> Edit mode saves directly to database - no undo!</li>
            <li><strong>Browser Required:</strong> Works best in Chrome, Firefox, Safari, or Edge</li>
            <li><strong>Private & Secure:</strong> Your data is isolated per user account</li>
          </ul>
        </div>

      </div>
    </div>
    <div class="view-modal-footer">
      <button class="view-modal-btn success" onclick="closeHelpModal()">Let's Start</button>
    </div>
  </div>
</div>

<header id="mainHeader" style="display: none; justify-content: space-between; align-items: center;">
  <h1>Resume Builder Pro</h1>
  <div id="menuActions">
    <button id="menuToggleBtn" onclick="toggleHeaderMenu()" style="font-size: 20px; padding: 8px 12px;">‚ò∞</button>
    <div id="headerDropdownMenu" class="header-dropdown-menu" style="display: none;">
      <div id="mobileUserInfo" style="display: none; padding: 12px 16px; border-bottom: 1px solid var(--border); margin-bottom: 4px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span id="mobileUserName" style="font-size: 14px; font-weight: 600; color: var(--text);"></span>
        </div>
      </div>
      <div id="mobileResumeActions" style="display: none;">
        <button onclick="saveResumeTemplate(); toggleHeaderMenu()">Save Resume</button>
        <button onclick="triggerResumeUpload(); toggleHeaderMenu()">Upload Resume</button>
        <button onclick="downloadJSON(); toggleHeaderMenu()">Download JSON</button>
        <button onclick="downloadWordDoc(); toggleHeaderMenu()">Download Word</button>
        <button onclick="clearAll(); toggleHeaderMenu()" style="color: #e74c3c;">Clear All</button>
        <div style="border-top: 1px solid var(--border); margin: 4px 0;"></div>
      </div>
      <button id="headerProfileBtn" onclick="openProfileModal(); toggleHeaderMenu()" style="display: none;">Profile</button>
      <button onclick="showHelpModal(); toggleHeaderMenu()">Help</button>
      <button id="headerTutorialBtn" onclick="showTutorialWelcome(); toggleHeaderMenu()" style="display: none;">Tutorial</button>
      <button id="headerToggleTheme" onclick="toggleThemeManual(); toggleHeaderMenu()">Night Mode</button>
      <button id="headerLogoutBtn" onclick="handleMainLogout()" style="display: none;">Logout</button>
    </div>
    <!-- Hidden original theme button to maintain functionality -->
    <button id="toggleTheme" style="display: none;">Dark Mode</button>
  </div>
</header>

<main>
  <!-- Login/Register Screen (shown first) -->
  <div id="authScreen" class="auth-screen">
    <!-- Left Column: Brand/Visual -->
    <div class="auth-brand">
      <div class="auth-brand-content">
        <div class="brand-logo">
          <h1>Resume Builder Pro</h1>
          <p class="brand-tagline">AI-Powered Resume Optimization</p>
        </div>
        
        <div class="brand-features">
          <div class="feature-item">
            <div class="feature-icon">üìä</div>
            <div class="feature-text">
              <h3>Smart Tracking</h3>
              <p>Track all your resume versions in one place</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">‚ú®</div>
            <div class="feature-text">
              <h3>AI Optimization</h3>
              <p>Tailor resumes to match job descriptions</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">‚¨áÔ∏è</div>
            <div class="feature-text">
              <h3>Instant Downloads</h3>
              <p>Export professional resumes anytime</p>
            </div>
          </div>
        </div>

        <div class="brand-stats">
          <div class="stat-item">
            <div class="stat-number">3K+</div>
            <div class="stat-label">Resumes Generated</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">95%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">24/7</div>
            <div class="stat-label">Available</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Form -->
    <div class="auth-form-column">
      <div class="auth-form-container">
        <div class="auth-header">
          <h2>Welcome</h2>
          <p>Enter your credentials to access your account</p>
        </div>

        <!-- Login Form -->
        <div id="mainLoginForm" class="auth-form active">
          <div class="form-group">
            <label>Email / Username</label>
            <input type="text" id="mainLoginUsername" placeholder="Enter your email or username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="mainLoginPassword" placeholder="Enter your password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handleMainLogin()">Sign In</button>
          
          <div style="text-align: center; margin-top: 12px;">
            <a href="#" onclick="switchMainAuthTab('reset'); return false;" style="font-size: 13px; color: var(--accent); text-decoration: none;">Forgot Password?</a>
          </div>
          
          <div class="auth-switch">
            <span>Don't have an account?</span>
            <a href="#" onclick="switchMainAuthTab('register'); return false;">Create account</a>
          </div>
        </div>

        <!-- Reset Password Form -->
        <div id="mainResetForm" class="auth-form">
          <div class="form-group">
            <label>Email / Username</label>
            <input type="text" id="mainResetUsername" placeholder="Enter your email or username">
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="mainResetNewPassword" placeholder="Enter new password (min 8 characters)">
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="mainResetConfirmPassword" placeholder="Confirm new password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handlePasswordReset()">Reset Password</button>
          
          <div class="auth-switch">
            <span>Remember your password?</span>
            <a href="#" onclick="switchMainAuthTab('login'); return false;">Sign in</a>
          </div>
        </div>

        <!-- Register Form -->
        <div id="mainRegisterForm" class="auth-form">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="mainRegisterFirstName" placeholder="Enter your first name">
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="mainRegisterLastName" placeholder="Enter your last name">
            </div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="mainRegisterUsername" placeholder="Enter your email address">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="mainRegisterPassword" placeholder="Choose a strong password" oninput="validatePasswordStrength()">
            <div id="passwordStrength" style="margin-top: 8px; font-size: 12px;"></div>
            <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-size: 12px; line-height: 1.4;">
              Must be 8+ characters with:<br>
              ‚Ä¢ Uppercase (A-Z) ‚Ä¢ Lowercase (a-z)<br>
              ‚Ä¢ Number (0-9) ‚Ä¢ Special char (!@#$%^&*)
            </small>
          </div>
          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="mainRegisterPasswordConfirm" placeholder="Confirm your password">
          </div>
          <button class="primary-btn" style="width: 100%; margin-top: 24px;" onclick="handleMainRegister()">Create Account</button>
          
          <div class="auth-switch">
            <span>Already have an account?</span>
            <a href="#" onclick="switchMainAuthTab('login'); return false;">Sign in</a>
          </div>
        </div>

        <div id="mainAuthMessage" style="margin-top: 20px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>
        
        <!-- Minimal Footer -->
        <div class="auth-footer-links">
          <a href="#">Privacy Policy</a>
          <span>¬∑</span>
          <a href="#">Terms of Service</a>
          <span>¬∑</span>
          <a href="#">Help Center</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div id="mainApp" style="display: none;">
    <div id="tabContainer">
      <nav id="sidebar">
        <button class="tab-btn active" id="tabResumeBtn" type="button">View Resume</button>
        <button class="tab-btn" id="tabEditJDBtn" type="button">Generate Resume</button>
        <button class="tab-btn" id="tabJobSearchBtn" type="button">Job Search</button>
        <button class="tab-btn" id="tabEmailWriterBtn" type="button">Email Writer</button>
        <button class="tab-btn" id="tabDashboardBtn" type="button">My Dashboard</button>
      </nav>

      <section id="tabContentArea">
      <div id="resumeFormContainer" class="active">
        <input type="file" id="uploadJSON" accept=".json" style="display: none;">
        <input type="file" id="uploadResume" accept=".pdf,.docx" style="display: none;">
        
        <!-- Resume Builder Header -->
        <div class="resume-builder-header">
          <div class="resume-builder-title">
            <h2>My Resume</h2>
            <p>Edit your resume information below</p>
          </div>
          <div class="resume-builder-actions">
            <button class="rb-action-btn" onclick="saveResumeTemplate()">
              Save
            </button>
            <button class="rb-action-btn" onclick="triggerResumeUpload()">
              Upload
            </button>
            <div class="rb-download-dropdown">
              <button class="rb-action-btn" onclick="toggleResumeDownloadMenu()">
                Download <span class="dropdown-arrow">‚ñæ</span>
              </button>
              <div id="resumeDownloadMenu" class="rb-dropdown-menu">
                <button onclick="downloadWordDoc(); toggleResumeDownloadMenu();">Word Document</button>
                <button onclick="downloadPDF(); toggleResumeDownloadMenu();">PDF Document</button>
                <button onclick="downloadJSON(); toggleResumeDownloadMenu();">JSON File</button>
              </div>
            </div>
            <button class="rb-action-btn danger" onclick="confirmClearAll()">
              Clear
            </button>
          </div>
        </div>

        <form id="resumeForm">
          <!-- Side Navigation & Content -->
          <div class="form-nav-container">
            <!-- Side Navigation -->
            <div class="form-nav">
              <button type="button" class="form-nav-btn active" onclick="showFormSection('basic')">
                <span class="nav-text">Basic Info</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('contact')">
                <span class="nav-text">Contact</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('skills')">
                <span class="nav-text">Skills</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('experience')">
                <span class="nav-text">Experience</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('education')">
                <span class="nav-text">Education</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('projects')">
                <span class="nav-text">Projects</span>
              </button>
              <button type="button" class="form-nav-btn" onclick="showFormSection('certifications')">
                <span class="nav-text">Certifications</span>
              </button>
            </div>

            <!-- Content Panels -->
            <div class="form-sections">
              <!-- Basic Information Section -->
              <div id="section-basic" class="form-section-panel active">
                <h3>Basic Information</h3>
                <div class="form-field">
                  <label>Full Name</label>
                  <input name="name" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-field">
                  <label>Professional Summary</label>
                  <textarea name="summary" rows="8" placeholder="Write a compelling summary of your professional background, key skills, and career objectives..."></textarea>
                </div>
              </div>

              <!-- Contact Information Section -->
              <div id="section-contact" class="form-section-panel">
                <h3>Contact Information</h3>
                <div class="entries-header">
                  <span class="entry-header-label">Label</span>
                  <span class="entry-header-label">Value</span>
                  <span class="entry-header-spacer"></span>
                </div>
                <div id="contactList">
                  <div class="contact-entry">
                    <input placeholder="e.g., Email, Phone, LinkedIn" class="contact-key" value="">
                    <input placeholder="Enter value" class="contact-value" value="">
                    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>
                  </div>
                </div>
                <button type="button" class="add-entry-btn" onclick="addContact()">
                  <span>+</span> Add Contact
                </button>
              </div>

              <!-- Technical Skills Section -->
              <div id="section-skills" class="form-section-panel">
                <h3>Technical Skills</h3>
                <div class="entries-header">
                  <span class="entry-header-label">Category</span>
                  <span class="entry-header-label">Skills</span>
                  <span class="entry-header-spacer"></span>
                </div>
                <div id="skillsList">
                  <div class="skill-entry">
                    <input placeholder="e.g., Languages, Frameworks" class="skill-key" value="">
                    <input placeholder="Skills (comma-separated)" class="skill-value" value="">
                    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>
                  </div>
                </div>
                <button type="button" class="add-entry-btn" onclick="addSkill()">
                  <span>+</span> Add Skill Category
                </button>
              </div>

              <!-- Experience Section -->
              <div id="section-experience" class="form-section-panel">
                <h3>Work Experience</h3>
                <div id="experienceList">
                  <div class="experience-entry">
                    <div class="experience-header-inputs">
                      <div class="input-with-label">
                        <label>Company</label>
                        <input placeholder="Company Name" class="exp-company" value="">
                      </div>
                      <div class="input-with-label">
                        <label>Job Title</label>
                        <input placeholder="Job Title" class="exp-role" value="">
                      </div>
                      <div class="input-with-label">
                        <label>Duration</label>
                        <input placeholder="e.g., Jan 2020 - Present" class="exp-period" value="">
                      </div>
                    </div>
                    <div class="experience-bullets">
                      <label>Key Achievements & Responsibilities</label>
                      <div class="bullets">
                        <div class="bullet-item">
                          <input placeholder="Describe an achievement or responsibility..." class="exp-point" value="">
                          <button type="button" class="bullet-remove-btn" onclick="this.parentElement.remove()">‚úï</button>
                        </div>
                      </div>
                      <button type="button" class="add-bullet-btn" onclick="addBullet(this)">+ Add Point</button>
                    </div>
                    <button type="button" class="remove-entry-btn" onclick="this.parentElement.remove()">Remove Experience</button>
                  </div>
                </div>
                <button type="button" class="add-entry-btn" onclick="addExperience()">
                  <span>+</span> Add Experience
                </button>
              </div>

              <!-- Education Section -->
              <div id="section-education" class="form-section-panel">
                <h3>Education</h3>
                <div id="educationList">
                  <div class="education-entry">
                    <div class="education-fields">
                      <div class="input-with-label">
                        <label>Degree</label>
                        <input placeholder="e.g., Bachelor of Science" class="edu-degree" value="">
                      </div>
                      <div class="input-with-label">
                        <label>Institution</label>
                        <input placeholder="e.g., University Name" class="edu-inst" value="">
                      </div>
                      <div class="input-with-label">
                        <label>Year</label>
                        <input placeholder="e.g., 2020" class="edu-year" value="">
                      </div>
                    </div>
                    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>
                  </div>
                </div>
                <button type="button" class="add-entry-btn" onclick="addEducation()">
                  <span>+</span> Add Education
                </button>
              </div>

              <!-- Projects Section -->
              <div id="section-projects" class="form-section-panel">
                <h3>Projects</h3>
                <div id="projectsList"></div>
                <button type="button" class="add-entry-btn" onclick="addProject()">
                  <span>+</span> Add Project
                </button>
              </div>

              <!-- Certifications Section -->
              <div id="section-certifications" class="form-section-panel">
                <h3>Certifications</h3>
                <div id="certificationsList"></div>
                <button type="button" class="add-entry-btn" onclick="addCertification()">
                  <span>+</span> Add Certification
                </button>
              </div>
            </div>
          </div>
        </form>

        <!-- Scroll to Top Button -->
        <button id="scrollToTop" onclick="scrollToTop()">‚Üë</button>
        
        <!-- Status Modal Popup -->
        <div id="statusModal" class="modal" style="display:none;z-index:3000;">
          <div class="modal-content" style="width:280px;min-height:80px;padding:24px;">
            <span id="statusText" style="font-weight:600; color:var(--accent); font-size:15px;"></span>
          </div>
        </div>
        
        <!-- Unsaved Changes Confirmation Modal -->
        <div id="unsavedChangesModal" class="modal" style="display:none;z-index:4000;align-items:center;justify-content:center;">
          <div class="modal-content" style="width:400px;max-width:90%;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);background:white;">
            <h3 style="margin:0 0 8px 0;color:#333;font-size:18px;font-weight:600;text-align:center;">Unsaved Changes</h3>
            <p style="margin:0 0 20px 0;color:#666;font-size:14px;line-height:1.4;text-align:center;">Would you like to save before switching tabs?</p>
            <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
              <button id="cancelTabSwitch" style="padding:8px 16px;border:1px solid #ddd;background:white;color:#333;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">Cancel</button>
              <button id="discardChanges" style="padding:8px 16px;border:1px solid #e74c3c;background:white;color:#e74c3c;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#e74c3c';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#e74c3c'">Don't Save</button>
              <button id="saveAndSwitch" style="padding:8px 16px;border:none;background:#5b7cfa;color:white;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Save</button>
            </div>
          </div>
        </div>

        <!-- Custom Confirm Modal -->
        <div id="customConfirmModal" class="modal" style="display:none;z-index:9999;align-items:center;justify-content:center;" onclick="console.log('[Modal] Backdrop clicked')">
          <div class="modal-content" style="width:400px;max-width:90%;min-height:150px;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);background:#ffffff !important;position:relative;z-index:10000;" onclick="event.stopPropagation(); console.log('[Modal] Content clicked')">
            <h3 id="confirmModalTitle" style="margin:0 0 8px 0;color:#333 !important;font-size:18px;font-weight:600;text-align:center;">Confirm Action</h3>
            <p id="confirmModalMessage" style="margin:0 0 20px 0;color:#666 !important;font-size:14px;line-height:1.4;text-align:center;">Are you sure?</p>
            <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
              <button id="confirmModalCancel" style="padding:8px 20px;border:1px solid #ddd;background:#ffffff !important;color:#333 !important;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;position:relative;z-index:10001;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#ffffff'" onclick="console.log('[Modal] Cancel button inline click')">Cancel</button>
              <button id="confirmModalOk" style="padding:8px 20px;border:none;background:#e74c3c !important;color:#ffffff !important;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;position:relative;z-index:10001;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" onclick="console.log('[Modal] OK button inline click')">OK</button>
            </div>
          </div>
        </div>
      </div>
      </div>

      <div id="jobDescTabPanel">
        <div class="jd-form-container">
          <!-- Compact Top Section with Input Fields -->
          <div class="jd-form-header">
            <div class="jd-input-row">
              <div class="jd-input-col">
                <label for="companyNameJD"><b>Company Name *</b></label>
                <input id="companyNameJD" name="companyNameJD" placeholder="e.g., Microsoft, Google" type="text" required>
              </div>
              <div class="jd-input-col">
                <label for="jobTitleJD"><b>Job Title *</b></label>
                <input id="jobTitleJD" name="jobTitleJD" placeholder="e.g., Software Engineer" type="text" required>
              </div>
            </div>
            
            <!-- Job Link Input Row -->
            <div class="jd-input-row">
              <div class="jd-input-col" style="grid-column: 1 / -1;">
                <label for="jobLinkJD"><b>Job Link</b> <span style="color: var(--text-secondary); font-weight: normal;">(optional)</span></label>
                <input id="jobLinkJD" name="jobLinkJD" placeholder="https://company.com/careers/job-id or paste job posting URL" type="url">
              </div>
            </div>
            
            <!-- Compact Mode Selection with Generate Button -->
            <div class="jd-mode-generate-row">
              <div class="jd-mode-section">
                <label class="mode-label">Mode:</label>
                <div class="mode-options">
                  <label class="mode-option">
                    <input type="radio" name="resumeMode" value="resume_jd" onchange="updateModeDescription()">
                    <span>Resume + JD</span>
                  </label>
                  <label class="mode-option">
                    <input type="radio" name="resumeMode" value="complete_jd" checked onchange="updateModeDescription()">
                    <span>Complete JD</span>
                  </label>
                </div>
                <p id="modeDescription" class="mode-description">
                  Creates a complete resume from scratch using only the job description
                </p>
                
                <!-- Optional Keyword Review Checkbox -->
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="enableKeywordReview" name="enableKeywordReview" style="cursor: pointer; width: 16px; height: 16px; accent-color: var(--primary);">
                  <label for="enableKeywordReview" style="cursor: pointer; font-size: 13px; color: var(--text-secondary); margin: 0; user-select: none;">
                    Review keywords before generation (optional)
                  </label>
                </div>
              </div>
              
              <button id="generateJDResumeBtn" type="button" class="generate-btn-inline">
                <span class="btn-icon"></span>
                <span class="btn-text">Generate Resume</span>
              </button>
            </div>
          </div>
          
          <!-- Job Description Text Area - Takes Most Space -->
          <div class="jd-textarea-container">
            <label for="jobDescriptionTab"><b>Job Description *</b></label>
            <textarea id="jobDescriptionTab" placeholder="Paste the job description here...&#10;&#10;Include:&#10;‚Ä¢ Job responsibilities&#10;‚Ä¢ Required skills & qualifications&#10;‚Ä¢ Nice-to-have skills&#10;‚Ä¢ Company information"></textarea>
          </div>
        </div>
      </div>

      <!-- Job Search Tab Panel -->
      <div id="jobSearchTabPanel" style="display: none;">
        <div class="job-search-container">
          <div style="text-align: center; margin-bottom: 16px;">
            <h2 style="margin-bottom: 8px;">Find Your Next Job</h2>
            <p style="color: var(--text-secondary); margin: 0;">Search thousands of jobs from top companies</p>
          </div>
          
          <!-- All-in-One Search Row -->
          <div class="search-card" style="background: var(--card-bg); border-radius: 12px; padding: 16px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            
            <div class="search-field-row">
              
              <!-- Job Title -->
              <div class="search-field search-field-xl">
                <label>Job Title *</label>
                <input type="text" id="jobSearchTitle" placeholder="e.g., Data Engineer" required
                  onfocus="this.style.borderColor='var(--primary)'" onblur="setTimeout(() => this.style.borderColor='var(--border)', 200)">
                <div class="job-title-suggestions" id="jobTitleSuggestions" style="display: none;"></div>
              </div>
              
              <!-- Location -->
              <div class="search-field search-field-lg">
                <label>Location</label>
                <input type="text" id="jobSearchLocationCustom" placeholder="City or 'remote'" 
                  onfocus="this.style.borderColor='var(--primary)'; showLocationSuggestions(this.value)" onblur="setTimeout(() => this.style.borderColor='var(--border)', 200)"
                  oninput="showLocationSuggestions(this.value)">
                <div class="location-suggestions" id="locationSuggestions" style="display: none;"></div>
              </div>
              
              <!-- Job Type -->
              <div class="search-field search-field-md">
                <label>Job Type</label>
                <select id="jobTypeDisplay">
                  <option value="FULLTIME,PARTTIME,CONTRACTOR,remote">All</option>
                  <option value="FULLTIME">Full-time</option>
                  <option value="PARTTIME">Part-time</option>
                  <option value="CONTRACTOR">Contract</option>
                  <option value="remote">Remote Only</option>
                </select>
              </div>
              
              <!-- Date Posted -->
              <div class="search-field search-field-sm">
                <label>Date Posted</label>
                <select id="jobSearchDate">
                  <option value="all">Any Time</option>
                  <option value="today">Today</option>
                  <option value="3days">Last 3 Days</option>
                  <option value="week" selected>This Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
              
              <!-- API Source -->
              <div class="search-field search-field-md">
                <label>Source</label>
                <select id="jobSearchSource">
                  <option value="jsearch">All Jobs</option>
                  <option value="workday">Workday</option>
                  <option value="lever">Lever</option>
                  <option value="icims">iCIMS</option>
                  <option value="bamboohr">BambooHR</option>
                  <option value="greenhouse">Greenhouse</option>
                </select>
              </div>
              
              <!-- Search Button -->
              <div class="search-field search-field-auto">
                <button id="searchJobsBtn" class="primary-btn" style="padding: 10px 24px; font-size: 14px; font-weight: 600; border-radius: 6px; white-space: nowrap; height: 42px;">
                  Search
                </button>
              </div>
              
            </div>
            
            <!-- Greenhouse Companies Button (shown when greenhouse selected) -->
            <div id="greenhouseToggleRow" style="display: none; margin-top: 12px; text-align: center;">
              <button id="showCompanySelectionBtn" style="padding: 8px 20px; background: var(--card-bg); border: 2px solid var(--primary); color: var(--primary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--primary)'; this.style.color='white'" onmouseout="this.style.background='var(--card-bg)'; this.style.color='var(--primary)'">
                Select Companies (<span id="selectedCompanyCount">20</span>)
              </button>
            </div>

            <!-- Hidden elements for JavaScript compatibility -->
            <div style="display: none;">
              <input type="checkbox" id="typeFullTime" value="FULLTIME" checked>
              <input type="checkbox" id="typePartTime" value="PARTTIME">
              <input type="checkbox" id="typeContract" value="CONTRACTOR">
              <input type="checkbox" id="typeIntern" value="INTERN">
              <select id="jobExperienceLevel"><option value="" selected>Any Experience</option></select>
              <input type="number" id="salaryMin">
              <input type="number" id="salaryMax">
              <select id="salaryFrequency"><option value="yearly" selected>Yearly</option></select>
              <select id="jobSearchMaxResults"><option value="20" selected>20</option></select>
              <select id="jobSearchSort"><option value="relevance" selected>relevance</option></select>
            </div>
          </div>

          <!-- Greenhouse Company Selection (shows when greenhouse source is selected) -->
          <div id="greenhouseCompanySection" style="display: none; background: linear-gradient(135deg, var(--primary-light, #f0f8ff) 0%, var(--card-bg) 100%); border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 2px solid var(--primary); box-shadow: 0 4px 16px rgba(79, 70, 229, 0.1);">
            <div style="text-align: center; margin-bottom: 20px;">
              <h3 style="margin-bottom: 8px; color: var(--primary); font-size: 20px;">Select Greenhouse Companies</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">Choose which companies to search - All job type filters above will apply to these searches</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 12px; margin-bottom: 20px;">
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="databricks" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Databricks
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="stripe" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Stripe
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="snowflake" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Snowflake
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="nvidia" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> NVIDIA
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="discord" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Discord
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="figma" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Figma
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="notion" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Notion
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="coinbase" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Coinbase
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="airbnb" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Airbnb
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="uber" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Uber
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="lyft" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Lyft
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="dropbox" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Dropbox
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="reddit" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Reddit
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="robinhood" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Robinhood
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="twilio" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Twilio
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="atlassian" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Atlassian
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="gitlab" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> GitLab
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="cloudflare" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Cloudflare
              </label>
              <label style="display: flex; align-items: center; padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--bg)'; this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='var(--card-bg)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                <input type="checkbox" value="vercel" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"> Vercel
              </label>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
              <button onclick="selectAllGreenhouse()" class="secondary-btn" style="padding: 10px 20px; font-size: 14px; border-radius: 8px;">‚úÖ Select All</button>
              <button onclick="clearAllGreenhouse()" class="secondary-btn" style="padding: 10px 20px; font-size: 14px; border-radius: 8px;">‚ùå Clear All</button>
            </div>
          </div>
          
          <!-- Loading State -->
          <div id="jobSearchLoading" style="display: none; text-align: center; margin: 20px 0;">
            <div class="spinner"></div>
            <p>Searching for jobs...</p>
          </div>
          
          <!-- Results Container -->
          <div id="jobSearchResults" class="job-results">
            <!-- Results will be populated here -->
          </div>
          
          <!-- Cache Stats Section (hidden by default) -->
          <div class="cache-stats-section" style="margin-top: 30px;">
            <button id="viewCacheStatsBtn" class="secondary-btn" style="display: none;">
              View Cache Statistics
            </button>
            <div id="cacheStatsDisplay" style="display: none; margin-top: 20px; padding: 20px; background: var(--card); border-radius: var(--radius-lg);"></div>
          </div>
        </div>
      </div>

      <!-- Email Writer Tab Panel -->
      <div id="emailWriterTabPanel" style="display: none;">
        <div class="email-writer-container">
          <div class="email-header" style="text-align: center; margin-bottom: 28px;">
            <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">Email Writer</h2>
            <p style="color: var(--text-secondary); margin: 0; font-size: 15px;">Generate professional emails for any career situation</p>
          </div>

          <!-- Email Mode Selector -->
          <div class="email-mode-selector">
            <select id="emailTemplateSelector" onchange="handleEmailTemplateChange(this.value)" class="email-template-select">
              <option value="">Quick Templates</option>
              <option value="cover_letter">Cover Letter</option>
              <option value="job_application">Job Application</option>
              <option value="reply">Reply to Recruiter</option>
              <option value="followup">Follow-up</option>
              <option value="thankyou">Thank You</option>
              <option value="networking">Networking</option>
              <option value="salary_negotiation">Salary Negotiation</option>
              <option value="resignation">Resignation</option>
              <option value="referral_request">Request Referral</option>
              <option value="decline_offer">Decline Offer</option>
              <option value="feedback_request">Request Feedback</option>
              <option value="interview_scheduling">Schedule Interview</option>
            </select>
            
            <button class="email-custom-btn" onclick="showCustomEmailMode()">
              Custom Email
            </button>
          </div>

          <!-- Email Input Area -->
          <div id="emailInputArea">
            <!-- Form will be dynamically rendered here -->
          </div>

          <!-- Email Output Area -->
          <div id="emailOutputArea">
            <!-- Generated email will be displayed here -->
          </div>

          <!-- Email History -->
          <div class="email-history-section">
            <h3>
              <span>Recent Emails</span>
              <span class="subtitle">(Session only)</span>
            </h3>
            <div id="emailHistoryList" class="email-history-list">
              <!-- History items will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Tab Panel -->
      <div id="dashboardTabPanel">
        
        <div id="dashboardMessage" style="margin-bottom: 20px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>

        <!-- Stats Cards -->
        <div id="statsCards" class="stats-grid">
          <!-- Stats will be loaded here -->
        </div>

        <!-- Resume History Table -->
        <div class="resume-table-container">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 24px 16px 24px;">
            <div>
              <h3 style="margin: 0; padding: 0;">My Resumes</h3>
              <span id="resultCount" style="font-size: 13px; color: var(--text-secondary); display: block; margin-top: 4px;"></span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 13px; color: var(--text-secondary);">Show:</span>
              <select id="pageSizeSelect" onchange="changePageSize()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer;">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
          
          <!-- Filter Section -->
          <div style="padding: 0 24px 16px 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="filterCompany" placeholder="Filter by Company" 
              oninput="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; flex: 1; min-width: 150px;">
            
            <input type="text" id="filterJobTitle" placeholder="Filter by Job Title" 
              oninput="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; flex: 1; min-width: 150px;">
            
            <select id="filterStatus" onchange="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer;">
              <option value="">All Status</option>
              <option value="completed">Completed</option>
              <option value="processing">Processing</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
            </select>
            
            <select id="filterDate" onchange="filterDashboardTable()" 
              style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer;">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="3months">Last 3 Months</option>
              <option value="6months">Last 6 Months</option>
              <option value="year">This Year</option>
            </select>
            
            <button onclick="clearDashboardFilters()" 
              style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: 13px; cursor: pointer; white-space: nowrap;">
              ‚úï Clear Filters
            </button>
          </div>
          
          <div class="resume-table-wrapper">
            <table class="resume-table" id="resumeHistoryTable">
              <thead>
                <tr>
                  <th style="padding: 12px 16px;">Company</th>
                  <th style="padding: 12px 16px;">Job Title</th>
                  <th style="padding: 12px 16px;">Status</th>
                  <th style="padding: 12px 16px;">Date</th>
                  <th style="padding: 12px 16px; text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="resumeHistoryBody">
                <!-- Resume rows will be loaded here -->
              </tbody>
            </table>
          </div>
          
          <!-- Mobile Cards View (hidden on desktop) -->
          <div class="mobile-resume-cards" id="mobileResumeCards" style="display: none;">
            <!-- Mobile cards will be rendered here -->
          </div>
          
          <div class="pagination-container" id="paginationContainer">
            <!-- Pagination will be loaded here -->
          </div>
        </div>
      </div>

    </section>
  </div>
  </div> <!-- Close mainApp -->
</main>

<!-- Processing Banner -->
<div id="processingBanner">
  <div class="banner-header">
    <div class="banner-title">
      <div class="spinner-small"></div>
      <span id="bannerCount">Processing resumes...</span>
    </div>
    <button class="close-banner" onclick="closeProcessingBanner()" title="Minimize">√ó</button>
  </div>
  <div class="requests-list" id="requestsList">
    <!-- Request items will be added here dynamically -->
  </div>
</div>

<!-- ===== ABOUT MODAL ===== -->
<div id="aboutModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAbout()">√ó</span>
    <h3>About Resume Builder Pro</h3>
    <p>Created by Sushmitha for generating professional Word resumes with FastAPI backend integration.</p>
    <p>Version: 1.0.0</p>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer id="mainFooter" style="display: none;">
  <!-- FAQ SECTION (collapsible) -->
  <section class="faq-section" id="faqSection">
    <div class="faq-header">
      <h2>Frequently Asked Questions</h2>
      <button class="faq-close" onclick="toggleFAQSection()">‚úï</button>
    </div>
    
    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How does Resume Builder Pro work?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Resume Builder Pro uses AI to tailor your resume to specific job descriptions. Fill in your resume details, paste a job description, and our AI will analyze and optimize your resume content to match the job requirements using advanced LLM technology.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What's the difference between "Complete JD" and "Resume + JD" modes?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        <strong>Complete JD Mode:</strong> Generates brand new content from scratch using the job description, preserving only company names, dates, and titles. Best for maximum ATS alignment.<br><br>
        <strong>Resume + JD Mode:</strong> Makes targeted edits to your existing resume content while keeping most of your original writing. Best when you have a strong resume that needs minor adjustments.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How many resumes can I generate at once?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        You can generate up to 4 resumes concurrently! Just fill in different job descriptions and click "Generate Resume" multiple times. The processing banner in the top-right corner shows all active requests.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>Can I save and reuse my resume data?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Yes! Use the floating "Download JSON" button to save your resume data as a JSON file. Later, use "Upload JSON" to reload all your information instantly. This lets you maintain multiple resume versions for different roles.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What format is the generated resume?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Resumes are generated as professional Microsoft Word (.docx) files with proper formatting, including clickable hyperlinks for emails and URLs in the contact section. Download from the "generated_resumes" folder.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How does the AI optimize my resume?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        The AI analyzes the job description to extract keywords, required skills, and responsibilities. It then rewrites your Summary, Skills, and Experience sections to align with these requirements while maintaining truthfulness. Each experience role gets 6-8 optimized bullet points with measurable impacts.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>What LLM provider is used?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Currently configured to use Google Gemini (gemini-2.5-flash) via the Google Generative AI API. The system is provider-agnostic and can be configured to use OpenAI or other LLM providers through the .env file.
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>How do I clear all my data?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Click the floating "Clear All" button (üßπ) at the bottom right. This will reset all fields in both the Resume and Job Description tabs. Make sure to download your JSON first if you want to save your data!
      </div>
    </div>

    <div class="faq-item">
      <button class="faq-question" onclick="toggleFAQ(this)">
        <span>Is my information private?</span>
        <span class="faq-icon">‚ñº</span>
      </button>
      <div class="faq-answer">
        Yes, we take your privacy seriously. Your data is never shared, and all resume content is processed securely. We don't store any personal information on our servers.
      </div>
    </div>
  </section>

  <div class="footer-content">
    <div class="footer-about">
      <h3>Resume Builder Pro</h3>
      <p>Create stunning, professional resumes in minutes. Our intuitive platform helps you showcase your skills and experience with beautifully designed templates.</p>
      <a href="#" onclick="openAbout(); return false;">Learn More ‚Üí</a>
      <div class="social-links">
        <a href="https://linkedin.com" target="_blank" title="LinkedIn">üíº</a>
        <a href="https://github.com" target="_blank" title="GitHub">üêô</a>
        <a href="https://twitter.com" target="_blank" title="Twitter">üê¶</a>
        <a href="mailto:support@resumebuilder.pro" title="Email">üìß</a>
      </div>
    </div>

    <div class="footer-section">
      <h4>Product</h4>
      <ul class="footer-links">
        <li><a href="#" onclick="document.querySelector('.dropdown-btn').click(); return false;">Templates</a></li>
        <li><a href="#" onclick="switchTab('resume'); return false;">View Resume</a></li>
        <li><a href="#" onclick="switchTab('jd'); return false;">Generate Resume</a></li>
        <li><a href="#" onclick="toggleFAQSection(); return false;">FAQ</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Legal</h4>
      <ul class="footer-links">
        <li><a href="#privacy">Privacy Policy</a></li>
        <li><a href="#terms">Terms of Service</a></li>
        <li><a href="#cookies">Cookie Policy</a></li>
        <li><a href="#license">License</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Support</h4>
      <ul class="footer-links">
        <li><a href="#contact">Contact Us</a></li>
        <li><a href="#help">Help Center</a></li>
        <li><a href="#feedback">Send Feedback</a></li>
        <li><a href="#report">Report Issue</a></li>
      </ul>
    </div>
  </div>

  <div class="footer-bottom">
    <p>¬© 2025 Resume Builder Pro. All Rights Reserved.</p>
  </div>
</footer>

<script>
  /* ---------- REQUEST TRACKING ---------- */
  // Track active resume generation requests
  const activeRequests = new Map();
  
  /* ---------- API & DASHBOARD CONFIG (declared early to avoid TDZ) ---------- */
  const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:5001'
    : '';
  let dashboardCredentials = null;
  let dashboardPollIntervals = {};
  let currentUsername = null;
  let currentPassword = null;
  let dashboardPageSize = 10;
  let currentPage = 1;
  let totalJobs = 0;
  let allDashboardJobs = [];
  
  /* ---------- THEME TOGGLE ---------- */
  function toggleThemeManual() {
    const dark = document.body.getAttribute('data-theme') === 'dark';
    const newTheme = dark ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Update button texts
    const themeBtn = document.getElementById('toggleTheme');
    const headerToggleTheme = document.getElementById('headerToggleTheme');
    if (themeBtn) {
      themeBtn.textContent = dark ? 'Night Mode' : 'Day Mode';
    }
    if (headerToggleTheme) {
      headerToggleTheme.textContent = dark ? 'Night Mode' : 'Day Mode';
    }
  }
  
  /* ---------- CHANGE TRACKING ---------- */
  let formHasChanges = false;
  let initialFormState = null;
  
  // Queue for keyword review requests
  const keywordReviewQueue = [];
  let isModalOpen = false;

  // Ensure tab panels live under #tabContentArea even if the browser reparses invalid markup
  window.addEventListener('DOMContentLoaded', () => {
    const tabContentArea = document.getElementById('tabContentArea');
    if (!tabContentArea) return;
    ['resumeFormContainer','jobDescTabPanel','jobSearchTabPanel','emailWriterTabPanel','dashboardTabPanel'].forEach(id => {
      const el = document.getElementById(id);
      if (el && !tabContentArea.contains(el)) {
        tabContentArea.appendChild(el);
        try { console.log(`[DOM FIX] Moved ${id} under #tabContentArea`); } catch {}
      }
    });
  });

  function generateRequestId() {
    return `req_${Date.now()}_${++requestIdCounter}`;
  }

  function updateBannerCount() {
    const banner = document.getElementById('processingBanner');
    const bannerCount = document.getElementById('bannerCount');
    const activeCount = Array.from(activeRequests.values()).filter(r => r.status === 'processing').length;
    
    console.log('[DEBUG] Updating banner count. Active:', activeCount, 'Total:', activeRequests.size);
    
    if (activeCount > 0) {
      banner.classList.add('active');
      bannerCount.textContent = activeCount === 1 
        ? 'Processing 1 resume...' 
        : `Processing ${activeCount} resumes...`;
    } else {
      // Keep banner open for 3 seconds to show completed items
      setTimeout(() => {
        const stillActive = Array.from(activeRequests.values()).filter(r => r.status === 'processing').length;
        if (stillActive === 0) {
          banner.classList.remove('active');
        }
      }, 3000);
    }
  }

  function addRequestToUI(requestId, companyName) {
    console.log('[DEBUG] Adding request to UI:', requestId, companyName);
    
    const requestsList = document.getElementById('requestsList');
    if (!requestsList) {
      console.error('[DEBUG] requestsList element not found!');
      return;
    }
    
    const requestItem = document.createElement('div');
    requestItem.className = 'request-item';
    requestItem.id = `request_${requestId}`;
    requestItem.innerHTML = `
      <div class="item-icon">
        <div class="spinner-small"></div>
      </div>
      <div class="item-text">
        <div class="item-company">${companyName || 'Unknown Company'}</div>
        <div class="item-progress" style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">Starting...</div>
      </div>
    `;
    requestsList.appendChild(requestItem);
    
    console.log('[DEBUG] Request item added to DOM, total items:', requestsList.children.length);
    
    activeRequests.set(requestId, {
      company: companyName,
      status: 'processing',
      element: requestItem
    });
    
    console.log('[DEBUG] Active requests count:', activeRequests.size);
    
    updateBannerCount();
  }

  function updateRequestProgress(requestId, progress, message) {
    const request = activeRequests.get(requestId);
    if (request && request.status === 'processing') {
      const progressDiv = request.element.querySelector('.item-progress');
      if (progressDiv) {
        progressDiv.textContent = `${progress}% - ${message || 'Processing...'}`;
        console.log('[BANNER UPDATE] Updated progress for', requestId, ':', progress, '%', message);
      }
    }
  }

  function markRequestComplete(requestId, fileName) {
    const request = activeRequests.get(requestId);
    if (request) {
      request.status = 'completed';
      request.element.classList.add('completed');
      request.element.innerHTML = `
        <div class="item-icon">‚úì</div>
        <div class="item-text">
          <div class="item-company">${request.company}</div>
          <div class="item-progress" style="color: var(--success);">Completed - ${fileName}</div>
        </div>
      `;
      
      updateBannerCount();
      
      // Remove completed item after 5 seconds
      setTimeout(() => {
        request.element.style.opacity = '0';
        setTimeout(() => {
          request.element.remove();
          activeRequests.delete(requestId);
          updateBannerCount();
        }, 300);
      }, 5000);
    }
  }

  function markRequestFailed(requestId, error) {
    const request = activeRequests.get(requestId);
    if (request) {
      request.status = 'failed';
      request.element.classList.add('failed');
      request.element.innerHTML = `
        <div class="item-icon" style="color: var(--danger);">‚úó</div>
        <div class="item-text">
          <div class="item-company" style="color: var(--danger);">${request.company}</div>
          <div class="item-progress" style="color: var(--danger);">Failed</div>
        </div>
      `;
      
      updateBannerCount();
      
      // Remove failed item after 8 seconds
      setTimeout(() => {
        request.element.style.opacity = '0';
        setTimeout(() => {
          request.element.remove();
          activeRequests.delete(requestId);
          updateBannerCount();
        }, 300);
      }, 8000);
    }
  }

  function closeProcessingBanner() {
    const banner = document.getElementById('processingBanner');
    banner.classList.remove('active');
  }

  // Make processing banner draggable
  (function initDraggableBanner() {
    const banner = document.getElementById('processingBanner');
    const header = banner.querySelector('.banner-header');
    
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    header.style.cursor = 'move';
    header.style.userSelect = 'none';

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
      if (e.target.classList.contains('close-banner')) return;
      
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;

      if (e.target === header || header.contains(e.target)) {
        isDragging = true;
      }
    }

    function drag(e) {
      if (isDragging) {
        e.preventDefault();
        
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, banner);
      }
    }

    function dragEnd(e) {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;
    }

    function setTranslate(xPos, yPos, el) {
      el.style.transform = `translate(${xPos}px, ${yPos}px)`;
    }
  })();

  // Alias for backwards compatibility
  function addRequestToBanner(requestId, companyName) {
    return addRequestToUI(requestId, companyName);
  }

  /* ---------- FORM SECTION NAVIGATION ---------- */
  
  // New accordion toggle function
  function toggleResumeSection(sectionId) {
    const body = document.getElementById(`body-${sectionId}`);
    const card = document.getElementById(`card-${sectionId}`);
    const header = card.querySelector('.section-card-header');
    const icon = header.querySelector('.section-toggle-icon');
    
    if (body.classList.contains('active')) {
      // Close this section
      body.classList.remove('active');
      icon.style.transform = 'rotate(0deg)';
    } else {
      // Open this section
      body.classList.add('active');
      icon.style.transform = 'rotate(180deg)';
    }
  }
  
  // Function to expand all sections
  function expandAllSections() {
    document.querySelectorAll('.section-card-body').forEach(body => {
      body.classList.add('active');
    });
    document.querySelectorAll('.section-toggle-icon').forEach(icon => {
      icon.style.transform = 'rotate(180deg)';
    });
  }
  
  // Function to collapse all sections
  function collapseAllSections() {
    document.querySelectorAll('.section-card-body').forEach(body => {
      body.classList.remove('active');
    });
    document.querySelectorAll('.section-toggle-icon').forEach(icon => {
      icon.style.transform = 'rotate(0deg)';
    });
  }
  
  // Scroll to top function
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  // Show/hide scroll to top button
  window.addEventListener('scroll', function() {
    const scrollBtn = document.getElementById('scrollToTop');
    if (scrollBtn) {
      if (window.scrollY > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    }
  });
  
  // Legacy function for old nav
  function showFormSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.form-section-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    
    // Remove active from all nav buttons
    document.querySelectorAll('.form-nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(`section-${sectionId}`);
    if (section) {
      section.classList.add('active');
    }
    
    // Mark button as active
    event.target.closest('.form-nav-btn').classList.add('active');
  }

  /* ---------- CHANGE TRACKING SETUP ---------- */
  let isInitialLoad = true;
  
  function setupChangeTracking() {
    const form = document.getElementById('resumeForm');
    if (!form) return;
    
    // Track changes on all form inputs (only after initial load)
    form.addEventListener('input', function(e) {
      if (e.target.matches('input, textarea, select') && !isInitialLoad) {
        formHasChanges = true;
      }
    });
    
    // Track changes when adding/removing dynamic entries (only after initial load)
    const observer = new MutationObserver(function(mutations) {
      if (!isInitialLoad) {
        formHasChanges = true;
      }
    });
    
    // Observe changes in dynamic lists
    const listsToObserve = ['contactList', 'skillsList', 'experienceList', 'educationList', 'projectsList', 'certificationsList'];
    listsToObserve.forEach(listId => {
      const list = document.getElementById(listId);
      if (list) {
        observer.observe(list, { childList: true, subtree: true });
      }
    });
  }
  
  function resetChangeTracking() {
    formHasChanges = false;
  }

  /* ---------- SCROLL TO TOP ---------- */
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Show/hide scroll button based on scroll position
  window.addEventListener('scroll', () => {
    const scrollBtn = document.getElementById('scrollToTop');
    if (window.pageYOffset > 300) {
      scrollBtn.classList.add('visible');
    } else {
      scrollBtn.classList.remove('visible');
    }
  });

  /* ---------- THEME ---------- */
  // Theme toggle is handled in main.js

  /* ---------- FORM BUILDERS ---------- */
  function addContact(k='',v=''){
    const d=document.createElement('div');
    d.className='contact-entry';
    // Determine placeholder based on key
    let valuePlaceholder = 'Enter value';
    if (k === 'Phone') valuePlaceholder = '+1 999 999 9999';
    else if (k === 'Email') valuePlaceholder = 'abc@mail.com';
    else if (k === 'LinkedIn') valuePlaceholder = 'https://linkedin.com/in/yourprofile';
    else if (k === 'Portfolio') valuePlaceholder = 'https://yourportfolio.com';
    else if (v) valuePlaceholder = 'URL or value';

    d.innerHTML=`<input placeholder="e.g., Email, Phone, LinkedIn" class="contact-key" value="${k}" ${k ? 'readonly' : ''}>
    <input placeholder="${valuePlaceholder}" class="contact-value" value="${v}">
    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    document.getElementById('contactList').appendChild(d);
  }
  
  function addSkill(k='',v=''){
    const d=document.createElement('div');
    d.className='skill-entry';
    d.innerHTML=`<input placeholder="e.g., Languages, Frameworks" class="skill-key" value="${k}">
    <input placeholder="Skills (comma-separated)" class="skill-value" value="${v}">
    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    document.getElementById('skillsList').appendChild(d);
  }
  
  function addExperience(exp=null){
    const d=document.createElement('div');
    d.className='experience-entry';
    d.innerHTML=`<div class="experience-header-inputs">
      <div class="input-with-label">
        <label>Company</label>
        <input placeholder="Company Name" class="exp-company" value="${exp?.company||''}">
      </div>
      <div class="input-with-label">
        <label>Job Title</label>
        <input placeholder="Job Title" class="exp-role" value="${exp?.role||''}">
      </div>
      <div class="input-with-label">
        <label>Duration</label>
        <input placeholder="e.g., Jan 2020 - Present" class="exp-period" value="${exp?.period||''}">
      </div>
    </div>
    <div class="experience-bullets">
      <label>Key Achievements & Responsibilities</label>
      <div class="bullets"></div>
      <button type="button" class="add-bullet-btn" onclick="addBullet(this)">+ Add Point</button>
    </div>
    <button type="button" class="remove-entry-btn" onclick="this.parentElement.remove()">Remove Experience</button>`;
    document.getElementById('experienceList').appendChild(d);
    const bulletsDiv = d.querySelector('.bullets');
    let pts = Array.isArray(exp?.points) ? exp.points : [''];
    if (!pts.length) pts = [''];
    pts.forEach(p => addBullet(bulletsDiv, p));
  }
  
  function addBullet(btn,text=''){
    const b=document.createElement('div');
    b.className='bullet-item';
    b.innerHTML=`<input placeholder="Describe an achievement or responsibility..." class="exp-point" value="${text||''}">
    <button type="button" class="bullet-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    if (btn && btn.classList && btn.classList.contains('bullets')) {
      btn.appendChild(b);
    } else if (btn && btn.parentElement && btn.parentElement.querySelector('.bullets')) {
      btn.parentElement.querySelector('.bullets').appendChild(b);
    }
  }
  
  function addEducation(e=null){
    const d=document.createElement('div');
    d.className='education-entry';
    d.innerHTML=`<div class="education-fields">
      <div class="input-with-label">
        <label>Degree</label>
        <input placeholder="e.g., Bachelor of Science" class="edu-degree" value="${e?.degree||''}">
      </div>
      <div class="input-with-label">
        <label>Institution</label>
        <input placeholder="e.g., University Name" class="edu-inst" value="${e?.institution||''}">
      </div>
      <div class="input-with-label">
        <label>Year</label>
        <input placeholder="e.g., 2020" class="edu-year" value="${e?.year||''}">
      </div>
    </div>
    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    document.getElementById('educationList').appendChild(d);
  }

  function addProject(proj=null){
    const d=document.createElement('div');
    d.className='experience-entry';
    d.innerHTML=`<div class="experience-header-inputs" style="grid-template-columns: 1fr;">
      <div class="input-with-label">
        <label>Project Title</label>
        <input placeholder="e.g., E-commerce Platform" class="proj-title" value="${proj?.title||''}">
      </div>
    </div>
    <div class="experience-bullets">
      <label>Project Details</label>
      <div class="bullets"></div>
      <button type="button" class="add-bullet-btn" onclick="addProjectBullet(this)">+ Add Detail</button>
    </div>
    <button type="button" class="remove-entry-btn" onclick="this.parentElement.remove()">Remove Project</button>`;
    document.getElementById('projectsList').appendChild(d);
    const bulletsDiv = d.querySelector('.bullets');
    let pts = Array.isArray(proj?.bullets) ? proj.bullets : [''];
    if (!pts.length) pts = [''];
    pts.forEach(p => addProjectBullet(bulletsDiv, p));
  }

  function addProjectBullet(btn, text=''){
    const b=document.createElement('div');
    b.className='bullet-item';
    b.innerHTML=`<input placeholder="Project detail..." class="proj-point" value="${text||''}">
    <button type="button" class="bullet-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    if (btn && btn.classList && btn.classList.contains('bullets')) {
      btn.appendChild(b);
    } else if (btn && btn.parentElement && btn.parentElement.querySelector('.bullets')) {
      btn.parentElement.querySelector('.bullets').appendChild(b);
    }
  }

  function addCertification(cert=null){
    const d=document.createElement('div');
    d.className='education-entry';
    d.innerHTML=`<div class="education-fields">
      <div class="input-with-label">
        <label>Certification Name</label>
        <input placeholder="e.g., AWS Solutions Architect" class="cert-name" value="${cert?.name||''}">
      </div>
      <div class="input-with-label">
        <label>Issuing Organization</label>
        <input placeholder="e.g., Amazon Web Services" class="cert-org" value="${cert?.organization||''}">
      </div>
      <div class="input-with-label">
        <label>Year</label>
        <input placeholder="e.g., 2023" class="cert-year" value="${cert?.year||''}">
      </div>
    </div>
    <button type="button" class="entry-remove-btn" onclick="this.parentElement.remove()">‚úï</button>`;
    document.getElementById('certificationsList').appendChild(d);
  }

  /* ---------- JSON HANDLERS ---------- */
  function buildJSON(){
    const f=document.getElementById('resumeForm');
    const resume_data = {name:f.name.value,contact:{},summary:f.summary.value,
      technical_skills:{},experience:[],education:[],projects:[],certifications:[]};
    // Support both old (.entry) and new (.contact-entry) classes
    document.querySelectorAll('#contactList .contact-entry, #contactList .entry').forEach(x=>{
      const k=x.querySelector('.contact-key').value.trim(),v=x.querySelector('.contact-value').value.trim();if(k&&v)resume_data.contact[k.toLowerCase()]=v;});
    document.querySelectorAll('#skillsList .skill-entry, #skillsList .entry').forEach(x=>{
      const k=x.querySelector('.skill-key').value.trim(),v=x.querySelector('.skill-value').value.trim();
      if(k&&v){
        // Convert comma-separated string to array
        resume_data.technical_skills[k]=v.split(',').map(s=>s.trim()).filter(Boolean);
      }
    });
    document.querySelectorAll('#experienceList .experience-entry, #experienceList .entry').forEach(x=>{
      const expEntry = {
        company:x.querySelector('.exp-company').value.trim(),
        role:x.querySelector('.exp-role').value.trim(),
        period:x.querySelector('.exp-period').value.trim(),
        points:Array.from(x.querySelectorAll('.exp-point')).map(i=>i.value.trim()).filter(Boolean)
      };
      // Only add experience entry if it has required fields
      if(expEntry.company && expEntry.role && expEntry.points.length > 0) {
        resume_data.experience.push(expEntry);
      }
    });
    document.querySelectorAll('#educationList .education-entry, #educationList .entry').forEach(x=>{
      const eduEntry = {
        degree:x.querySelector('.edu-degree').value.trim(),
        institution:x.querySelector('.edu-inst').value.trim(),
        year:x.querySelector('.edu-year').value.trim()
      };
      // Only add education entry if it has required fields
      if(eduEntry.degree && eduEntry.institution) {
        resume_data.education.push(eduEntry);
      }
    });
    document.querySelectorAll('#projectsList .experience-entry, #projectsList .entry').forEach(x=>{
      const projEntry = {
        title:x.querySelector('.proj-title').value.trim(),
        bullets:Array.from(x.querySelectorAll('.proj-point')).map(i=>i.value.trim()).filter(Boolean)
      };
      // Only add project entry if it has title and at least one bullet
      if(projEntry.title && projEntry.bullets.length > 0) {
        resume_data.projects.push(projEntry);
      }
    });
    document.querySelectorAll('#certificationsList .education-entry, #certificationsList .entry').forEach(x=>{
      const certEntry = {
        name:x.querySelector('.cert-name').value.trim(),
        organization:x.querySelector('.cert-org').value.trim(),
        year:x.querySelector('.cert-year').value.trim()
      };
      // Only add certification entry if it has a name
      if(certEntry.name) {
        resume_data.certifications.push(certEntry);
      }
    });
    const companyNameJD = document.getElementById('companyNameJD') ? document.getElementById('companyNameJD').value.trim() : '';
    const jobTitleJD = document.getElementById('jobTitleJD') ? document.getElementById('jobTitleJD').value.trim() : '';
    const jobDescriptionElem = document.getElementById('jobDescriptionTab');
    const job_description_data = {
      job_description: jobDescriptionElem ? jobDescriptionElem.value.trim() : '',
      company_name: companyNameJD,
      job_title: jobTitleJD
    };
    return {resume_data, job_description_data};
  }

  // Helper function to get just the resume data
  function getResumeData() {
    const { resume_data } = buildJSON();
    return resume_data;
  }

  /* ---------- SAVE/LOAD RESUME TEMPLATE ---------- */
  async function saveResumeTemplate() {
    try {
      const resumeData = getResumeData();
      
      // Basic validation
      if (!resumeData.name || resumeData.name.trim() === '') {
        showNotification('‚ö†Ô∏è Please enter your name before saving', 'warning');
        return;
      }

      const response = await fetch('/api/user/resume-template', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        },
        body: JSON.stringify({ resume_data: resumeData })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Failed to save' }));
        throw new Error(error.detail || 'Failed to save resume template');
      }

      const result = await response.json();
      showNotification('‚úÖ Resume saved successfully! It will auto-load next time you log in.', 'success', 4000);
      console.log('Template saved:', result);
      
      // Reset change tracking after successful save
      resetChangeTracking();
      
    } catch (error) {
      console.error('Save failed:', error);
      showNotification(`‚ùå Error saving: ${error.message}`, 'error');
    }
  }

  async function loadResumeTemplate() {
    try {
      console.log('Loading resume template...');
      
      // Always clear the form first to remove previous user's data
      clearAll();
      
      const response = await fetch('/api/user/resume-template', {
        method: 'GET',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });

      if (!response.ok) {
        console.log('No template found or error loading - form cleared');
        isInitialLoad = false;
        return;
      }

      const result = await response.json();
      
      if (result.has_template && result.resume_data) {
        console.log('Template loaded, populating form...');
        populateForm(result.resume_data);
        
        // Check if it's an empty template (new user)
        const isEmpty = !result.resume_data.name && 
                       (!result.resume_data.experience || result.resume_data.experience.length === 0) &&
                       (!result.resume_data.education || result.resume_data.education.length === 0);
        
        if (!isEmpty) {
          showResult('‚úÖ Resume template loaded!');
        }
        
        console.log('Template last updated:', result.updated_at);
        
        // Reset change tracking after loading template
        resetChangeTracking();
      } else {
        console.log('No template found - form cleared');
        isInitialLoad = false;
      }
      
    } catch (error) {
      console.error('Load template failed:', error);
      // Clear form on error too
      clearAll();
      isInitialLoad = false;
    }
  }

  // Trigger JSON upload (legacy)
  function triggerUpload(){document.getElementById('uploadJSON').click();}
  document.getElementById('uploadJSON').addEventListener('change', e=>{
    const file=e.target.files[0];if(!file)return;
    const r=new FileReader();r.onload=ev=>{try{
      const d=JSON.parse(ev.target.result);
      // Only populate resume data, not job description data
      if(d.resume_data) {
        populateForm(d.resume_data);
      } else {
        populateForm(d);
      }
      // Do NOT populate job description fields from upload
      showResult('‚úÖ Resume JSON Uploaded');
    }catch{showNotification('Invalid JSON file', 'error');}};r.readAsText(file);});

  // Trigger resume document upload (PDF/DOCX)
  function triggerResumeUpload() {
    document.getElementById('uploadResume').click();
  }

  // Handle resume document upload with loading screen
  document.getElementById('uploadResume').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['.pdf', '.docx'];
    const fileName = file.name.toLowerCase();
    const isValid = validTypes.some(type => fileName.endsWith(type));
    
    if (!isValid) {
      showNotification('Please upload a PDF or DOCX file', 'warning');
      e.target.value = ''; // Clear the input
      return;
    }

    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
      showNotification('File too large. Maximum size is 10MB', 'warning');
      e.target.value = '';
      return;
    }

    try {
      // Show loading overlay
      showParseLoading();

      // Create form data
      const formData = new FormData();
      formData.append('file', file);

      // Simulate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
          updateParseProgress(progress, 'Extracting text from document...');
        }
      }, 200);

      // Upload and parse
      const response = await fetch('/api/parse-resume', {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        },
        body: formData
      });

      clearInterval(progressInterval);

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ detail: 'Failed to parse resume' }));
        throw new Error(errorData.detail || `Server error: ${response.status}`);
      }

      const data = await response.json();
      updateParseProgress(100, 'Parsing complete!');

      if (data.success && data.resume_data) {
        // Populate form with parsed data
        setTimeout(() => {
          populateForm(data.resume_data);
          hideParseLoading();
          showResult('‚úÖ Resume uploaded and parsed successfully!');
          e.target.value = ''; // Clear the input
        }, 500);
      } else {
        throw new Error(data.message || 'Failed to parse resume');
      }

    } catch (error) {
      hideParseLoading();
      console.error('Resume upload error:', error);
      showNotification(`Failed to parse resume: ${error.message || 'Unknown error'}`, 'error');
      e.target.value = '';
    }
  });

  // Loading overlay functions
  function showParseLoading() {
    const overlay = document.getElementById('parseLoadingOverlay');
    overlay.style.display = 'flex';
    updateParseProgress(0, 'Uploading document...');
  }

  function hideParseLoading() {
    const overlay = document.getElementById('parseLoadingOverlay');
    overlay.style.display = 'none';
  }

  function updateParseProgress(percent, message) {
    const fill = document.getElementById('parseProgressFill');
    const text = document.getElementById('parseProgressText');
    const messageEl = document.querySelector('.parse-loading-message');
    
    fill.style.width = `${percent}%`;
    text.textContent = `${Math.round(percent)}%`;
    if (message) {
      messageEl.textContent = message;
    }
  }

  // Update mode description based on selected mode
  function updateModeDescription() {
    const modeDescription = document.getElementById('modeDescription');
    const selectedMode = document.querySelector('input[name="resumeMode"]:checked').value;
    
    if (selectedMode === 'complete_jd') {
      modeDescription.innerHTML = ' <strong>Complete JD:</strong> Creates a complete resume from scratch using only the job description';
    } else {
      modeDescription.innerHTML = ' <strong>Resume + JD:</strong> Takes your existing resume data and tailors it to match the job description';
    }
  }

  // Global variables for edit mode
  let currentResumeData = null;
  let currentRequestId = null;
  let isEditMode = false;

  // View modal functions
  async function viewResumeContent(requestId, company, title) {
    try {
      currentRequestId = requestId;
      isEditMode = false;
      
      const modal = document.getElementById('viewModal');
      const modalTitle = document.getElementById('viewModalTitle');
      const modalSubtitle = document.getElementById('viewModalSubtitle');
      const modalBody = document.getElementById('viewModalBody');
      const downloadResumeBtn = document.getElementById('viewModalDownloadResume');
      const downloadJDBtn = document.getElementById('viewModalDownloadJD');
      const editBtn = document.getElementById('viewModalEditBtn');
      const saveBtn = document.getElementById('viewModalSaveBtn');
      
      // Show modal with loading state
      modalTitle.textContent = 'Resume Preview';
      modalSubtitle.textContent = `${company} - ${title}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="parse-loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading resume...</p></div>';
      modal.style.display = 'flex';
      
      // Show toolbar
      const toolbar = document.getElementById('resumeToolbar');
      if (toolbar) toolbar.style.display = 'flex';
      
      // Set up buttons
      downloadResumeBtn.onclick = () => downloadResumeDocx(requestId, company, title);
      downloadResumeBtn.style.display = 'inline-block';
      downloadJDBtn.style.display = 'inline-block';
      downloadJDBtn.onclick = () => downloadJobDescription(requestId, company, title);
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      document.getElementById('editBtnText').textContent = 'Edit';
      
      // Fetch resume data
      const response = await fetch(`/api/jobs/${requestId}/result`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load resume');
      
      const result = await response.json();
      const data = result.final_resume || result; // Handle both nested and direct format
      currentResumeData = data; // Store for editing
      
      // Render the resume
      renderResumeContent(data);
      
    } catch (error) {
      console.error('Error viewing resume:', error);
      document.getElementById('viewModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--danger);">
          <p>‚ùå Failed to load resume content</p>
          <p style="font-size: 14px; color: var(--text-secondary);">${error.message}</p>
        </div>
      `;
    }
  }

  function renderResumeContent(data) {
    const modalBody = document.getElementById('viewModalBody');
    let html = '<div id="resumeContentWrapper" class="format-modern font-size-medium">';
    
    // Header Section with Name and Contact
    html += '<div class="resume-header">';
    if (data.name) {
      html += `<h1 contenteditable="${isEditMode}" data-field="name" class="resume-name">${data.name}</h1>`;
    }
    
    if (data.contact) {
      const contactParts = [];
      if (data.contact.email) contactParts.push(`<span contenteditable="${isEditMode}" data-field="contact.email">${data.contact.email}</span>`);
      if (data.contact.phone) contactParts.push(`<span contenteditable="${isEditMode}" data-field="contact.phone">${data.contact.phone}</span>`);
      if (data.contact.location) contactParts.push(`<span contenteditable="${isEditMode}" data-field="contact.location">${data.contact.location}</span>`);
      if (data.contact.linkedin) contactParts.push(`<span contenteditable="${isEditMode}" data-field="contact.linkedin">${data.contact.linkedin}</span>`);
      
      // Handle additional contact fields
      for (const [key, value] of Object.entries(data.contact)) {
        if (!['email', 'phone', 'linkedin', 'location'].includes(key)) {
          contactParts.push(`<span contenteditable="${isEditMode}" data-field="contact.${key}">${value}</span>`);
        }
      }
      
      if (contactParts.length > 0) {
        html += `<div class="resume-contact-line">${contactParts.join(' ‚Ä¢ ')}</div>`;
      }
    }
    html += '</div>';
    
    // Professional Summary
    if (data.summary) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Professional Summary</h2>';
      html += `<p contenteditable="${isEditMode}" data-field="summary" class="resume-summary">${data.summary}</p>`;
      html += '</div>';
    }
    
    // Technical Skills
    if (data.technical_skills) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Technical Skills</h2>';
      html += '<div class="resume-skills-grid">';
      
      let skillIndex = 0;
      for (const [category, skills] of Object.entries(data.technical_skills)) {
        if (Array.isArray(skills) && skills.length > 0) {
          html += '<div class="resume-skill-item">';
          html += `<strong contenteditable="${isEditMode}" data-field="technical_skills_key.${skillIndex}" data-original-key="${category}" data-skill-category="${category}">${category}:</strong> `;
          html += `<span contenteditable="${isEditMode}" data-field="technical_skills.${category}">${skills.join(', ')}</span>`;
          html += '</div>';
          skillIndex++;
        }
      }
      html += '</div></div>';
    }
    
    // Experience
    if (data.experience && data.experience.length > 0) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Professional Experience</h2>';
      
      data.experience.forEach((exp, idx) => {
        const jobTitle = exp.job_title || exp.title || exp.role || 'Position';
        const company = exp.company || exp.organization || 'Company';
        const duration = exp.duration || exp.dates || exp.period || '';
        
        html += `<div class="resume-experience-item" data-exp-index="${idx}">`;
        html += '<div class="resume-exp-header">';
        html += '<div class="resume-exp-left">';
        html += `<div contenteditable="${isEditMode}" data-field="experience.${idx}.title" class="resume-exp-title">${jobTitle}</div>`;
        html += `<div contenteditable="${isEditMode}" data-field="experience.${idx}.company" class="resume-exp-company">${company}</div>`;
        html += '</div>';
        html += `<div contenteditable="${isEditMode}" data-field="experience.${idx}.duration" class="resume-exp-duration">${duration}</div>`;
        html += '</div>';
        
        const bullets = exp.bullets || exp.points || exp.responsibilities || [];
        if (bullets && bullets.length > 0) {
          html += '<ul class="resume-exp-bullets">';
          bullets.forEach((bullet, bidx) => {
            html += '<li>';
            html += `<span class="bullet-content" contenteditable="${isEditMode}" data-field="experience.${idx}.bullets.${bidx}">${bullet}</span>`;
            if (isEditMode) {
              html += `<button class="bullet-delete-btn" onclick="deleteExperienceBullet(${idx}, ${bidx})" title="Delete bullet point">Delete</button>`;
            }
            html += '</li>';
          });
          html += '</ul>';
        }
        html += '</div>';
      });
      html += '</div>';
    }
    
    // Education
    if (data.education && data.education.length > 0) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Education</h2>';
      
      data.education.forEach((edu, idx) => {
        html += '<div class="resume-education-item">';
        html += '<div class="resume-edu-header">';
        html += '<div class="resume-edu-left">';
        html += `<div contenteditable="${isEditMode}" data-field="education.${idx}.degree" class="resume-edu-degree">${edu.degree || ''}</div>`;
        html += `<div contenteditable="${isEditMode}" data-field="education.${idx}.institution" class="resume-edu-institution">${edu.institution || ''}</div>`;
        html += '</div>';
        html += `<div contenteditable="${isEditMode}" data-field="education.${idx}.year" class="resume-edu-year">${edu.year || edu.graduation_date || ''}</div>`;
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    }
    
    // Projects
    if (data.projects && data.projects.length > 0) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Projects</h2>';
      
      data.projects.forEach((proj, idx) => {
        html += '<div class="resume-project-item">';
        html += `<div contenteditable="${isEditMode}" data-field="projects.${idx}.name" class="resume-project-title">${proj.name || ''}</div>`;
        if (proj.description) {
          html += `<p contenteditable="${isEditMode}" data-field="projects.${idx}.description" class="resume-project-desc">${proj.description}</p>`;
        }
        if (proj.technologies) {
          const techStr = Array.isArray(proj.technologies) ? proj.technologies.join(', ') : proj.technologies;
          html += `<div contenteditable="${isEditMode}" data-field="projects.${idx}.technologies" class="resume-project-tech"><strong>Technologies:</strong> ${techStr}</div>`;
        }
        html += '</div>';
      });
      html += '</div>';
    }
    
    // Certifications
    if (data.certifications && data.certifications.length > 0) {
      html += '<div class="resume-section">';
      html += '<h2 class="resume-section-title">Certifications</h2>';
      html += '<ul class="resume-cert-list">';
      
      data.certifications.forEach((cert, idx) => {
        const certName = typeof cert === 'string' ? cert : cert.name;
        html += `<li contenteditable="${isEditMode}" data-field="certifications.${idx}">${certName}</li>`;
      });
      html += '</ul></div>';
    }
    
    html += '</div>';
    modalBody.innerHTML = html;
  }

  function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('viewModalEditBtn');
    const saveBtn = document.getElementById('viewModalSaveBtn');
    const editBtnText = document.getElementById('editBtnText');
    
    if (isEditMode) {
      editBtnText.textContent = 'Cancel';
      saveBtn.style.display = 'inline-block';
      renderResumeContent(currentResumeData);
    } else {
      editBtnText.textContent = 'Edit';
      saveBtn.style.display = 'none';
      renderResumeContent(currentResumeData);
    }
  }

  // Resume Formatting Toolbar Functions
  function changeResumeFormat(format) {
    const wrapper = document.getElementById('resumeContentWrapper');
    if (!wrapper) return;
    
    // Remove existing format classes
    wrapper.classList.remove('format-classic', 'format-modern');
    
    // Add selected format class
    wrapper.classList.add(`format-${format}`);
  }

  function changeResumeFontSize(size) {
    const wrapper = document.getElementById('resumeContentWrapper');
    if (!wrapper) return;
    
    // Remove existing font size classes
    wrapper.classList.remove('font-size-small', 'font-size-medium', 'font-size-large');
    
    // Add selected font size class
    wrapper.classList.add(`font-size-${size}`);
  }

  function toggleCompactMode() {
    const wrapper = document.getElementById('resumeContentWrapper');
    if (!wrapper) return;
    
    wrapper.classList.toggle('compact-mode');
    
    const btn = document.getElementById('compactModeBtn');
    if (btn) {
      const isCompact = wrapper.classList.contains('compact-mode');
      btn.classList.toggle('active', isCompact);
      btn.innerHTML = isCompact 
        ? '<span>üìÑ</span><span>Normal</span>' 
        : '<span>üìè</span><span>Compact</span>';
    }
  }

  function printResume() {
    // Temporarily exit edit mode for clean printing
    const wasEditMode = isEditMode;
    if (isEditMode) {
      isEditMode = false;
      renderResumeContent(currentResumeData);
    }
    
    // Wait for render, then print
    setTimeout(() => {
      window.print();
      
      // Restore edit mode if it was active
      if (wasEditMode) {
        setTimeout(() => {
          isEditMode = true;
          renderResumeContent(currentResumeData);
        }, 100);
      }
    }, 50);
  }

  function exportToPDF() {
    // Use browser's print-to-PDF functionality
    const originalTitle = document.title;
    const wasEditMode = isEditMode;
    
    // Set a descriptive filename for the PDF
    if (currentResumeData && currentResumeData.name) {
      document.title = `${currentResumeData.name}_Resume`;
    }
    
    // Temporarily exit edit mode for clean export
    if (isEditMode) {
      isEditMode = false;
      renderResumeContent(currentResumeData);
    }
    
    // Wait for render, then open print dialog
    setTimeout(() => {
      window.print();
      
      // Restore original title and edit mode
      setTimeout(() => {
        document.title = originalTitle;
        if (wasEditMode) {
          isEditMode = true;
          renderResumeContent(currentResumeData);
        }
      }, 100);
    }, 50);
  }

  async function saveResumeChanges() {
    try {
      // First, rebuild technical_skills from scratch to handle key renames
      const newTechnicalSkills = {};
      const skillContainers = document.querySelectorAll('[data-skill-category]');
      
      skillContainers.forEach(container => {
        const keyElem = container.querySelector('[data-field^="technical_skills_key"]');
        const valueElem = container.querySelector('[data-field^="technical_skills."]');
        
        if (keyElem && valueElem) {
          const newKey = keyElem.textContent.trim();
          const valuesText = valueElem.textContent.trim();
          
          if (newKey && valuesText) {
            const values = valuesText.split(',').map(s => s.trim()).filter(s => s);
            if (values.length > 0) {
              newTechnicalSkills[newKey] = values;
            }
          }
        }
      });
      
      // Update technical_skills in currentResumeData
      if (Object.keys(newTechnicalSkills).length > 0) {
        currentResumeData.technical_skills = newTechnicalSkills;
      }
      
      // Collect all other edited content
      const editableElements = document.querySelectorAll('[contenteditable="true"]');
      
      editableElements.forEach(elem => {
        const field = elem.getAttribute('data-field');
        const value = elem.textContent.trim();
        
        // Skip technical_skills fields as we've already handled them above
        if (!field || field.includes('technical_skills')) return;
        
        // Parse nested field paths like "experience.0.title" or "experience.0.bullets.1"
        const parts = field.split('.');
        let current = currentResumeData;
        
        for (let i = 0; i < parts.length - 1; i++) {
          const part = parts[i];
          const nextPart = parts[i + 1];
          
          // Check if next part is an array index
          if (!isNaN(nextPart)) {
            // Ensure current[part] is an array
            if (!Array.isArray(current[part])) {
              current[part] = [];
            }
            const index = parseInt(nextPart);
            // Ensure the array element exists
            if (!current[part][index]) {
              current[part][index] = {};
            }
            current = current[part][index];
            i++; // Skip the index in next iteration
          } else {
            // Regular object property
            if (!current[part]) {
              current[part] = {};
            }
            current = current[part];
          }
        }
        
        const lastPart = parts[parts.length - 1];
        
        // Handle special cases
        if (field.includes('bullets') && !isNaN(lastPart)) {
          // Updating a specific bullet point in an array
          const bulletIndex = parseInt(lastPart);
          // The current object should have a 'bullets' array
          const parentKey = parts[parts.length - 2]; // Should be 'bullets'
          // Go back one level to set the array element
          const parentParts = parts.slice(0, -2);
          let parent = currentResumeData;
          
          for (let i = 0; i < parentParts.length; i++) {
            const part = parentParts[i];
            const nextPart = parentParts[i + 1];
            
            if (!isNaN(nextPart)) {
              parent = parent[part][parseInt(nextPart)];
              i++;
            } else {
              parent = parent[part];
            }
          }
          
          // Ensure bullets array exists
          if (!Array.isArray(parent.bullets)) {
            parent.bullets = [];
          }
          parent.bullets[bulletIndex] = value;
        } else {
          // Regular field update
          current[lastPart] = value;
        }
      });
      
      // Send update to server
      const resultDiv = document.getElementById('result');
      if (resultDiv) {
        resultDiv.textContent = 'Saving changes...';
        resultDiv.style.display = 'block';
      }
      
      const response = await fetch(`/api/jobs/${currentRequestId}/update`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ final_resume: currentResumeData })
      });
      
      if (!response.ok) {
        throw new Error('Failed to save changes');
      }
      
      if (resultDiv) {
        resultDiv.textContent = '‚úÖ Changes saved successfully!';
        setTimeout(() => {
          resultDiv.style.display = 'none';
        }, 3000);
      }
      
      isEditMode = false;
      const editBtnText = document.getElementById('editBtnText');
      if (editBtnText) {
        editBtnText.textContent = 'Edit';
      }
      const saveBtn = document.getElementById('viewModalSaveBtn');
      if (saveBtn) {
        saveBtn.style.display = 'none';
      }
      renderResumeContent(currentResumeData);
      
    } catch (error) {
      console.error('Error saving changes:', error);
      showNotification(`Failed to save changes: ${error.message}`, 'error');
    }
  }

  async function copyJobDescription(requestId) {
    try {
      showDashMessage('Copying job description...', 'info');
      
      const response = await fetch(`/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load job description');
      
      const text = await response.text();
      
      // Copy to clipboard
      await navigator.clipboard.writeText(text);
      
      showDashMessage('‚úÖ Job description copied to clipboard!', 'success');
    } catch (error) {
      console.error('Error copying job description:', error);
      showDashMessage('‚ùå Failed to copy job description', 'error');
    }
  }

  async function viewJobDescription(requestId, company, title) {
    try {
      const modal = document.getElementById('viewModal');
      const modalTitle = document.getElementById('viewModalTitle');
      const modalSubtitle = document.getElementById('viewModalSubtitle');
      const modalBody = document.getElementById('viewModalBody');
      const downloadResumeBtn = document.getElementById('viewModalDownloadResume');
      const downloadJDBtn = document.getElementById('viewModalDownloadJD');
      
      // Show modal with loading state
      modalTitle.textContent = 'Job Description';
      modalSubtitle.textContent = `${company} - ${title}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="parse-loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 20px;">Loading job description...</p></div>';
      modal.style.display = 'flex';
      
      // Set up download buttons
      downloadResumeBtn.onclick = () => downloadResumeDocx(requestId, company, title);
      downloadResumeBtn.style.display = 'inline-block';
      downloadJDBtn.style.display = 'inline-block';
      downloadJDBtn.onclick = () => downloadJobDescription(requestId, company, title);
      
      // Fetch JD data
      const response = await fetch(`/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load job description');
      
      const text = await response.text();
      
      // Format JD text for display (preserve line breaks)
      const formattedText = text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => `<p style="color: var(--text-primary);">${line}</p>`)
        .join('');
      
      modalBody.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-size: 14px; line-height: 1.8; color: var(--text-primary);">
          ${formattedText}
        </div>
      `;
      
    } catch (error) {
      console.error('Error viewing job description:', error);
      document.getElementById('viewModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--danger);">
          <p>‚ùå Failed to load job description</p>
          <p style="font-size: 14px; color: var(--text-secondary);">${error.message}</p>
        </div>
      `;
    }
  }

  function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
  }

  // Generate cover letter from a completed job in dashboard
  async function generateCoverLetterFromJob(requestId, company, title) {
    try {
      showNotification('Loading job details for cover letter...', 'info');
      
      // Fetch the job description
      const response = await fetch(`/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(currentUsername + ':' + currentPassword)
        }
      });
      
      if (!response.ok) throw new Error('Failed to load job description');
      
      const jobDescription = await response.text();
      
      // Switch to Email Writer tab
      switchTab('emailwriter');
      
      // Wait for tab to be active, then render the cover letter form with pre-filled data
      setTimeout(() => {
        // Render cover letter form
        renderTemplateForm('cover_letter');
        
        // Pre-fill the form fields after a short delay
        setTimeout(() => {
          const companyInput = document.getElementById('emailCompany');
          const titleInput = document.getElementById('emailJobTitle');
          const jdInput = document.getElementById('emailJD');
          
          if (companyInput) companyInput.value = company;
          if (titleInput) titleInput.value = title;
          if (jdInput) jdInput.value = jobDescription;
          
          // Reset template selector to show cover letter is selected
          const selector = document.getElementById('emailTemplateSelector');
          if (selector) selector.value = 'cover_letter';
          
          showNotification('‚úÖ Cover letter form ready! Click "Generate Cover Letter" to create it.', 'success');
        }, 100);
      }, 200);
      
    } catch (error) {
      console.error('Error preparing cover letter:', error);
      showNotification('‚ùå Failed to load job details: ' + error.message, 'error');
    }
  }

  // Close modal when clicking outside
  document.getElementById('viewModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'viewModal') {
      closeViewModal();
    }
  });

  // Add new skill category
  function addSkillCategory() {
    const categoryName = prompt('Enter new skill category name (e.g., "Frameworks", "Cloud Platforms"):');
    
    if (!categoryName || categoryName.trim() === '') {
      return; // User cancelled or entered empty name
    }
    
    const trimmedCategory = categoryName.trim();
    
    // Check if category already exists
    if (currentResumeData.technical_skills && currentResumeData.technical_skills[trimmedCategory]) {
      showNotification('‚ö†Ô∏è This category already exists!', 'warning');
      return;
    }
    
    // Get skills for this category
    const skillsInput = prompt(`Enter skills for "${trimmedCategory}" (comma-separated):`);
    
    if (!skillsInput || skillsInput.trim() === '') {
      return; // User cancelled or entered empty skills
    }
    
    const skills = skillsInput.split(',').map(s => s.trim()).filter(s => s);
    
    if (skills.length === 0) {
      showNotification('‚ö†Ô∏è Please enter at least one skill!', 'warning');
      return;
    }
    
    // Add to data
    if (!currentResumeData.technical_skills) {
      currentResumeData.technical_skills = {};
    }
    currentResumeData.technical_skills[trimmedCategory] = skills;
    
    // Re-render to show the new category
    renderResumeContent(currentResumeData);
  }

  // Remove skill category
  async function removeSkillCategory(category) {
    const confirmed = await customConfirm(
      `Are you sure you want to remove "${category}"?`,
      'Remove Skill Category'
    );
    
    if (!confirmed) {
      return;
    }
    
    // Remove from data
    if (currentResumeData.technical_skills && currentResumeData.technical_skills[category]) {
      delete currentResumeData.technical_skills[category];
    }
    
    // Re-render to reflect changes
    renderResumeContent(currentResumeData);
    
    // Show success message
    showResult(`‚úÖ ${category} removed successfully`);
  }

  // Delete contact item
  async function deleteContactItem(type) {
    const confirmed = await customConfirm(
      `Are you sure you want to delete this ${type}?`,
      'Delete Contact Item'
    );
    
    if (!confirmed) {
      return;
    }
    
    // Remove from data
    if (currentResumeData.contact && currentResumeData.contact[type]) {
      delete currentResumeData.contact[type];
    }
    
    // Re-render to reflect changes
    renderResumeContent(currentResumeData);
    
    // Show success message
    showResult(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`);
  }

  async function deleteExperienceBullet(expIdx, bulletIdx) {
    const confirmed = await customConfirm(
      'Are you sure you want to delete this bullet point?',
      'Delete Bullet Point'
    );
    
    if (!confirmed) {
      return;
    }
    
    // Remove bullet from data
    if (currentResumeData.experience && currentResumeData.experience[expIdx]) {
      const bullets = currentResumeData.experience[expIdx].bullets || 
                     currentResumeData.experience[expIdx].points || 
                     currentResumeData.experience[expIdx].responsibilities;
      
      if (bullets && Array.isArray(bullets) && bulletIdx < bullets.length) {
        bullets.splice(bulletIdx, 1);
        
        // Update the bullets array reference
        if (currentResumeData.experience[expIdx].bullets) {
          currentResumeData.experience[expIdx].bullets = bullets;
        } else if (currentResumeData.experience[expIdx].points) {
          currentResumeData.experience[expIdx].points = bullets;
        } else if (currentResumeData.experience[expIdx].responsibilities) {
          currentResumeData.experience[expIdx].responsibilities = bullets;
        }
      }
    }
    
    // Re-render to reflect changes
    renderResumeContent(currentResumeData);
    
    // Show success message
    showResult('‚úÖ Bullet point deleted successfully');
  }

  // Help modal functions
  function showHelpModal() {
    document.getElementById('helpModal').style.display = 'flex';
  }

  function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
  }

  // Close help modal when clicking outside
  document.getElementById('helpModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'helpModal') {
      closeHelpModal();
    }
  });

  function populateForm(d){
    // Prevent change tracking during population
    isInitialLoad = true;
    
    const f = document.getElementById('resumeForm');
    f.name.value = d.name || '';
    f.summary.value = d.summary || '';
    
    // Handle contact - both old format (string) and new format (object)
    document.getElementById('contactList').innerHTML = '';
    const contact = d.contact || {};
    if (typeof contact === 'string') {
      // Old format: single string - convert to phone field
      addContact('Phone', contact);
    } else if (typeof contact === 'object') {
      // New format: structured object
      Object.entries(contact).forEach(([k, v]) => addContact(k, v));
    }
    // Support both old (.entry) and new (.contact-entry) class names
    if (document.querySelectorAll('#contactList .contact-entry, #contactList .entry').length === 0) {
      addContact(); // Add empty field if no contact data
    }
    
    document.getElementById('skillsList').innerHTML = '';
    const skills = d.technical_skills || d.skills || {};
    if (Object.keys(skills).length) {
      Object.entries(skills).forEach(([k, v]) => {
        // Handle both array and string formats
        const skillValue = Array.isArray(v) ? v.join(', ') : v;
        addSkill(k, skillValue);
      });
    } else {
      addSkill();
    }
    document.getElementById('experienceList').innerHTML = '';
    if (d.experience && d.experience.length) {
      d.experience.forEach(e => addExperience(e));
    } else {
      addExperience();
    }
    document.getElementById('educationList').innerHTML = '';
    if (d.education && d.education.length) {
      d.education.forEach(e => addEducation(e));
    } else {
      addEducation();
    }
    document.getElementById('projectsList').innerHTML = '';
    if (d.projects && d.projects.length) {
      d.projects.forEach(p => addProject(p));
    } else {
      addProject();
    }
    document.getElementById('certificationsList').innerHTML = '';
    if (d.certifications && d.certifications.length) {
      d.certifications.forEach(c => addCertification(c));
    } else {
      addCertification();
    }
    
    // Re-enable change tracking after population completes
    setTimeout(() => {
      isInitialLoad = false;
    }, 100);
  }

  function downloadJSON(){
    // Only download resume data (not job description)
    const { resume_data } = buildJSON();
    const blob=new Blob([JSON.stringify(resume_data,null,2)],{type:"application/json"});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download="resume_data.json";a.click();URL.revokeObjectURL(a.href);showResult('Resume JSON Downloaded');}

  async function downloadWordDoc() {
    try {
      console.log('Generating Word document from current resume data...');
      
      const { resume_data } = buildJSON();
      
      // Validate resume data
      if (!resume_data.name || resume_data.name.trim() === '') {
        showNotification('‚ö†Ô∏è Please enter your name before generating a Word document.', 'warning');
        return;
      }
      
      // Show loading message
      showResult('Generating Word document...');
      
      const response = await fetch('/create_resume', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ resume_data })
      });
      
      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Failed to generate document' }));
        throw new Error(error.detail || 'Failed to generate Word document');
      }
      
      // Get the blob from response
      const blob = await response.blob();
      
      // Create download link
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${resume_data.name.replace(/\s+/g, '_')}_Resume.docx`;
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showResult('‚úÖ Word document downloaded!');
      console.log('Word document generated successfully');
      
    } catch (error) {
      console.error('Word generation failed:', error);
      showResult(`‚ùå Error: ${error.message}`);
    }
  }

  async function downloadPDF() {
    try {
      console.log('Generating PDF document from current resume data...');
      
      const { resume_data } = buildJSON();
      
      // Validate resume data
      if (!resume_data.name || resume_data.name.trim() === '') {
        showNotification('‚ö†Ô∏è Please enter your name before generating a PDF document.', 'warning');
        return;
      }
      
      // Show loading message
      showResult('Generating PDF document...');
      
      const response = await fetch('/create_resume_pdf', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ resume_data })
      });
      
      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Failed to generate document' }));
        throw new Error(error.detail || 'Failed to generate PDF document');
      }
      
      // Get the blob from response
      const blob = await response.blob();
      
      // Create download link
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${resume_data.name.replace(/\s+/g, '_')}_Resume.pdf`;
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showResult('‚úÖ PDF document downloaded!');
      console.log('PDF document generated successfully');
      
    } catch (error) {
      console.error('PDF generation failed:', error);
      showResult(`‚ùå Error: ${error.message}`);
    }
  }

  function toggleDownloadMenu() {
    const menu = document.getElementById('downloadOptions');
    menu.classList.toggle('show');
  }

  function toggleDownloadMenuTop() {
    const menu = document.getElementById('downloadOptionsTop');
    menu.classList.toggle('show');
  }

  // Toggle action menu dropdown
  function toggleActionMenu() {
    const menu = document.getElementById('actionDropdownMenu');
    if (menu.style.display === 'none' || menu.style.display === '') {
      menu.style.display = 'block';
    } else {
      menu.style.display = 'none';
    }
  }

  // Close download menu when clicking outside
  document.addEventListener('click', function(event) {
    const downloadGroup = document.querySelector('.download-group');
    const menu = document.getElementById('downloadOptions');
    
    if (menu && downloadGroup && !downloadGroup.contains(event.target)) {
      menu.classList.remove('show');
    }

    // Close top download menu when clicking outside
    const downloadGroupTop = document.querySelector('.download-group-top');
    const menuTop = document.getElementById('downloadOptionsTop');
    
    if (menuTop && downloadGroupTop && !downloadGroupTop.contains(event.target)) {
      menuTop.classList.remove('show');
    }

    // Close action menu when clicking outside
    const actionMenu = document.getElementById('actionDropdownMenu');
    const actionMenuBtn = document.getElementById('actionMenuToggle');
    
    if (actionMenu && actionMenuBtn && !actionMenuBtn.contains(event.target) && !actionMenu.contains(event.target)) {
      actionMenu.style.display = 'none';
    }
  });

  function validateResumeInput(resumeData, jobData, mode) {
    const errors = [];
    
    // Validate Job Description (required for both modes)
    if (!jobData.job_description || jobData.job_description.trim().length < 50) {
      errors.push('‚Ä¢ Job Description must be at least 50 characters long');
    }
    
    if (!jobData.company_name || jobData.company_name.trim().length === 0) {
      errors.push('‚Ä¢ Company Name is required');
    }
    
    if (!jobData.job_title || jobData.job_title.trim().length === 0) {
      errors.push('‚Ä¢ Job Title is required');
    }
    
    // Validate Resume Data (only for resume+jd mode)
    if (mode === 'resume_jd') {
      if (!resumeData.name || resumeData.name.trim().length === 0) {
        errors.push('‚Ä¢ Name is required in Resume+JD mode');
      }
      
      if (!resumeData.summary || resumeData.summary.trim().length < 50) {
        errors.push('‚Ä¢ Professional Summary must be at least 50 characters long');
      }
      
      // Check contact info
      const contact = resumeData.contact || {};
      if (!contact.email && !contact.phone) {
        errors.push('‚Ä¢ At least one contact method (Email or Phone) is required');
      }
      
      // Validate email format if provided
      if (contact.email && !isValidEmail(contact.email)) {
        errors.push('‚Ä¢ Email format is invalid');
      }
      
      // Check technical skills
      const skills = resumeData.technical_skills || {};
      if (Object.keys(skills).length === 0) {
        errors.push('‚Ä¢ At least one Technical Skill category is required');
      } else {
        // Check if any skill category has values
        let hasSkills = false;
        for (const category in skills) {
          if (Array.isArray(skills[category]) && skills[category].length > 0) {
            hasSkills = true;
            break;
          }
        }
        if (!hasSkills) {
          errors.push('‚Ä¢ Technical Skills must have at least one skill listed');
        }
      }
      
      // Check experience
      if (!resumeData.experience || resumeData.experience.length === 0) {
        errors.push('‚Ä¢ At least one Experience entry is required');
      } else {
        resumeData.experience.forEach((exp, idx) => {
          if (!exp.company || exp.company.trim().length === 0) {
            errors.push(`‚Ä¢ Experience ${idx + 1}: Company name is required`);
          }
          if (!exp.role && !exp.title && !exp.job_title) {
            errors.push(`‚Ä¢ Experience ${idx + 1}: Job title/role is required`);
          }
          const bullets = exp.bullets || exp.points || exp.responsibilities || [];
          if (bullets.length === 0) {
            errors.push(`‚Ä¢ Experience ${idx + 1}: At least one responsibility/bullet point is required`);
          }
        });
      }
      
      // Check education
      if (!resumeData.education || resumeData.education.length === 0) {
        errors.push('‚Ä¢ At least one Education entry is required');
      } else {
        resumeData.education.forEach((edu, idx) => {
          if (!edu.degree || edu.degree.trim().length === 0) {
            errors.push(`‚Ä¢ Education ${idx + 1}: Degree is required`);
          }
          if (!edu.institution || edu.institution.trim().length === 0) {
            errors.push(`‚Ä¢ Education ${idx + 1}: Institution is required`);
          }
        });
      }
    }
    
    return errors;
  }
  
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  async function generateResume(){
    console.log('[DEBUG] Generate Resume clicked - Using two-phase workflow');
    
    // Get selected resume mode
    const resumeModeRadio = document.querySelector('input[name="resumeMode"]:checked');
    const resumeMode = resumeModeRadio ? resumeModeRadio.value : 'complete_jd';
    
    const {resume_data: resumeObj, job_description_data: jobObj} = buildJSON();
    
    // Validate based on mode with better feedback
    const validationErrors = validateResumeInput(resumeObj, jobObj, resumeMode);
    if (validationErrors.length > 0) {
      const errorList = validationErrors.map((err, idx) => `${idx + 1}. ${err}`).join('\n');
      const errorMessage = '‚ùå Please fix the following issues:\n\n' + errorList;
      showNotification(errorMessage, 'error');
      showResult('‚ùå Validation failed - check required fields');
      
      if (validationErrors[0].includes('Summary')) {
        document.querySelector('textarea[name="summary"]')?.focus();
      } else if (validationErrors[0].includes('Job Description')) {
        document.getElementById('jobDescriptionTab')?.focus();
      }
      return;
    }
    
    // Generate unique request ID
    const requestId = generateRequestId();
    const companyName = jobObj.company_name || 'Unknown Company';
    
    console.log('[DEBUG] Request ID:', requestId, 'Company:', companyName);
    
    // Add request to UI tracking
    addRequestToUI(requestId, companyName);
    updateRequestProgress(requestId, 5, 'Starting keyword extraction...');
    
    const payload = {
      resume_data: resumeObj,
      job_description_data: jobObj,
      mode: resumeMode
    };
    
    // Use dynamic API URL
    const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:5001'
      : '';
    
    try {
      // PHASE 1: Extract keywords from JD
      console.log('[FEEDBACK] Phase 1: Extracting keywords...');
      const extractUrl = `${apiBaseUrl}/api/resume/extract-keywords`;
      
      const token = localStorage.getItem('token');
      if (!token) {
        throw new Error('Please login first');
      }
      
      const extractRes = await fetch(extractUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      
      if (!extractRes.ok) {
        const errorData = await extractRes.json().catch(() => ({detail: 'Failed to extract keywords'}));
        throw new Error(errorData.detail || 'Failed to extract keywords');
      }
      
      const extractData = await extractRes.json();
      console.log('[FEEDBACK] Phase 1 complete. Request ID:', extractData.request_id);
      console.log('[FEEDBACK] Mode from extractData:', extractData.keywords?.mode);
      
      // Check if keyword review is enabled
      const enableKeywordReview = document.getElementById('enableKeywordReview')?.checked;
      
      if (enableKeywordReview) {
        // Show keyword review modal for user to edit
        console.log('[FEEDBACK] Keyword review enabled - showing modal');
        updateRequestProgress(requestId, 26, '‚úì Keywords extracted - Awaiting your review');
        showKeywordReviewModal(extractData.keywords, extractData.request_id, requestId, companyName);
      } else {
        // Skip review, proceed directly to Phase 2 - pass mode from extractData
        console.log('[FEEDBACK] Keyword review disabled - proceeding directly to generation');
        updateRequestProgress(requestId, 30, 'Generating resume...');
        await proceedToGenerationPhase(extractData.request_id, requestId, companyName, null, extractData.keywords?.mode);
      }
      
    } catch (error) {
      console.error('[FEEDBACK] Error in Phase 1:', error);
      markRequestFailed(requestId, error.message);
      showResult('‚ùå Failed to extract keywords: ' + error.message);
    }
  }
  
  // Show keyword review modal for user feedback
  function showKeywordReviewModal(jdHints, backendRequestId, uiRequestId, companyName) {
    console.log(`[QUEUE][${uiRequestId}] Requesting keyword review modal`);
    console.log(`[QUEUE][${uiRequestId}] Current queue length BEFORE adding:`, keywordReviewQueue.length);
    console.log(`[QUEUE][${uiRequestId}] Modal currently open:`, isModalOpen);
    
    // Add to queue
    keywordReviewQueue.push({
      jdHints,
      backendRequestId,
      uiRequestId,
      companyName
    });
    
    console.log(`[QUEUE][${uiRequestId}] Added to queue. New queue length:`, keywordReviewQueue.length);
    console.log(`[QUEUE] Full queue state:`, keywordReviewQueue.map(q => q.uiRequestId));
    
    // Process queue if modal is not currently open
    processKeywordReviewQueue();
  }
  
  // Process the keyword review queue
  function processKeywordReviewQueue() {
    console.log('[QUEUE] Processing queue - Modal open:', isModalOpen, 'Queue length:', keywordReviewQueue.length);
    
    // If modal is already open or queue is empty, do nothing
    if (isModalOpen || keywordReviewQueue.length === 0) {
      console.log('[QUEUE] Processing skipped - Modal open:', isModalOpen, 'Queue empty:', keywordReviewQueue.length === 0);
      return;
    }
    
    // Get next item from queue
    const nextReview = keywordReviewQueue.shift();
    console.log(`[QUEUE] Processing request: ${nextReview.uiRequestId}`);
    console.log(`[QUEUE] Remaining in queue after shift:`, keywordReviewQueue.length);
    console.log(`[QUEUE] Remaining requests:`, keywordReviewQueue.map(q => q.uiRequestId));
    
    const modal = document.getElementById('keywordReviewModal');
    if (!modal) {
      console.error('[QUEUE] ERROR: Keyword review modal not found!');
      return;
    }
    
    // Mark modal as open
    isModalOpen = true;
    console.log(`[QUEUE] Modal marked as OPEN for request: ${nextReview.uiRequestId}`);
    
    // Store request IDs and mode for later use
    modal.dataset.backendRequestId = nextReview.backendRequestId;
    modal.dataset.uiRequestId = nextReview.uiRequestId;
    modal.dataset.companyName = nextReview.companyName;
    
    // CRITICAL: Extract and validate mode from backend response
    const modeFromBackend = nextReview.jdHints?.mode;
    modal.dataset.mode = modeFromBackend || 'complete_jd';  // Store mode from backend with fallback
    
    console.log(`[QUEUE] Stored in modal dataset - Backend ID: ${nextReview.backendRequestId}, UI ID: ${nextReview.uiRequestId}`);
    console.log(`[QUEUE] Mode from jdHints: '${modeFromBackend}', Mode stored in modal: '${modal.dataset.mode}'`);
    if (!modeFromBackend) {
      console.warn(`[QUEUE] WARNING: Mode was not in jdHints! jdHints keys: ${Object.keys(nextReview.jdHints || {})}`);
    }
    
    // Show queue status if there are more items
    if (keywordReviewQueue.length > 0) {
      showToast(`${keywordReviewQueue.length} more keyword review(s) in queue`, 'info');
    }
    
    // Debug logging
    console.log('[MODAL] Soft skills data:', nextReview.jdHints.soft_skills, 'Length:', (nextReview.jdHints.soft_skills || []).length);
    
    // Populate keyword lists
    populateKeywordList('technicalKeywordsList', nextReview.jdHints.technical_keywords || []);
    populateKeywordList('softSkillsList', nextReview.jdHints.soft_skills || []);
    populateKeywordList('phrasesList', nextReview.jdHints.phrases || []);
    
    // Update counts
    updateKeywordCounts();
    
    // Show modal
    modal.style.display = 'flex';
    console.log(`[QUEUE] Modal displayed for request: ${nextReview.uiRequestId}`);
  }
  
  // Populate keyword list with edit and remove functionality
  function populateKeywordList(listId, keywords) {
    const list = document.getElementById(listId);
    if (!list) return;
    
    list.innerHTML = '';
    keywords.forEach(keyword => {
      const item = document.createElement('div');
      item.className = 'keyword-item';
      item.innerHTML = `
        <span class="keyword-text" contenteditable="false" onclick="editKeyword(this)" title="Click to edit">${keyword}</span>
        <button class="keyword-remove-btn" onclick="removeKeyword(this)" title="Remove">√ó</button>
      `;
      list.appendChild(item);
    });
  }
  
  // Update keyword counts in badges
  function updateKeywordCounts() {
    const techCount = document.getElementById('technicalKeywordsList').children.length;
    const softCount = document.getElementById('softSkillsList').children.length;
    const phrasesCount = document.getElementById('phrasesList').children.length;
    
    document.getElementById('technicalCount').textContent = techCount;
    document.getElementById('softSkillsCount').textContent = softCount;
    document.getElementById('phrasesCount').textContent = phrasesCount;
    document.getElementById('totalKeywordsCount').textContent = techCount + softCount + phrasesCount;
  }
  
  // Edit keyword inline
  function editKeyword(textElement) {
    if (!textElement) return;
    
    // If already editing, ignore
    if (textElement.getAttribute('contenteditable') === 'true') return;
    
    // Store original value
    const originalText = textElement.textContent;
    
    // Make editable
    textElement.setAttribute('contenteditable', 'true');
    textElement.classList.add('editing');
    textElement.focus();
    
    // Select all text
    const range = document.createRange();
    range.selectNodeContents(textElement);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Handle save on Enter or blur
    const saveEdit = () => {
      const newText = textElement.textContent.trim();
      
      if (!newText) {
        // If empty, revert to original
        textElement.textContent = originalText;
      } else {
        textElement.textContent = newText;
      }
      
      textElement.setAttribute('contenteditable', 'false');
      textElement.classList.remove('editing');
    };
    
    // Save on Enter key
    textElement.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveEdit();
      } else if (e.key === 'Escape') {
        textElement.textContent = originalText;
        textElement.setAttribute('contenteditable', 'false');
        textElement.classList.remove('editing');
      }
    }, { once: true });
    
    // Save on blur
    textElement.addEventListener('blur', saveEdit, { once: true });
  }
  
  // Continue to Phase 2 after keyword review
  async function continueToGeneration() {
    const modal = document.getElementById('keywordReviewModal');
    const backendRequestId = modal.dataset.backendRequestId;
    const uiRequestId = modal.dataset.uiRequestId;
    const companyName = modal.dataset.companyName;
    const mode = modal.dataset.mode;  // Get mode from modal
    
    // Collect modified keywords
    const feedback = {
      technical_keywords: getKeywordsFromList('technicalKeywordsList'),
      soft_skills: getKeywordsFromList('softSkillsList'),
      phrases: getKeywordsFromList('phrasesList')
    };
    
    console.log('[FEEDBACK] User feedback collected:', feedback);
    console.log('[FEEDBACK] Keywords - Technical:', feedback.technical_keywords.length, 'Soft:', feedback.soft_skills.length, 'Phrases:', feedback.phrases.length);
    console.log('[FEEDBACK] Mode from modal:', mode);
    
    // Close modal WITHOUT marking as failed (user approved, not cancelled)
    closeKeywordReviewModal(false);
    
    // Proceed to generation with feedback AND mode
    await proceedToGenerationPhase(backendRequestId, uiRequestId, companyName, feedback, mode);
  }
  
  // Proceed to Phase 2 generation (with or without feedback)
  async function proceedToGenerationPhase(backendRequestId, uiRequestId, companyName, feedback, mode = null) {
    // Update UI progress
    updateRequestProgress(uiRequestId, 30, 'Generating resume...');
    
    const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:5001'
      : '';
    
    try {
      // PHASE 2: Generate resume with feedback (or null for auto-proceed)
      const generateUrl = `${apiBaseUrl}/api/resume/generate`;
      
      // Use Basic auth (same as Phase 1)
      const auth = dashboardCredentials 
        ? 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        : `Bearer ${localStorage.getItem('token')}`;
      
      const payload = {
        request_id: backendRequestId
      };
      
      // Add mode - CRITICAL for correct generation (always send, default to complete_jd)
      // This ensures the backend knows which prompt to use even if mode was lost
      payload.mode = mode || 'complete_jd';
      console.log('[FEEDBACK] Including mode in payload:', payload.mode);
      if (!mode) {
        console.warn('[FEEDBACK] WARNING: Mode was undefined/null, defaulting to complete_jd');
      }
      
      // Only add feedback if provided (when user reviews keywords)
      if (feedback) {
        payload.feedback = feedback;
        console.log('[FEEDBACK] Phase 2: Calling generate endpoint with user feedback...');
      } else {
        console.log('[FEEDBACK] Phase 2: Calling generate endpoint without feedback (auto-proceed)...');
      }
      
      // Log complete payload for validation
      console.log('[FEEDBACK] === GENERATE RESUME REQUEST PAYLOAD ===');
      console.log(JSON.stringify(payload, null, 2));
      console.log('[FEEDBACK] =======================================');
      
      const generateRes = await fetch(generateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': auth
        },
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      
      console.log('[FEEDBACK] Generate response status:', generateRes.status);
      
      if (!generateRes.ok) {
        const errorData = await generateRes.json().catch(() => ({detail: 'Failed to generate resume'}));
        throw new Error(errorData.detail || 'Failed to generate resume');
      }
      
      const generateData = await generateRes.json();
      console.log('[FEEDBACK] Phase 2 started successfully! Job ID:', generateData.job_id);
      
      // Switch to dashboard to track progress
      switchTab('dashboard');
      loadDashboardHistory();
      
      // Poll for completion using request_id (not job_id which is DB id)
      pollResumeStatusV2(backendRequestId, uiRequestId, companyName, auth);
      
    } catch (error) {
      console.error('[FEEDBACK] Error in Phase 2:', error);
      markRequestFailed(uiRequestId, error.message);
      showNotification('‚ùå Failed to generate resume: ' + error.message, 'error');
    }
  }
  
  // Poll resume status - Version 2 with auth parameter
  async function pollResumeStatusV2(requestId, uiRequestId, companyName, auth) {
    const maxAttempts = 60;
    let attempts = 0;
    
    const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:5001'
      : '';
    
    console.log('[FEEDBACK] Starting status polling for request:', requestId);
    
    const pollInterval = setInterval(async () => {
      attempts++;
      
      try {
        const statusUrl = `${apiBaseUrl}/api/jobs/${requestId}/status`;
        
        const statusRes = await fetch(statusUrl, {
          headers: {
            'Authorization': auth
          }
        });
        
        if (!statusRes.ok) {
          throw new Error('Failed to fetch status');
        }
        
        const statusData = await statusRes.json();
        console.log('[FEEDBACK] Status poll #' + attempts + ':', statusData.status, statusData.progress + '%', statusData.message);
        
        // Update progress in UI with proper message
        const progressMsg = statusData.message || statusData.status;
        if (typeof updateRequestProgress === 'function' && statusData.status === 'processing') {
          updateRequestProgress(uiRequestId, statusData.progress || 30, progressMsg);
        }
        
        if (statusData.status === 'completed') {
          clearInterval(pollInterval);
          console.log('[FEEDBACK] Resume generation COMPLETED!');
          if (typeof markRequestComplete === 'function') {
            markRequestComplete(uiRequestId, statusData.file_name || 'resume.docx');
          }
          console.log(`‚úÖ Resume generated successfully! - ${statusData.file_name || 'resume.docx'}`);
          showToast(`‚úÖ Resume generated successfully!`, 'success');
          // Reload dashboard to show new resume
          if (typeof loadDashboardHistory === 'function') {
            loadDashboardHistory();
          }
        } else if (statusData.status === 'failed') {
          clearInterval(pollInterval);
          console.error('[FEEDBACK] Resume generation FAILED:', statusData.error_message);
          if (typeof markRequestFailed === 'function') {
            markRequestFailed(uiRequestId, statusData.error_message || 'Unknown error');
          }
          console.error('‚ùå Resume generation failed: ' + (statusData.error_message || 'Unknown error'));
          showToast('‚ùå Resume generation failed: ' + (statusData.error_message || 'Unknown error'), 'error');
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(pollInterval);
          console.error('[FEEDBACK] Polling TIMEOUT after', maxAttempts, 'attempts');
          if (typeof markRequestFailed === 'function') {
            markRequestFailed(uiRequestId, 'Timeout waiting for resume');
          }
          showToast('‚ùå Resume generation timed out', 'error');
        }
      } catch (error) {
        console.error('[FEEDBACK] Error polling status:', error);
        clearInterval(pollInterval);
        if (typeof markRequestFailed === 'function') {
          markRequestFailed(uiRequestId, error.message);
        }
        showToast('‚ùå Failed to check status: ' + error.message, 'error');
      }
    }, 5000);
  }
  
  // Get keywords from a list element
  function getKeywordsFromList(listId) {
    const list = document.getElementById(listId);
    if (!list) return [];
    
    return Array.from(list.querySelectorAll('.keyword-text')).map(el => el.textContent.trim());
  }
  
  // Resume keyword review for awaiting_feedback jobs
  async function resumeKeywordReview(requestId, companyName) {
    try {
      const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:5001'
        : '';
      
      // Fetch the stored intermediate state (keywords)
      const response = await dashApiCall(`/api/jobs/${requestId}/keywords`);
      
      if (!response.keywords) {
        throw new Error('No keywords found for this job');
      }
      
      console.log('[RESUME REVIEW] Retrieved keywords:', response.keywords);
      
      // Show the keyword review modal with the stored keywords
      showKeywordReviewModal(response.keywords, requestId, requestId, companyName);
      
      // Only add to processing banner if not already there
      if (!activeRequests.has(requestId)) {
        addRequestToUI(requestId, companyName);
      }
      // Update progress regardless (in case it exists)
      updateRequestProgress(requestId, 26, '‚úì Keywords ready - Review and approve');
      
    } catch (error) {
      console.error('[RESUME REVIEW] Error:', error);
      showNotification('‚ùå Failed to load keywords: ' + error.message, 'error');
    }
  }
  
  // Poll resume status until completion
  async function pollResumeStatus(jobId, uiRequestId, companyName) {
    const maxAttempts = 60;
    let attempts = 0;
    
    const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:5001'
      : '';
    
    const pollInterval = setInterval(async () => {
      attempts++;
      
      try {
        const statusUrl = `${apiBaseUrl}/api/status/${jobId}`;
        const token = localStorage.getItem('token');
        
        const statusRes = await fetch(statusUrl, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!statusRes.ok) {
          throw new Error('Failed to fetch status');
        }
        
        const statusData = await statusRes.json();
        console.log('[FEEDBACK] Status:', statusData.status, 'Progress:', statusData.progress);
        
        // Update progress in UI
        updateRequestProgress(uiRequestId, statusData.progress, statusData.status);
        
        if (statusData.status === 'completed') {
          clearInterval(pollInterval);
          markRequestComplete(uiRequestId, statusData.file_name || 'resume.docx');
          showResult(`‚úÖ Resume generated successfully! - ${statusData.file_name || 'resume.docx'}`);
        } else if (statusData.status === 'failed') {
          clearInterval(pollInterval);
          markRequestFailed(uiRequestId, statusData.error || 'Unknown error');
          showResult('‚ùå Resume generation failed: ' + (statusData.error || 'Unknown error'));
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(pollInterval);
          markRequestFailed(uiRequestId, 'Timeout waiting for resume');
          showResult('‚ùå Resume generation timed out');
        }
      } catch (error) {
        console.error('[FEEDBACK] Error polling status:', error);
        clearInterval(pollInterval);
        markRequestFailed(uiRequestId, error.message);
        showResult('‚ùå Failed to check status: ' + error.message);
      }
    }, 5000);
  }
  
  // Toast notification system
  function showToast(message, type = 'info') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.custom-toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = 'custom-toast';
    
    const bgColors = {
      'success': 'linear-gradient(135deg, #10b981, #059669)',
      'error': 'linear-gradient(135deg, #ef4444, #dc2626)',
      'info': 'linear-gradient(135deg, #667eea, #764ba2)',
      'warning': 'linear-gradient(135deg, #f59e0b, #d97706)'
    };
    
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: ${bgColors[type] || bgColors.info};
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      font-size: 15px;
      font-weight: 500;
      max-width: 400px;
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Click to dismiss
    toast.addEventListener('click', () => {
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    });
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
      if (toast.parentElement) {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  }
  
  // Add CSS animation for toast
  if (!document.getElementById('toastAnimationStyles')) {
    const style = document.createElement('style');
    style.id = 'toastAnimationStyles';
    style.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Regenerate keywords function
  async function regenerateKeywords() {
    const modal = document.getElementById('keywordReviewModal');
    const backendRequestId = modal.dataset.backendRequestId;
    const uiRequestId = modal.dataset.uiRequestId;
    const companyName = modal.dataset.companyName;
    
    if (!backendRequestId) {
      showToast('‚ùå Unable to regenerate - missing request data', 'error');
      return;
    }
    
    try {
      console.log(`[REGENERATE][${uiRequestId}] Starting keyword regeneration for backend request:`, backendRequestId);
      
      // Update progress in UI
      updateRequestProgress(uiRequestId, 20, 'Regenerating keywords...');
      showToast('Regenerating keywords...', 'info');
      
      // Disable the regenerate button to prevent multiple clicks
      const regenerateBtn = document.querySelector('#keywordReviewModal button[onclick="regenerateKeywords()"]');
      if (regenerateBtn) {
        regenerateBtn.disabled = true;
        regenerateBtn.textContent = 'Regenerating...';
      }
      
      const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:5001'
        : '';
      
      // Get auth
      const auth = dashboardCredentials 
        ? 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        : `Bearer ${localStorage.getItem('token')}`;
      
      // Call backend to regenerate keywords
      console.log('[REGENERATE] Calling regenerate-keywords endpoint...');
      const response = await fetch(`${apiBaseUrl}/api/resume/regenerate-keywords/${backendRequestId}`, {
        method: 'POST',
        headers: {
          'Authorization': auth,
          'Content-Type': 'application/json'
        },
        cache: 'no-store'
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({detail: 'Failed to regenerate keywords'}));
        throw new Error(errorData.detail || 'Failed to regenerate keywords');
      }
      
      const result = await response.json();
      console.log('[REGENERATE] New keywords received:', result);
      
      // Update the modal with new keywords
      updateKeywordReviewModal(result.keywords);
      
      updateRequestProgress(uiRequestId, 25, 'Keywords regenerated - Review updated');
      showToast('Keywords regenerated successfully!', 'success');
      
      // Re-enable the button
      if (regenerateBtn) {
        regenerateBtn.disabled = false;
        regenerateBtn.textContent = 'Regenerate Keywords';
      }
      
    } catch (error) {
      console.error('[REGENERATE] Error:', error);
      showToast('Failed to regenerate keywords: ' + error.message, 'error');
      
      // Re-enable the button on error
      const regenerateBtn = document.querySelector('#keywordReviewModal button[onclick="regenerateKeywords()"]');
      if (regenerateBtn) {
        regenerateBtn.disabled = false;
        regenerateBtn.textContent = 'Regenerate Keywords';
      }
      
      // Reset progress
      updateRequestProgress(uiRequestId, 25, 'Regeneration failed - Review original keywords');
    }
  }
  
  // Helper function to update modal with new keywords
  function updateKeywordReviewModal(keywords) {
    console.log('[MODAL-UPDATE] Updating modal with new keywords');
    
    // Update technical keywords
    const techList = document.getElementById('technicalKeywordsList');
    if (techList && keywords.technical_keywords) {
      techList.innerHTML = '';
      keywords.technical_keywords.forEach(keyword => {
        const item = document.createElement('div');
        item.className = 'keyword-item';
        item.innerHTML = `
          <span class="keyword-text" contenteditable="false" onclick="editKeyword(this)" title="Click to edit">${keyword}</span>
          <button class="keyword-remove-btn" onclick="removeKeyword(this)" title="Remove">√ó</button>
        `;
        techList.appendChild(item);
      });
    }
    
    // Update soft skills
    const softList = document.getElementById('softSkillsList');
    if (softList && keywords.soft_skills_role_keywords) {
      softList.innerHTML = '';
      keywords.soft_skills_role_keywords.forEach(skill => {
        const item = document.createElement('div');
        item.className = 'keyword-item';
        item.innerHTML = `
          <span class="keyword-text" contenteditable="false" onclick="editKeyword(this)" title="Click to edit">${skill}</span>
          <button class="keyword-remove-btn" onclick="removeKeyword(this)" title="Remove">√ó</button>
        `;
        softList.appendChild(item);
      });
    }
    
    // Update phrases
    const phrasesList = document.getElementById('phrasesList');
    if (phrasesList && keywords.phrases) {
      phrasesList.innerHTML = '';
      keywords.phrases.forEach(phrase => {
        const item = document.createElement('div');
        item.className = 'keyword-item';
        item.innerHTML = `
          <span class="keyword-text" contenteditable="false" onclick="editKeyword(this)" title="Click to edit">${phrase}</span>
          <button class="keyword-remove-btn" onclick="removeKeyword(this)" title="Remove">√ó</button>
        `;
        phrasesList.appendChild(item);
      });
    }
    
    // Update counts
    updateKeywordCounts();
    
    console.log('[MODAL-UPDATE] Modal updated successfully');
  }
  
  // Close keyword review modal
  async function closeKeywordReviewModal(markAsCancelled = true) {
    const modal = document.getElementById('keywordReviewModal');
    if (modal) {
      // Get both request IDs before closing
      const uiRequestId = modal.dataset.uiRequestId;
      const backendRequestId = modal.dataset.backendRequestId;
      
      console.log(`[CLOSE][${uiRequestId}] Closing modal - markAsCancelled:`, markAsCancelled);
      console.log(`[CLOSE] Backend request ID:`, backendRequestId);
      console.log(`[CLOSE] Current queue length:`, keywordReviewQueue.length);
      console.log(`[CLOSE] Remaining requests in queue:`, keywordReviewQueue.map(q => q.uiRequestId));
      
      // Only mark as cancelled if explicitly requested (user clicked X or Cancel button)
      // Don't mark as cancelled when user clicks "Save Changes" (markAsCancelled = false)
      if (markAsCancelled && backendRequestId) {
        console.log('[KEYWORD MODAL] Cancelling job on backend:', backendRequestId);
        
        // Cancel the job on the backend
        try {
          const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5001'
            : '';
          
          const auth = dashboardCredentials 
            ? 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
            : `Bearer ${localStorage.getItem('token')}`;
          
          const response = await fetch(`${apiBaseUrl}/api/jobs/${backendRequestId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': auth
            },
            cache: 'no-store'
          });
          
          if (response.ok) {
            console.log('[KEYWORD MODAL] Job cancelled successfully on backend');
            showToast('üö´ Job cancelled successfully', 'info');
          } else {
            console.error('[KEYWORD MODAL] Failed to cancel job on backend:', response.status);
          }
        } catch (error) {
          console.error('[KEYWORD MODAL] Error cancelling job:', error);
        }
        
        // Also clean up frontend state
        if (uiRequestId && activeRequests.has(uiRequestId)) {
          markRequestFailed(uiRequestId, 'Cancelled by user');
        }
      }
      
      // Clear modal data
      modal.dataset.backendRequestId = '';
      modal.dataset.uiRequestId = '';
      modal.dataset.companyName = '';
      
      modal.style.display = 'none';
      
      // Mark modal as closed
      isModalOpen = false;
      console.log(`[CLOSE] Modal marked as CLOSED`);
      
      // Process next item in queue if any
      console.log('[CLOSE] Checking queue for next item...');
      setTimeout(() => {
        processKeywordReviewQueue();
      }, 300); // Small delay to ensure smooth transition
    }
  }
  
  // Remove keyword from list
  function removeKeyword(button) {
    button.closest('.keyword-item').remove();
    updateKeywordCounts();
  }
  
  // Add keyword to list
  function addKeywordToList(listId, inputId) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    
    if (!input || !list) return;
    
    const keyword = input.value.trim();
    if (keyword) {
      const item = document.createElement('div');
      item.className = 'keyword-item';
      item.innerHTML = `
        <span class="keyword-text" contenteditable="false" onclick="editKeyword(this)" title="Click to edit">${keyword}</span>
        <button class="keyword-remove-btn" onclick="removeKeyword(this)" title="Remove">√ó</button>
      `;
      list.appendChild(item);
      input.value = '';
      updateKeywordCounts();
    }
  }
  

  // Toggle resume download menu
  function toggleResumeDownloadMenu() {
    const menu = document.getElementById('resumeDownloadMenu');
    if (menu) {
      menu.classList.toggle('show');
    }
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.rb-download-dropdown')) {
      const menu = document.getElementById('resumeDownloadMenu');
      if (menu) menu.classList.remove('show');
    }
  });
  
  // Confirm before clearing all
  async function confirmClearAll() {
    const confirmed = await customConfirm(
      'Clear All Data',
      'Are you sure you want to clear all resume data? This action cannot be undone.'
    );
    if (confirmed) {
      clearAll();
    }
  }

  function clearAll(){
    // Reset form
    document.getElementById('resumeForm').reset();
    document.getElementById('contactList').innerHTML='';
    document.getElementById('skillsList').innerHTML='';
    document.getElementById('experienceList').innerHTML='';
    document.getElementById('educationList').innerHTML='';
    document.getElementById('projectsList').innerHTML='';
    document.getElementById('certificationsList').innerHTML='';
    const jobDescTab = document.getElementById('jobDescriptionTab');
    const companyNameJD = document.getElementById('companyNameJD');
    if (jobDescTab) jobDescTab.value = '';
    if (companyNameJD) companyNameJD.value = '';
    addContact('Phone', '');addContact('Email', '');addContact('LinkedIn', '');
    addSkill();addExperience();addEducation();addProject();addCertification();showNotification('üßπ Cleared all fields');}

  function showResult(msg){showNotification(msg);}
  
  function showNotification(message, type = 'success', duration = 3000) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : 'var(--accent)'};
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-size: 14px;
      font-weight: 500;
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  // Custom confirm dialog to replace browser confirm()
  let customConfirmActive = false;
  
  function customConfirm(message, title = 'Confirm Action') {
    
    // Prevent multiple simultaneous confirms
    if (customConfirmActive) {
      console.log('[customConfirm] Already active, ignoring duplicate call');
      return new Promise((resolve) => resolve(false));
    }
    
    customConfirmActive = true;
    
    return new Promise((resolve) => {
      const modal = document.getElementById('customConfirmModalBodyLevel');
      const modalTitle = document.getElementById('confirmModalTitleBodyLevel');
      const modalMessage = document.getElementById('confirmModalMessageBodyLevel');
      const cancelBtn = document.getElementById('confirmModalCancelBodyLevel');
      const okBtn = document.getElementById('confirmModalOkBodyLevel');
      
      if (!modal || !modalTitle || !modalMessage || !cancelBtn || !okBtn) {
        customConfirmActive = false;
        resolve(false);
        return;
      }
      
      // Clone buttons to remove all existing event listeners
      const newCancelBtn = cancelBtn.cloneNode(true);
      const newOkBtn = okBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      okBtn.parentNode.replaceChild(newOkBtn, okBtn);
      
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modal.style.display = 'flex';
      
      const handleCancel = () => {
        modal.style.display = 'none';
        customConfirmActive = false;
        resolve(false);
      };
      
      const handleOk = () => {
        modal.style.display = 'none';
        customConfirmActive = false;
        resolve(true);
      };
      
      newCancelBtn.addEventListener('click', handleCancel, { once: true });
      newOkBtn.addEventListener('click', handleOk, { once: true });
    });
  }

  /* ---------- ABOUT MODAL ---------- */
  // About modal is handled in main.js

  /* ---------- FAQ ACCORDION ---------- */
  function toggleFAQ(button) {
    const faqItem = button.parentElement;
    const isActive = faqItem.classList.contains('active');
    
    // Close all FAQ items
    document.querySelectorAll('.faq-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Open clicked item if it wasn't active
    if (!isActive) {
      faqItem.classList.add('active');
    }
  }

  /* ---------- FAQ SECTION TOGGLE ---------- */
  function toggleFAQSection() {
    const faqSection = document.getElementById('faqSection');
    if (faqSection.classList.contains('active')) {
      faqSection.classList.remove('active');
    } else {
      faqSection.classList.add('active');
      // Scroll to FAQ section smoothly
      setTimeout(() => {
        faqSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
  }

  // --------- TAB SWITCHING LOGIC ---------
  const tabResumeBtn = document.getElementById('tabResumeBtn');
  const tabEditJDBtn = document.getElementById('tabEditJDBtn');
  const tabEmailWriterBtn = document.getElementById('tabEmailWriterBtn');
  const tabDashboardBtn = document.getElementById('tabDashboardBtn');
  const resumeFormContainer = document.getElementById('resumeFormContainer');
  const jobDescTabPanel = document.getElementById('jobDescTabPanel');
  const emailWriterTabPanel = document.getElementById('emailWriterTabPanel');
  const dashboardTabPanel = document.getElementById('dashboardTabPanel');
  
  let emailWriterInitialized = false;
  let pendingTabSwitch = null;

  function switchTab(tab) {
    // Check for unsaved changes when leaving resume tab
    if (resumeFormContainer.classList.contains('active') && tab !== 'resume' && formHasChanges) {
      // Store the pending tab to switch to
      pendingTabSwitch = tab;
      
      // Show custom confirmation modal
      const modal = document.getElementById('unsavedChangesModal');
      modal.style.display = 'flex';
      
      // Stop here - don't switch tabs yet
      return;
    }
    
    // Remove active from all tabs
    tabResumeBtn.classList.remove('active');
    tabEditJDBtn.classList.remove('active');
    tabJobSearchBtn.classList.remove('active');
    tabEmailWriterBtn.classList.remove('active');
    tabDashboardBtn.classList.remove('active');
    resumeFormContainer.classList.remove('active');
    jobDescTabPanel.classList.remove('active');
    jobSearchTabPanel.style.display = 'none';
    jobSearchTabPanel.style.visibility = 'hidden'; // Safari fix
    emailWriterTabPanel.style.display = 'none';
    emailWriterTabPanel.style.visibility = 'hidden'; // Safari fix
    dashboardTabPanel.classList.remove('active');

    // Force hide job description elements when not in JD tab
    const jdTextarea = document.getElementById('jobDescriptionTab');
    const jdContainer = document.querySelector('.jd-textarea-container');
    
    // Activate the selected tab
    if (tab === 'resume') {
      tabResumeBtn.classList.add('active');
      resumeFormContainer.classList.add('active');
      resumeFormContainer.style.visibility = 'visible'; // Safari fix
      // Hide JD elements
      if (jdTextarea) jdTextarea.style.display = 'none';
      if (jdContainer) jdContainer.style.display = 'none';
    } else if (tab === 'jd') {
      tabEditJDBtn.classList.add('active');
      jobDescTabPanel.classList.add('active');
      jobDescTabPanel.style.visibility = 'visible'; // Safari fix
      // Show JD elements
      if (jdTextarea) jdTextarea.style.display = 'block';
      if (jdContainer) jdContainer.style.display = 'flex';
    } else if (tab === 'jobsearch') {
      tabJobSearchBtn.classList.add('active');
      jobSearchTabPanel.style.display = 'block';
      jobSearchTabPanel.style.visibility = 'visible'; // Safari fix
      // Hide JD elements
      if (jdTextarea) jdTextarea.style.display = 'none';
      if (jdContainer) jdContainer.style.display = 'none';
    } else if (tab === 'emailwriter') {
      tabEmailWriterBtn.classList.add('active');
      emailWriterTabPanel.style.display = 'block';
      emailWriterTabPanel.style.visibility = 'visible'; // Safari fix
      // Hide JD elements
      if (jdTextarea) jdTextarea.style.display = 'none';
      if (jdContainer) jdContainer.style.display = 'none';
      // Initialize email writer on first load
      if (!emailWriterInitialized) {
        showCustomEmailMode();
        loadEmailHistory();
        emailWriterInitialized = true;
      }
    } else if (tab === 'dashboard') {
      tabDashboardBtn.classList.add('active');
      dashboardTabPanel.classList.add('active');
      dashboardTabPanel.style.visibility = 'visible'; // Safari fix
      // Hide JD elements
      if (jdTextarea) jdTextarea.style.display = 'none';
      if (jdContainer) jdContainer.style.display = 'none';
      loadDashboardStats(); // Load stats when dashboard tab is opened
      loadDashboardHistory(); // Load resume history
    }
  }
  
  tabResumeBtn.addEventListener('click', () => switchTab('resume'));
  tabEditJDBtn.addEventListener('click', () => switchTab('jd'));
  tabJobSearchBtn.addEventListener('click', () => switchTab('jobsearch'));
  tabEmailWriterBtn.addEventListener('click', () => switchTab('emailwriter'));
  tabDashboardBtn.addEventListener('click', () => switchTab('dashboard'));

  // --------- INIT ---------
  // Initialize with common contact fields
  document.getElementById('contactList').innerHTML = '';
  addContact('Phone', '');
  addContact('Email', '');
  addContact('LinkedIn', '');
  addSkill();addExperience();addEducation();addProject();addCertification();
  // Default: show Resume tab
  switchTab('resume');

  // --------- JOB DESC TAB PANEL LOGIC ---------
  const jobDescriptionTab = document.getElementById('jobDescriptionTab');
  
  // Generate Resume Based on JD button
  const generateJDResumeBtn = document.getElementById('generateJDResumeBtn');
  console.log('Generate JD Resume Button found:', generateJDResumeBtn);
  
  if (generateJDResumeBtn) {
    console.log('Adding TWO-PHASE click listener to Generate JD Resume button');
    generateJDResumeBtn.addEventListener('click', async function() {
      console.log('[FEEDBACK] Generate JD Resume button clicked - Starting two-phase workflow!');
      
      const jdText = jobDescriptionTab.value.trim();
      const companyName = document.getElementById('companyNameJD').value.trim();
      const jobTitle = document.getElementById('jobTitleJD').value.trim();
      const jobLink = document.getElementById('jobLinkJD')?.value.trim() || '';
      
      console.log('Form values:', { companyName, jobTitle, jdTextLength: jdText.length, jobLink });
      
      if (!companyName) {
        showNotification('Please enter the company name!', 'warning');
        document.getElementById('companyNameJD').focus();
        return;
      }
      
      if (!jobTitle) {
        showNotification('Please enter the job title!', 'warning');
        document.getElementById('jobTitleJD').focus();
        return;
      }
      
      if (!jdText) {
        showNotification('Please paste a job description first!', 'warning');
        return;
      }

      // Check if user is logged in
      if (!dashboardCredentials) {
        showNotification('Please login first to generate resumes!', 'warning');
        switchTab('dashboard');
        return;
      }

      // Get resume data from form
      const resumeData = getResumeData();
      
      // Get selected mode from radio button
      const resumeModeRadio = document.querySelector('input[name="resumeMode"]:checked');
      const resumeMode = resumeModeRadio ? resumeModeRadio.value : 'complete_jd';
      
      // Get selected format from radio button
      const resumeFormatRadio = document.querySelector('input[name="resumeFormat"]:checked');
      const resumeFormat = resumeFormatRadio ? resumeFormatRadio.value : 'classic';
      
      console.log('Selected mode:', resumeMode);
      console.log('Selected format:', resumeFormat);
      
      const uiRequestId = `req_${Date.now()}_${dashboardCredentials.username}`;
      
      // Check and store keyword review preference for THIS request
      const checkboxElement = document.getElementById('enableKeywordReview');
      const enableKeywordReview = checkboxElement?.checked || false;
      console.log(`[FEEDBACK][${uiRequestId}] Checkbox checked status at request start:`, enableKeywordReview);
      
      // Add to processing banner
      addRequestToUI(uiRequestId, companyName);
      updateRequestProgress(uiRequestId, 0, 'Extracting keywords...');
      
      // PHASE 1: Extract keywords
      try {
        const requestData = {
          mode: resumeMode,
          format: resumeFormat,
          resume_data: resumeData,
          job_description_data: {
            company_name: companyName,
            job_title: jobTitle,
            job_description: jdText
          }
        };
        
        // Add job_link if provided
        if (jobLink) {
          requestData.job_link = jobLink;
        }

        console.log('[FEEDBACK] Phase 1: Calling extract-keywords endpoint...');

        const extractResponse = await fetch(`${API_BASE_URL}/api/resume/extract-keywords`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
          },
          body: JSON.stringify(requestData),
          cache: 'no-store'
        });

        console.log('[FEEDBACK] Extract response status:', extractResponse.status);

        if (!extractResponse.ok) {
          const error = await extractResponse.json().catch(() => ({ detail: 'Failed to extract keywords' }));
          throw new Error(error.detail || 'Failed to extract keywords');
        }

        const extractResult = await extractResponse.json();
        console.log(`[FEEDBACK][${uiRequestId}] Phase 1 SUCCESS! Keywords extracted:`, extractResult);
        console.log(`[FEEDBACK][${uiRequestId}] Mode from backend:`, extractResult.keywords?.mode);
        console.log(`[FEEDBACK][${uiRequestId}] Using stored keyword review preference:`, enableKeywordReview);
        
        if (enableKeywordReview) {
          // Show keyword review modal for user to edit
          console.log(`[FEEDBACK][${uiRequestId}] Keyword review ENABLED - adding to modal queue`);
          updateRequestProgress(uiRequestId, 25, 'Keywords extracted - Review required');
          showKeywordReviewModalV2(extractResult.keywords, extractResult.request_id, uiRequestId, companyName);
        } else {
          // Skip review, proceed directly to Phase 2
          console.log(`[FEEDBACK][${uiRequestId}] Keyword review DISABLED - proceeding directly to generation`);
          updateRequestProgress(uiRequestId, 30, 'Generating resume...');
          await proceedToGenerationPhase(extractResult.request_id, uiRequestId, companyName, null, extractResult.keywords?.mode);
        }
        
      } catch (error) {
        console.error('[FEEDBACK] Phase 1 failed:', error);
        markRequestFailed(uiRequestId, error.message);
        showNotification(`Error extracting keywords: ${error.message}`, 'error');
      }
    });
  } else {
    console.error('Generate JD Resume button NOT found in DOM!');
  }
  
  // Show keyword review modal - Version 2 for this button
  function showKeywordReviewModalV2(jdHints, backendRequestId, uiRequestId, companyName) {
    console.log(`[QUEUE-V2][${uiRequestId}] Requesting keyword review modal`);
    console.log(`[QUEUE-V2][${uiRequestId}] Current queue length BEFORE adding:`, keywordReviewQueue.length);
    console.log(`[QUEUE-V2][${uiRequestId}] Modal currently open:`, isModalOpen);
    
    // Add to queue
    keywordReviewQueue.push({
      jdHints,
      backendRequestId,
      uiRequestId,
      companyName
    });
    
    console.log(`[QUEUE-V2][${uiRequestId}] Added to queue. New queue length:`, keywordReviewQueue.length);
    console.log(`[QUEUE-V2] Full queue state:`, keywordReviewQueue.map(q => q.uiRequestId));
    
    // Process queue if modal is not currently open
    processKeywordReviewQueue();
  }

  // Load Sample JD for the tab textarea
  function loadSampleJobDescTab() {
    const sampleText = `We are looking for a skilled Software Engineer with experience in JavaScript, React, and Node.js. The candidate should have strong problem-solving skills and the ability to work in a fast-paced environment. Responsibilities include developing new features, optimizing performance, and collaborating with cross-functional teams.`;
    if (jobDescriptionTab) jobDescriptionTab.value = sampleText;
  }
  // Optionally, allow loading sample JD when double-clicking the textarea
  if (jobDescriptionTab) {
    jobDescriptionTab.addEventListener('dblclick', loadSampleJobDescTab);
  }

  /* ---------- INITIALIZE PAGE ---------- */
  // Show Basic Info section by default
  window.addEventListener('DOMContentLoaded', function() {
    const basicSection = document.getElementById('section-basic');
    const basicBtn = document.querySelector('.form-nav-btn');
    
    if (basicSection) {
      basicSection.classList.add('active');
    }
    if (basicBtn) {
      basicBtn.classList.add('active');
    }
    
    // Initialize change tracking for the form
    setupChangeTracking();
    
    // Setup unsaved changes modal handlers
    const modal = document.getElementById('unsavedChangesModal');
    const cancelBtn = document.getElementById('cancelTabSwitch');
    const discardBtn = document.getElementById('discardChanges');
    const saveBtn = document.getElementById('saveAndSwitch');
    
    // Cancel - stay on current tab
    cancelBtn.addEventListener('click', function() {
      modal.style.display = 'none';
      pendingTabSwitch = null;
    });
    
    // Discard changes - reload original data and switch
    discardBtn.addEventListener('click', async function() {
      modal.style.display = 'none';
      formHasChanges = false;
      
      // Reload the original template to discard changes
      await loadResumeTemplate();
      
      if (pendingTabSwitch) {
        const tab = pendingTabSwitch;
        pendingTabSwitch = null;
        switchTab(tab);
      }
    });
    
    // Save - save then switch
    saveBtn.addEventListener('click', async function() {
      modal.style.display = 'none';
      await saveResumeTemplate();
      formHasChanges = false;
      if (pendingTabSwitch) {
        const tab = pendingTabSwitch;
        pendingTabSwitch = null;
        switchTab(tab);
      }
    });
    
    // Close modal on background click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
        pendingTabSwitch = null;
      }
    });
  });

  /* ---------- DASHBOARD FUNCTIONALITY ---------- */
  // Note: All dashboard variables (API_BASE_URL, dashboardCredentials, currentPage, etc.)
  // are declared at the top of the script to avoid temporal dead zone issues

  // Format UTC datetime to local timezone
  function formatLocalDateTime(utcDateString) {
    if (!utcDateString) return 'N/A';
    
    // Create date object - if the string ends with 'Z' it's already marked as UTC
    // If not, we need to treat it as UTC
    let date;
    if (utcDateString.endsWith('Z')) {
      date = new Date(utcDateString);
    } else {
      // Assume UTC if no timezone marker
      date = new Date(utcDateString + 'Z');
    }
    
    // Format to local timezone
    const dateStr = date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });
    
    const timeStr = date.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit', 
      hour12: true 
    });
    
    return `${dateStr} ${timeStr}`;
  }

  // Change page size function
  function changePageSize() {
    const select = document.getElementById('pageSizeSelect');
    dashboardPageSize = parseInt(select.value);
    currentPage = 1; // Reset to first page when changing page size
    loadDashboardHistory();
  }

  // Change page function
  function changePage(page) {
    currentPage = page;
    loadDashboardHistory();
  }

  // Render pagination controls
  function renderPagination() {
    const totalPages = Math.ceil(totalJobs / dashboardPageSize);
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let paginationHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px;">';
    
    // Previous button
    paginationHTML += `
      <button onclick="changePage(${currentPage - 1})" 
        ${currentPage === 1 ? 'disabled' : ''} 
        style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === 1 ? '0.5' : '1'};">
        ‚Üê Previous
      </button>
    `;
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page
    if (startPage > 1) {
      paginationHTML += `
        <button onclick="changePage(1)" 
          style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: pointer;">
          1
        </button>
      `;
      if (startPage > 2) {
        paginationHTML += '<span style="padding: 8px;">...</span>';
      }
    }
    
    // Visible page numbers
    for (let i = startPage; i <= endPage; i++) {
      paginationHTML += `
        <button onclick="changePage(${i})" 
          style="padding: 8px 12px; border: 1px solid ${i === currentPage ? 'var(--accent)' : 'var(--border)'}; border-radius: var(--radius-sm); background: ${i === currentPage ? 'var(--accent)' : 'var(--bg)'}; color: ${i === currentPage ? 'white' : 'var(--text)'}; cursor: pointer; font-weight: ${i === currentPage ? '600' : '400'};">
          ${i}
        </button>
      `;
    }
    
    // Last page
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML += '<span style="padding: 8px;">...</span>';
      }
      paginationHTML += `
        <button onclick="changePage(${totalPages})" 
          style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: pointer;">
          ${totalPages}
        </button>
      `;
    }
    
    // Next button
    paginationHTML += `
      <button onclick="changePage(${currentPage + 1})" 
        ${currentPage === totalPages ? 'disabled' : ''} 
        style="padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === totalPages ? '0.5' : '1'};">
        Next ‚Üí
      </button>
    `;
    
    paginationHTML += '</div>';
    paginationHTML += `<div style="text-align: center; padding: 0 0 20px 0; font-size: 13px; color: var(--text-secondary);">
      Page ${currentPage} of ${totalPages} (${totalJobs} total results)
    </div>`;
    
    paginationContainer.innerHTML = paginationHTML;
  }

  // Filter dashboard table - reload from server with filters
  function filterDashboardTable() {
    currentPage = 1; // Reset to first page when filtering
    loadDashboardHistory();
  }

  // Clear all filters
  function clearDashboardFilters() {
    document.getElementById('filterCompany').value = '';
    document.getElementById('filterJobTitle').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterDate').value = '';
    currentPage = 1; // Reset to first page when clearing filters
    filterDashboardTable();
  }

  // Auth Tab Switching
  function switchAuthTab(tab) {
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');

    if (tab === 'login') {
      loginTabBtn.classList.add('active');
      registerTabBtn.classList.remove('active');
      loginForm.classList.add('active');
      registerForm.classList.remove('active');
    } else {
      registerTabBtn.classList.add('active');
      loginTabBtn.classList.remove('active');
      registerForm.classList.add('active');
      loginForm.classList.remove('active');
    }
  }

  // Dashboard Panels Switching
  function switchDashTab(tab) {
    const genBtn = document.getElementById('dashGenTab');
    const histBtn = document.getElementById('dashHistTab');
    const genPanel = document.getElementById('dashGeneratePanel');
    const histPanel = document.getElementById('dashHistoryPanel');

    if (tab === 'generate') {
      genBtn.classList.add('active');
      histBtn.classList.remove('active');
      genPanel.classList.add('active');
      histPanel.style.display = 'none';
    } else {
      histBtn.classList.add('active');
      genBtn.classList.remove('active');
      histPanel.style.display = 'block';
      genPanel.classList.remove('active');
      loadDashboardHistory();
    }
  }

  // Show Message
  function showDashMessage(message, type = 'info') {
    const authMsg = document.getElementById('authMessage');
    const dashMsg = document.getElementById('dashboardMessage');
    
    const msgBox = dashboardCredentials ? dashMsg : authMsg;
    msgBox.style.display = 'block';
    msgBox.style.background = type === 'error' ? '#fed7d7' : type === 'success' ? '#c6f6d5' : '#bee3f8';
    msgBox.style.color = type === 'error' ? '#742a2a' : type === 'success' ? '#22543d' : '#2c5282';
    msgBox.style.border = `1px solid ${type === 'error' ? '#fc8181' : type === 'success' ? '#9ae6b4' : '#90cdf4'}`;
    msgBox.textContent = message;
    setTimeout(() => msgBox.style.display = 'none', 5000);
  }

  // API Call Helper
  // Update application status
  async function updateApplicationStatus(jobId, newStatus) {
    try {
      const now = new Date().toISOString();
      await dashApiCall(`/api/resumes/${jobId}/application-status`, {
        method: 'PATCH',
        body: JSON.stringify({
          application_status: newStatus,
          application_date: (newStatus === 'applied') ? now : null
        })
      });
      
      showNotification(`Application status updated to: ${newStatus.replace('_', ' ')}`, 'success');
      
      // Reload dashboard to show updated date
      await loadDashboardHistory();
      await loadDashboardStats();
    } catch (error) {
      console.error('Failed to update application status:', error);
      showNotification('Failed to update status: ' + error.message, 'error');
      // Reload to reset dropdown
      await refreshDashboard();
    }
  }

  async function dashApiCall(endpoint, options = {}) {
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers
    };

    if (dashboardCredentials) {
      console.log('[API] Calling', endpoint, 'as user:', dashboardCredentials.username);
      headers['Authorization'] = 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`);
    }

    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers,
      cache: 'no-store' // Prevent browser caching of API responses
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ detail: 'Request failed' }));
      
      // Extract the error message from backend
      const errorMessage = error.detail || error.message || 'Request failed';
      
      throw new Error(errorMessage);
    }

    return response.json();
  }

  // Handle Register
  async function handleDashboardRegister() {
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerPasswordConfirm').value;

    if (!username || !password) {
      showDashMessage('Please fill in all fields', 'error');
      return;
    }

    if (password !== confirm) {
      showDashMessage('Passwords do not match!', 'error');
      return;
    }

    try {
      await dashApiCall('/api/auth/register', {
        method: 'POST',
        body: JSON.stringify({ user_id: username, password })
      });

      showDashMessage('Account created! Please login.', 'success');
      switchAuthTab('login');
      document.getElementById('loginUsername').value = username;
    } catch (error) {
      showDashMessage(error.message, 'error');
    }
  }

  // Handle Login
  async function handleDashboardLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
      showDashMessage('Please enter username and password', 'error');
      return;
    }

    dashboardCredentials = { username, password };

    try {
      await dashApiCall('/api/auth/login', { method: 'POST' });
      
      // Show dashboard view
      document.getElementById('authView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'block';
      
      loadDashboardStats();
      loadDashboardHistory();
    } catch (error) {
      dashboardCredentials = null;
      // Display specific error message from backend
      const errorMessage = error.message || 'Login failed. Please try again.';
      showDashMessage(errorMessage, 'error');
    }
  }

  // Handle Logout
  function handleDashboardLogout() {
    dashboardCredentials = null;
    document.getElementById('authView').style.display = 'block';
    document.getElementById('dashboardView').style.display = 'none';
    
    // Clear poll intervals
    Object.values(dashboardPollIntervals).forEach(clearInterval);
    dashboardPollIntervals = {};
    
    // Clear forms
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
  }

  // Load User Stats
  async function loadDashboardStats() {
    try {
      const stats = await dashApiCall('/api/user/stats');
      
      // Calculate progress percentages for visual effect
      const totalProgress = Math.min((stats.total_resumes / 50) * 100, 100); // Scale to 50 resumes
      const todayProgress = Math.min((stats.today_resumes / 10) * 100, 100); // Scale to 10 per day
      const activeProgress = (stats.active_jobs / stats.limits.max_concurrent_jobs) * 100;
      
      document.getElementById('statsCards').innerHTML = `
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #667eea; stroke-dashoffset: ${327 - (327 * totalProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.total_resumes}</div>
          </div>
          <div class="stat-label-modern">TOTAL RESUMES</div>
        </div>
        
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #f5576c; stroke-dashoffset: ${327 - (327 * todayProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.today_resumes}</div>
          </div>
          <div class="stat-label-modern">TODAY</div>
        </div>
        
        <div class="stat-card-modern">
          <div class="stat-ring-container">
            <svg class="stat-ring" viewBox="0 0 120 120">
              <circle class="stat-ring-bg" cx="60" cy="60" r="52" />
              <circle class="stat-ring-progress" cx="60" cy="60" r="52" 
                style="stroke: #00f2fe; stroke-dashoffset: ${327 - (327 * activeProgress / 100)};" />
            </svg>
            <div class="stat-value-inside">${stats.active_jobs}</div>
          </div>
          <div class="stat-label-modern">PROCESSING</div>
        </div>
      `;
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  }

  // Load Resume File
  function loadDashResumeFile(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('dashResumeJSON').value = e.target.result;
      };
      reader.readAsText(file);
    }
  }

  // Handle Generate Resume
  async function handleDashboardGenerate() {
    const companyName = document.getElementById('dashCompanyName').value;
    const jobTitle = document.getElementById('dashJobTitle').value;
    const jd = document.getElementById('dashJobDescription').value;
    const mode = document.getElementById('dashMode').value;
    const resumeJSONText = document.getElementById('dashResumeJSON').value;

    if (!companyName || !jobTitle || !jd) {
      showDashMessage('Please fill in company name, job title, and job description', 'error');
      return;
    }

    let resumeData;
    try {
      resumeData = resumeJSONText ? JSON.parse(resumeJSONText) : {};
    } catch (e) {
      showDashMessage('Invalid JSON format in resume data!', 'error');
      return;
    }

    const requestData = {
      mode: mode,
      resume_data: resumeData,
      job_description_data: {
        company_name: companyName,
        job_title: jobTitle,
        job_description: jd
      },
      request_id: `req_${Date.now()}_${dashboardCredentials.username}`
    };

    const btn = document.getElementById('dashGenerateBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    try {
      const result = await dashApiCall('/api/generate_resume_json', {
        method: 'POST',
        body: JSON.stringify(requestData)
      });

      showDashMessage(`Resume generation started! Request ID: ${result.request_id}`, 'success');
      
      // Switch to history tab
      switchDashTab('history');
      
      // Start polling for this job
      startDashboardPolling(result.request_id);
      
    } catch (error) {
      showDashMessage(error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate Resume';
    }
  }

  // Kebab Menu Functions
  function toggleKebabMenu(event, requestId) {
    event.stopPropagation();
    const button = event.currentTarget;
    const dropdown = document.getElementById(`kebab-${requestId}`);
    const allDropdowns = document.querySelectorAll('.kebab-dropdown');
    
    // Close all other dropdowns
    allDropdowns.forEach(d => {
      if (d !== dropdown) d.style.display = 'none';
    });
    
    // Toggle current dropdown
    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
    } else {
      // Position dropdown using fixed positioning
      const rect = button.getBoundingClientRect();
      const dropdownHeight = 220; // Approximate height of dropdown
      const spaceBelow = window.innerHeight - rect.bottom;
      const spaceAbove = rect.top;
      
      // Position dropdown to the left of the button
      dropdown.style.right = 'auto';
      dropdown.style.left = (rect.right - 200) + 'px'; // 200px is dropdown width
      
      // Open upward if not enough space below
      if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
        dropdown.style.top = 'auto';
        dropdown.style.bottom = (window.innerHeight - rect.top) + 'px';
      } else {
        dropdown.style.top = (rect.bottom + 8) + 'px';
        dropdown.style.bottom = 'auto';
      }
      
      dropdown.style.display = 'block';
    }
  }

  function closeKebabMenu(requestId) {
    const dropdown = document.getElementById(`kebab-${requestId}`);
    if (dropdown) {
      dropdown.style.display = 'none';
    }
  }

  // Close kebab menus when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.kebab-menu-btn')) {
      document.querySelectorAll('.kebab-dropdown').forEach(d => {
        d.style.display = 'none';
      });
    }
  });

  // Start Polling Job Status
  function startDashboardPolling(requestId) {
    // Stop existing polling if it exists
    if (dashboardPollIntervals[requestId]) {
      console.log('[POLLING] Polling already exists for:', requestId, '- skipping');
      return;
    }

    console.log('[POLLING] Starting polling for:', requestId);
    
    let pollCount = 0;
    const maxPolls = 150; // 5 minutes max (150 * 2s = 300s)
    
    dashboardPollIntervals[requestId] = setInterval(async () => {
      pollCount++;
      
      // Stop polling after 5 minutes
      if (pollCount > maxPolls) {
        console.log('[POLLING] Max polling duration reached (5 minutes), stopping for:', requestId);
        clearInterval(dashboardPollIntervals[requestId]);
        delete dashboardPollIntervals[requestId];
        showDashMessage('Job is taking longer than expected. Please refresh to check status.', 'warning');
        return;
      }
      
      try {
        const status = await dashApiCall(`/api/jobs/${requestId}/status`);
        console.log('[POLLING] Update received for', requestId);
        console.log('[POLLING] Status:', status.status);
        console.log('[POLLING] Progress:', status.progress);
        console.log('[POLLING] Message:', status.message);
        
        // Update processing banner with progress (only for processing and pending states)
        if ((status.status === 'processing' || status.status === 'pending') && status.progress !== undefined) {
          const progressMsg = status.message || `${status.progress}% complete`;
          updateRequestProgress(requestId, status.progress, progressMsg);
        }
        
        updateDashboardJobCard(requestId, status);

        if (status.status === 'completed') {
          console.log('[POLLING] Job completed, stopping polling for:', requestId);
          clearInterval(dashboardPollIntervals[requestId]);
          delete dashboardPollIntervals[requestId];
          markRequestComplete(requestId, `${status.company_name}_${status.job_title}_Resume.docx`);
          loadDashboardStats();
          // Reload history to update UI without restarting polling
          setTimeout(() => loadDashboardHistory(), 100);
        } else if (status.status === 'failed') {
          console.log('[POLLING] Job failed, stopping polling for:', requestId);
          clearInterval(dashboardPollIntervals[requestId]);
          delete dashboardPollIntervals[requestId];
          markRequestFailed(requestId, status.error_message);
          loadDashboardStats();
          // Reload history to update UI without restarting polling
          setTimeout(() => loadDashboardHistory(), 100);
        }
      } catch (error) {
        console.error('[POLLING] Polling error:', error);
      }
    }, 2000); // Poll every 2 seconds
  }

  // Update Job Card/Row
  function updateDashboardJobCard(requestId, data) {
    console.log('[DASHBOARD UPDATE] Request ID:', requestId);
    console.log('[DASHBOARD UPDATE] Data received:', JSON.stringify(data, null, 2));
    
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    console.log('[DASHBOARD UPDATE] Found row:', row ? 'YES' : 'NO');
    
    if (!row) {
      console.log('[DASHBOARD UPDATE] Row not found, reloading history');
      loadDashboardHistory();
      return;
    }

    // Update status badge (3rd column)
    const statusCell = row.cells[2];
    if (statusCell) {
      const badge = statusCell.querySelector('.status-badge');
      if (badge) {
        badge.className = `status-badge status-${data.status}`;
        badge.textContent = data.status;
        console.log('[DASHBOARD UPDATE] Updated status badge to:', data.status);
      }
    }

    // Update progress (4th column)
    const progressCell = row.cells[3];
    console.log('[DASHBOARD UPDATE] Progress cell exists:', !!progressCell);
    console.log('[DASHBOARD UPDATE] Current status:', data.status);
    console.log('[DASHBOARD UPDATE] Progress value:', data.progress);
    
    if (progressCell) {
      if (data.status === 'processing' || data.status === 'pending') {
        // Ensure progress is a valid number
        const progressValue = Math.min(Math.max(parseInt(data.progress) || 0, 0), 100);
        
        const progressFill = progressCell.querySelector('.progress-fill');
        const progressText = progressCell.querySelector('.progress-text');
        
        console.log('[DASHBOARD UPDATE] Progress fill element:', !!progressFill);
        console.log('[DASHBOARD UPDATE] Progress text element:', !!progressText);
        console.log('[DASHBOARD UPDATE] Progress value sanitized:', progressValue);
        
        if (progressFill) {
          const newWidth = `${progressValue}%`;
          progressFill.style.width = newWidth;
          console.log('[DASHBOARD UPDATE] Set progress bar width to:', newWidth);
        }
        if (progressText) {
          const newText = `${progressValue}%`;
          progressText.textContent = newText;
          console.log('[DASHBOARD UPDATE] Set progress text to:', newText);
        }
      } else if (data.status === 'completed') {
        progressCell.innerHTML = '<span style="color: var(--success); font-weight: 600;">‚úì 100%</span>';
        console.log('[DASHBOARD UPDATE] Set completed status');
      } else if (data.status === 'failed') {
        progressCell.innerHTML = '<span style="color: var(--danger);">‚úó Failed</span>';
        console.log('[DASHBOARD UPDATE] Set failed status');
      } else if (data.status === 'awaiting_feedback') {
        progressCell.innerHTML = '<span style="color: var(--accent); font-weight: 600;">‚è∏ Awaiting Review</span>';
        console.log('[DASHBOARD UPDATE] Set awaiting feedback status');
      }
    }

    // Update actions (6th column)
    const actionsCell = row.cells[5];
    if (actionsCell) {
      const companyName = row.cells[0].textContent;
      const jobTitle = row.cells[1].textContent;
      
      if (data.status === 'completed') {
        actionsCell.style.position = 'relative';
        actionsCell.innerHTML = `
          <button class="kebab-menu-btn" onclick="toggleKebabMenu(event, '${requestId}')">‚ãÆ</button>
          <div class="kebab-dropdown" id="kebab-${requestId}">
            <button class="primary" onclick="viewResumeContent('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span>View Resume</span>
            </button>
            <button class="secondary" onclick="viewJobDescription('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span>View Job Description</span>
            </button>
            <button class="success" onclick="downloadResumeDocx('${requestId}', '${companyName}', '${jobTitle}'); closeKebabMenu('${requestId}')">
              <span>Download Resume</span>
            </button>
            <button class="danger" onclick="if(confirm('Delete this resume?')) { deleteResume('${requestId}'); closeKebabMenu('${requestId}'); }">
              <span>Delete</span>
            </button>
          </div>
        `;
      } else if (data.status === 'awaiting_feedback') {
        actionsCell.innerHTML = `
          <button onclick="resumeKeywordReview('${requestId}', '${companyName}')" 
                  style="padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);"
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                  onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.2)'">
            Review Keywords
          </button>
        `;
      } else if (data.status === 'failed') {
        actionsCell.innerHTML = `
          <div style="color: var(--danger); font-size: 0.85em; padding: 6px; background: #fed7d7; border-radius: 4px;" title="${data.error_message || 'Generation failed'}">
            Error
          </div>
        `;
      }
    }
  }

  // Load Job History
  async function loadDashboardHistory() {
    try {
      // Build query params with filters and pagination
      const params = new URLSearchParams();
      params.append('limit', dashboardPageSize);
      params.append('offset', (currentPage - 1) * dashboardPageSize);
      
      const companyFilter = document.getElementById('filterCompany')?.value || '';
      const jobTitleFilter = document.getElementById('filterJobTitle')?.value || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const dateFilter = document.getElementById('filterDate')?.value || '';
      
      if (companyFilter) params.append('company', companyFilter);
      if (jobTitleFilter) params.append('job_title', jobTitleFilter);
      if (statusFilter) params.append('status', statusFilter);
      if (dateFilter) params.append('date_range', dateFilter);
      
      // Add timestamp to prevent caching
      params.append('_t', Date.now());
      
      const data = await dashApiCall(`/api/user/jobs?${params.toString()}`);
      
      console.log('[DASHBOARD] Loaded jobs for user:', dashboardCredentials?.username, 'Count:', data.count, 'Jobs:', data.jobs);
      
      // Store total count for pagination
      totalJobs = data.count;
      const tbody = document.getElementById('resumeHistoryBody');
      const resultCount = document.getElementById('resultCount');

      // Update result count display
      const isFiltered = companyFilter || jobTitleFilter || statusFilter || dateFilter;
      if (isFiltered) {
        resultCount.textContent = `Found ${data.count} resume${data.count !== 1 ? 's' : ''} matching your search`;
      } else {
        resultCount.textContent = data.count > 0 ? `Total: ${data.count} resume${data.count !== 1 ? 's' : ''}` : '';
      }

      if (data.count === 0) {
        const noResultsMsg = isFiltered 
          ? '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">No resumes match your search</p><p style="margin: 8px 0 0 0;">Try different search terms or clear filters</p></td></tr>'
          : '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">No resumes yet</p><p style="margin: 8px 0 0 0;">Start creating your first resume!</p></td></tr>';
        tbody.innerHTML = noResultsMsg;
        return;
      }

      tbody.innerHTML = data.jobs.map(job => {
        const applicationStatus = job.application_status || 'resume_generated';
        const jobLinkHtml = job.job_link ? `<a href="${job.job_link}" target="_blank" title="View Job Posting" style="color: var(--accent); text-decoration: none;">Link</a>` : '';
        
        // Determine status display: show resume generation status or application status
        let statusHtml = '';
        if (job.status === 'processing' || job.status === 'pending') {
          statusHtml = `<span class="status-badge status-${job.status}" style="font-size: 0.85em; padding: 4px 12px; border-radius: 12px; display: inline-block;">${job.status}</span>`;
        } else if (job.status === 'awaiting_feedback') {
          statusHtml = `<span class="status-badge status-awaiting_feedback" style="font-size: 0.85em; padding: 4px 12px; border-radius: 12px; display: inline-block;">Awaiting Review</span>`;
        } else if (job.status === 'failed') {
          statusHtml = `<span class="status-badge status-failed" style="font-size: 0.85em; padding: 4px 12px; border-radius: 12px; display: inline-block;">‚ùå Failed</span>`;
        } else if (job.status === 'completed') {
          // Show application status dropdown for completed resumes
          statusHtml = `<select class="application-status-dropdown" data-job-id="${job.job_id}" onchange="updateApplicationStatus(${job.job_id}, this.value)" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--background); color: var(--text-primary); font-size: 0.85em; cursor: pointer;">
              <option value="resume_generated" ${applicationStatus === 'resume_generated' ? 'selected' : ''}>Resume Generated</option>
              <option value="applied" ${applicationStatus === 'applied' ? 'selected' : ''}>‚úÖ Applied</option>
              <option value="screening" ${applicationStatus === 'screening' ? 'selected' : ''}>Screening</option>
              <option value="interview" ${applicationStatus === 'interview' ? 'selected' : ''}>Interview</option>
              <option value="offer" ${applicationStatus === 'offer' ? 'selected' : ''}>Offer</option>
              <option value="rejected" ${applicationStatus === 'rejected' ? 'selected' : ''}>‚ùå Rejected</option>
            </select>`;
        }
        
        return `
        <tr data-request-id="${job.request_id}" data-job-id="${job.job_id}" style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseenter="this.style.background='var(--card)'" onmouseleave="this.style.background=''">
          <td style="padding: 12px 16px; color: var(--text-primary); font-weight: 500;">
            ${job.company_name} ${jobLinkHtml}
          </td>
          <td style="padding: 12px 16px; color: var(--text-primary);">${job.job_title}</td>
          <td style="padding: 12px 16px;">
            ${statusHtml}
          </td>
          <td style="padding: 12px 16px; font-size: 0.85em; color: var(--text-secondary); white-space: nowrap;">
            ${job.application_date ? formatLocalDateTime(job.application_date) : (job.last_status_update ? formatLocalDateTime(job.last_status_update) : formatLocalDateTime(job.created_at))}
          </td>
          <td style="padding: 12px 16px; text-align: right; position: relative;">
            ${job.status === 'completed' ? `
              <button class="kebab-menu-btn" onclick="toggleKebabMenu(event, '${job.request_id}')">‚ãÆ</button>
              <div class="kebab-dropdown" id="kebab-${job.request_id}">
                <button class="primary" onclick="viewResumeContent('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span>View Resume</span>
                </button>
                <button class="secondary" onclick="viewJobDescription('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span>View Job Description</span>
                </button>
                <button class="secondary" onclick="generateCoverLetterFromJob('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span>Cover Letter</span>
                </button>
                <button class="secondary" onclick="copyJobDescription('${job.request_id}'); closeKebabMenu('${job.request_id}')">
                  <span>Copy JD</span>
                </button>
                <button class="success" onclick="downloadResumeDocx('${job.request_id}', '${job.company_name}', '${job.job_title}'); closeKebabMenu('${job.request_id}')">
                  <span>Download Resume</span>
                </button>
                <button class="danger" onclick="customConfirm(&quot;Delete this resume?&quot;, &quot;Confirm Delete&quot;).then(confirmed => { if(confirmed) { deleteResume(&quot;${job.request_id}&quot;); closeKebabMenu(&quot;${job.request_id}&quot;); } })">
                  <span>Delete</span>
                </button>
              </div>
            ` : job.status === 'processing' || job.status === 'pending' ? `
              <button class="sub-btn" style="padding: 6px 12px; font-size: 0.9em; margin-right: 4px;" onclick="checkDashboardStatus('${job.request_id}')">
                Refresh
              </button>
              <button class="danger-btn" style="padding: 6px 12px; font-size: 0.9em; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="customConfirm(&quot;Cancel this job?&quot;, &quot;Confirm Cancel&quot;).then(confirmed => { if(confirmed) deleteResume(&quot;${job.request_id}&quot;); })">
                Cancel
              </button>
            ` : job.status === 'awaiting_feedback' ? `
              <button onclick="resumeKeywordReview('${job.request_id}', '${job.company_name}')" 
                      style="padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2); margin-right: 4px;"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                      onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.2)'">
                Review Keywords
              </button>
              <button class="danger-btn" style="padding: 6px 12px; font-size: 0.9em; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="customConfirm(&quot;Cancel this job?&quot;, &quot;Confirm Cancel&quot;).then(confirmed => { if(confirmed) deleteResume(&quot;${job.request_id}&quot;); })">
                Cancel
              </button>
            ` : `
              <button class="danger-btn" style="padding: 6px 12px; font-size: 0.9em; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="console.log('[DELETE BTN] Clicked for:', '${job.request_id}'); customConfirm(&quot;Delete this failed job?&quot;, &quot;Confirm Delete&quot;).then(confirmed => { console.log('[DELETE BTN] Confirmed:', confirmed); if(confirmed) deleteResume(&quot;${job.request_id}&quot;); })">
                Delete
              </button>
            `}
          </td>
        </tr>
        `;
      }).join('');

      // Render mobile cards for responsive view
      renderMobileResumeCards(data.jobs);

      // Start polling for active jobs
      data.jobs.forEach(job => {
        if (job.status === 'processing' || job.status === 'pending') {
          startDashboardPolling(job.request_id);
        }
      });

      // Render pagination controls
      renderPagination();

    } catch (error) {
      console.error('Failed to load history:', error);
    }
  }

  // Render mobile-friendly cards for dashboard
  function renderMobileResumeCards(jobs) {
    const container = document.getElementById('mobileResumeCards');
    if (!container) return;
    
    if (!jobs || jobs.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
          <p style="font-size: 1.1em; margin: 0;">No resumes yet</p>
          <p style="margin: 8px 0 0 0; font-size: 14px;">Start creating your first resume!</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = jobs.map(job => {
      const applicationStatus = job.application_status || 'resume_generated';
      
      // Status badge HTML
      let statusHtml = '';
      if (job.status === 'processing' || job.status === 'pending') {
        statusHtml = `<span class="status-badge status-${job.status}">${job.status}</span>`;
      } else if (job.status === 'awaiting_feedback') {
        statusHtml = `<span class="status-badge status-awaiting_feedback">Review</span>`;
      } else if (job.status === 'failed') {
        statusHtml = `<span class="status-badge status-failed">‚ùå Failed</span>`;
      } else if (job.status === 'completed') {
        const statusLabels = {
          'resume_generated': 'Generated',
          'applied': '‚úÖ Applied',
          'screening': 'Screening',
          'interview': 'Interview',
          'offer': 'Offer',
          'rejected': '‚ùå Rejected'
        };
        statusHtml = `<span class="status-badge status-completed">${statusLabels[applicationStatus] || 'Generated'}</span>`;
      }
      
      // Date formatting
      const dateStr = job.application_date || job.last_status_update || job.created_at;
      const formattedDate = dateStr ? formatLocalDateTime(dateStr) : '';
      
      // Action buttons based on status
      let actionsHtml = '';
      if (job.status === 'completed') {
        actionsHtml = `
          <button class="primary-btn" onclick="viewResumeContent('${job.request_id}', '${job.company_name}', '${job.job_title}')">View</button>
          <button class="secondary-btn" onclick="generateCoverLetterFromJob('${job.request_id}', '${job.company_name}', '${job.job_title}')">Cover Letter</button>
          <button class="secondary-btn" onclick="downloadResumeDocx('${job.request_id}', '${job.company_name}', '${job.job_title}')">Download</button>
        `;
      } else if (job.status === 'processing' || job.status === 'pending') {
        actionsHtml = `
          <button class="secondary-btn" onclick="checkDashboardStatus('${job.request_id}')">Refresh</button>
          <button class="danger-btn" style="background: var(--danger); color: white; border: none;" onclick="customConfirm('Cancel this job?', 'Confirm Cancel').then(confirmed => { if(confirmed) deleteResume('${job.request_id}'); })">Cancel</button>
        `;
      } else if (job.status === 'awaiting_feedback') {
        actionsHtml = `
          <button class="primary-btn" onclick="resumeKeywordReview('${job.request_id}', '${job.company_name}')">Review</button>
          <button class="danger-btn" style="background: var(--danger); color: white; border: none;" onclick="customConfirm('Cancel?', 'Confirm').then(confirmed => { if(confirmed) deleteResume('${job.request_id}'); })">Cancel</button>
        `;
      } else {
        actionsHtml = `
          <button class="danger-btn" style="background: var(--danger); color: white; border: none; width: 100%;" onclick="customConfirm('Delete?', 'Confirm').then(confirmed => { if(confirmed) deleteResume('${job.request_id}'); })">Delete</button>
        `;
      }
      
      return `
        <div class="mobile-resume-card" data-request-id="${job.request_id}" data-job-id="${job.job_id}">
          <div class="mobile-card-header">
            <div>
              <div class="mobile-card-company">${job.company_name}${job.job_link ? ` <a href="${job.job_link}" target="_blank" style="color: var(--accent);">Link</a>` : ''}</div>
              <div class="mobile-card-jobtitle">${job.job_title}</div>
            </div>
            <div class="mobile-card-status">
              ${statusHtml}
            </div>
          </div>
          <div class="mobile-card-meta">
            <span>${formattedDate}</span>
          </div>
          <div class="mobile-card-actions">
            ${actionsHtml}
          </div>
        </div>
      `;
    }).join('');
  }

  // Download Resume as DOCX (on-the-fly generation)
  // Store download context for view modal
  let pendingViewModalDownload = null;

  async function downloadResumeDocx(requestId, companyName, jobTitle) {
    // Store context and show format selection modal
    pendingViewModalDownload = { requestId, companyName, jobTitle };
    document.getElementById('formatModal').style.display = 'flex';
  }

  // Update confirmFormatDownload to handle both dashboard and view modal downloads
  async function confirmFormatDownload() {
    const format = document.querySelector('input[name="downloadFormat"]:checked').value;
    
    // Check if download is from view modal
    if (pendingViewModalDownload) {
      try {
        const { requestId, companyName, jobTitle } = pendingViewModalDownload;
        
        const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}/download?format=${format}`, {
          headers: {
            'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
          }
        });

        if (!response.ok) {
          throw new Error('Failed to generate resume');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const firstName = dashboardCredentials.firstName || '';
        const filePrefix = firstName ? `${firstName}_` : '';
        a.download = `${filePrefix}${companyName}_${jobTitle}.docx`.replace(/[^a-z0-9_\-\.]/gi, '_');
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showDashMessage(`Resume downloaded in ${format} format!`, 'success');
        closeFormatModal();
        pendingViewModalDownload = null;
      } catch (error) {
        console.error('Download failed:', error);
        showDashMessage('Failed to download resume', 'error');
        closeFormatModal();
      }
      return;
    }
    
    // Otherwise, handle dashboard download
    if (!pendingDownloadRequestId) {
      showDashMessage('No resume selected for download', 'error');
      return;
    }

    const url = `${API_BASE_URL}/api/jobs/${pendingDownloadRequestId}/download?format=${format}`;
    
    if (dashboardCredentials) {
      fetch(url, {
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      })
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const firstName = dashboardCredentials.firstName || '';
        const filePrefix = firstName ? `${firstName}_` : '';
        a.download = `${filePrefix}resume_${pendingDownloadRequestId}.docx`;
        a.click();
        window.URL.revokeObjectURL(url);
        showDashMessage(`Resume downloaded in ${format} format!`, 'success');
        closeFormatModal();
      })
      .catch(error => {
        showDashMessage('Download failed: ' + error.message, 'error');
        closeFormatModal();
      });
    }
  }

  function closeFormatModal() {
    document.getElementById('formatModal').style.display = 'none';
    pendingDownloadRequestId = null;
    pendingViewModalDownload = null;
  }

  // Profile Modal Functions
  function openProfileModal() {
    const modal = document.getElementById('profileModal');
    
    // Load current user data
    document.getElementById('profileFirstName').value = dashboardCredentials.firstName || '';
    document.getElementById('profileLastName').value = dashboardCredentials.lastName || '';
    document.getElementById('profileEmail').value = dashboardCredentials.username || '';
    
    modal.style.display = 'flex';
  }

  function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
    document.getElementById('profileMessage').style.display = 'none';
  }

  function showProfileMessage(message, type) {
    const messageDiv = document.getElementById('profileMessage');
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    messageDiv.style.background = type === 'success' ? 'var(--success-bg, #d1fae5)' : 'var(--error-bg, #fee2e2)';
    messageDiv.style.color = type === 'success' ? 'var(--success-text, #065f46)' : 'var(--error-text, #991b1b)';
    messageDiv.style.border = type === 'success' ? '1px solid var(--success-border, #6ee7b7)' : '1px solid var(--error-border, #fca5a5)';
  }

  async function saveProfile() {
    const firstName = document.getElementById('profileFirstName').value.trim();
    const lastName = document.getElementById('profileLastName').value.trim();

    if (!firstName || !lastName) {
      showProfileMessage('Please fill in both first and last name', 'error');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/api/auth/update-profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        },
        body: JSON.stringify({ first_name: firstName, last_name: lastName })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to update profile');
      }

      // Update local credentials
      dashboardCredentials.firstName = firstName;
      dashboardCredentials.lastName = lastName;
      
      // Update display name
      updateHeaderUserDisplay();
      
      showProfileMessage('Profile updated successfully!', 'success');
      
      // Close modal after 1.5 seconds
      setTimeout(() => {
        closeProfileModal();
      }, 1500);
    } catch (error) {
      console.error('Profile update failed:', error);
      showProfileMessage(error.message, 'error');
    }
  }

  function updateHeaderUserDisplay() {
    const firstName = dashboardCredentials.firstName || '';
    const lastName = dashboardCredentials.lastName || '';
    const displayName = firstName && lastName ? `${firstName} ${lastName}` : dashboardCredentials.username;
    
    const mobileUserName = document.getElementById('mobileUserName');
    if (mobileUserName) {
      mobileUserName.textContent = displayName;
    }
  }

  // Download Job Description
  async function downloadJobDescription(requestId, companyName, jobTitle) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}/download-jd`, {
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      });

      if (!response.ok) {
        throw new Error('Failed to download job description');
      }

      // Download the file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${companyName}_${jobTitle}_JD.txt`.replace(/[^a-z0-9_\-\.]/gi, '_');
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showDashMessage('Job description downloaded successfully!', 'success');
    } catch (error) {
      console.error('JD download failed:', error);
      showDashMessage('Failed to download job description', 'error');
    }
  }

  // Delete Resume
  async function deleteResume(requestId) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/jobs/${requestId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`)
        }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to delete resume');
      }

      // Remove from processing banner if it exists
      if (typeof activeRequests !== 'undefined') {
        const request = activeRequests.get(requestId);
        if (request) {
          request.element.style.opacity = '0';
          setTimeout(() => {
            request.element.remove();
            activeRequests.delete(requestId);
            if (typeof updateBannerCount === 'function') {
              updateBannerCount();
            }
          }, 300);
        }
      }

      // Stop polling if active
      if (dashboardPollIntervals[requestId]) {
        clearInterval(dashboardPollIntervals[requestId]);
        delete dashboardPollIntervals[requestId];
      }

      // Remove the row from the table
      const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
      if (row) {
        row.remove();
      }

      // Reload dashboard stats and history
      loadDashboardStats();
      loadDashboardHistory();
      
      showDashMessage('Resume deleted successfully!', 'success');
    } catch (error) {
      console.error('Delete failed:', error);
      showDashMessage(error.message || 'Failed to delete resume', 'error');
    }
  }

  // Check Status
  async function checkDashboardStatus(requestId) {
    console.log('Checking status for:', requestId);
    try {
      const status = await dashApiCall(`/api/jobs/${requestId}/status`);
      console.log('Status received:', status);
      updateDashboardJobCard(requestId, status);
      showDashMessage(`Progress: ${status.progress}%`, 'success');
    } catch (error) {
      console.error('Status check failed:', error);
      showDashMessage(error.message, 'error');
    }
  }

  // View Resume JSON
  async function viewDashboardResume(requestId) {
    try {
      const data = await dashApiCall(`/api/jobs/${requestId}/result`);
      const json = JSON.stringify(data.final_resume, null, 2);
      
      const newWindow = window.open('', '_blank');
      newWindow.document.write(`
        <html>
        <head><title>Resume JSON - ${data.company_name}</title></head>
        <body style="font-family: monospace; padding: 20px; background: #1a202c; color: #e2e8f0;">
          <h2 style="color: #90cdf4;">${data.company_name} - ${data.job_title}</h2>
          <pre style="background: #2d3748; padding: 20px; border-radius: 8px; overflow: auto;">${json}</pre>
        </body>
        </html>
      `);
    } catch (error) {
      showDashMessage(error.message, 'error');
    }
  }

  // Download Resume - Show format selection modal
  let pendingDownloadRequestId = null;

  function downloadDashboardResume(requestId) {
    pendingDownloadRequestId = requestId;
    document.getElementById('formatModal').style.display = 'flex';
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    Object.values(dashboardPollIntervals).forEach(clearInterval);
  });

  /* ---------- MAIN AUTH FUNCTIONALITY ---------- */
  
  // Switch Main Auth Forms
  function switchMainAuthTab(tab) {
    const loginForm = document.getElementById('mainLoginForm');
    const registerForm = document.getElementById('mainRegisterForm');
    const resetForm = document.getElementById('mainResetForm');

    // Hide all forms
    loginForm.classList.remove('active');
    registerForm.classList.remove('active');
    resetForm.classList.remove('active');

    // Show selected form
    if (tab === 'login') {
      loginForm.classList.add('active');
    } else if (tab === 'register') {
      registerForm.classList.add('active');
    } else if (tab === 'reset') {
      resetForm.classList.add('active');
    }
  }

  // Show Main Auth Message
  function showMainAuthMessage(message, type = 'info') {
    const msgBox = document.getElementById('mainAuthMessage');
    msgBox.style.display = 'block';
    msgBox.style.background = type === 'error' ? '#fed7d7' : type === 'success' ? '#c6f6d5' : '#bee3f8';
    msgBox.style.color = type === 'error' ? '#742a2a' : type === 'success' ? '#22543d' : '#2c5282';
    msgBox.style.border = `1px solid ${type === 'error' ? '#fc8181' : type === 'success' ? '#9ae6b4' : '#90cdf4'}`;
    msgBox.textContent = message;
    setTimeout(() => msgBox.style.display = 'none', 5000);
  }

  // Validate Password Strength (Real-time feedback)
  function validatePasswordStrength() {
    const password = document.getElementById('mainRegisterPassword').value;
    const strengthDiv = document.getElementById('passwordStrength');
    
    if (!password) {
      strengthDiv.innerHTML = '';
      return;
    }

    const checks = {
      length: password.length >= 8,
      upper: /[A-Z]/.test(password),
      lower: /[a-z]/.test(password),
      digit: /\d/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };

    const checkMark = '‚úì';
    const crossMark = '‚úó';
    
    const strengthHTML = `
      <div style="line-height: 1.6;">
        <span style="color: ${checks.length ? '#10b981' : '#ef4444'};">${checks.length ? checkMark : crossMark} 8+ characters</span><br>
        <span style="color: ${checks.upper ? '#10b981' : '#ef4444'};">${checks.upper ? checkMark : crossMark} Uppercase (A-Z)</span>
        <span style="color: ${checks.lower ? '#10b981' : '#ef4444'}; margin-left: 10px;">${checks.lower ? checkMark : crossMark} Lowercase (a-z)</span><br>
        <span style="color: ${checks.digit ? '#10b981' : '#ef4444'};">${checks.digit ? checkMark : crossMark} Number (0-9)</span>
        <span style="color: ${checks.special ? '#10b981' : '#ef4444'}; margin-left: 10px;">${checks.special ? checkMark : crossMark} Special (!@#$)</span>
      </div>
    `;
    
    strengthDiv.innerHTML = strengthHTML;
  }

  // Handle Main Register
  async function handleMainRegister() {
    const firstName = document.getElementById('mainRegisterFirstName').value.trim();
    const lastName = document.getElementById('mainRegisterLastName').value.trim();
    const username = document.getElementById('mainRegisterUsername').value.trim().toLowerCase();
    const password = document.getElementById('mainRegisterPassword').value;
    const confirm = document.getElementById('mainRegisterPasswordConfirm').value;

    if (!firstName || !lastName || !username || !password) {
      showMainAuthMessage('Please fill in all fields', 'error');
      return;
    }

    // Validate email format
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailRegex.test(username)) {
      showMainAuthMessage('Please enter a valid email address', 'error');
      return;
    }

    if (password !== confirm) {
      showMainAuthMessage('Passwords do not match!', 'error');
      return;
    }

    if (password.length < 8) {
      showMainAuthMessage('Password must be at least 8 characters', 'error');
      return;
    }

    // Validate password complexity
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasDigit = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

    if (!hasUpper) {
      showMainAuthMessage('Password must contain at least one uppercase letter (A-Z)', 'error');
      return;
    }
    if (!hasLower) {
      showMainAuthMessage('Password must contain at least one lowercase letter (a-z)', 'error');
      return;
    }
    if (!hasDigit) {
      showMainAuthMessage('Password must contain at least one number (0-9)', 'error');
      return;
    }
    if (!hasSpecial) {
      showMainAuthMessage('Password must contain at least one special character (!@#$%^&*)', 'error');
      return;
    }

    try {
      await dashApiCall('/api/auth/register', {
        method: 'POST',
        body: JSON.stringify({ user_id: username, password, first_name: firstName, last_name: lastName })
      });

      showMainAuthMessage('Account created! Please login.', 'success');
      switchMainAuthTab('login');
      document.getElementById('mainLoginUsername').value = username;
    } catch (error) {
      showMainAuthMessage(error.message, 'error');
    }
  }

  // Handle Password Reset
  async function handlePasswordReset() {
    const username = document.getElementById('mainResetUsername').value.trim().toLowerCase();
    const newPassword = document.getElementById('mainResetNewPassword').value;
    const confirmPassword = document.getElementById('mainResetConfirmPassword').value;

    if (!username || !newPassword || !confirmPassword) {
      showMainAuthMessage('Please fill in all fields', 'error');
      return;
    }

    // Allow both email and legacy username formats for reset (backward compatibility)

    if (newPassword.length < 8) {
      showMainAuthMessage('Password must be at least 8 characters', 'error');
      return;
    }

    if (newPassword !== confirmPassword) {
      showMainAuthMessage('Passwords do not match', 'error');
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, new_password: newPassword })
      });

      const result = await response.json();

      if (response.ok) {
        showMainAuthMessage('Password reset successful! Please sign in.', 'success');
        // Clear form
        document.getElementById('mainResetUsername').value = '';
        document.getElementById('mainResetNewPassword').value = '';
        document.getElementById('mainResetConfirmPassword').value = '';
        // Switch to login after 2 seconds
        setTimeout(() => switchMainAuthTab('login'), 2000);
      } else {
        showMainAuthMessage(result.detail || 'Password reset failed', 'error');
      }
    } catch (error) {
      console.error('Password reset error:', error);
      showMainAuthMessage('Password reset failed', 'error');
    }
  }

  // Handle Main Login
  async function handleMainLogin() {
    const username = document.getElementById('mainLoginUsername').value.trim().toLowerCase();
    const password = document.getElementById('mainLoginPassword').value;

    if (!username || !password) {
      showMainAuthMessage('Please enter email and password', 'error');
      return;
    }

    // Allow both email and legacy username formats for login (backward compatibility)
    // New registrations will enforce email format

    console.log('Attempting login for user:', username);
    dashboardCredentials = { username, password };
    
    // Store credentials globally for template load
    currentUsername = username;
    currentPassword = password;

    try {
      const result = await dashApiCall('/api/auth/login', { method: 'POST' });
      console.log('Login successful:', result);
      
      // Store user profile data
      dashboardCredentials.firstName = result.first_name || '';
      dashboardCredentials.lastName = result.last_name || '';
      dashboardCredentials.token = result.token || '';
      
      // Clear any previous user's data
      const dashboardHistory = document.getElementById('dashboardHistory');
      if (dashboardHistory) {
        dashboardHistory.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading...</p>';
      }
      
      // Clear resume history table
      const resumeHistoryBody = document.getElementById('resumeHistoryBody');
      if (resumeHistoryBody) {
        resumeHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">Loading...</p></td></tr>';
      }
      
      // Reset pagination
      currentPage = 1;
      totalJobs = 0;
      
      const jobSearchResults = document.getElementById('jobSearchResults');
      if (jobSearchResults) {
        jobSearchResults.innerHTML = '';
      }
      
      // Hide auth screen, show main app
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Show buttons in header
      document.getElementById('headerLogoutBtn').style.display = 'block';
      document.getElementById('headerProfileBtn').style.display = 'block';
      
      // Update mobile user info display
      updateHeaderUserDisplay();
      
      // Show header and footer
      document.getElementById('mainHeader').style.display = 'flex';
      document.getElementById('mainFooter').style.display = 'block';
      
      // Initialize mobile user info
      updateMobileUserInfo();
      
      // Load stats (for dashboard tab)
      loadDashboardStats();
      loadDashboardHistory();
      
      // Auto-load saved resume template
      await loadResumeTemplate();
      
      // Initialize tutorial system after login
      initTutorial();
      
    } catch (error) {
      console.error('Login failed:', error);
      dashboardCredentials = null;
      currentUsername = null;
      currentPassword = null;
      showMainAuthMessage(error.message || 'Login failed', 'error');
    }
  }

  // Toggle header menu dropdown
  function toggleHeaderMenu() {
    const menu = document.getElementById('headerDropdownMenu');
    if (menu.style.display === 'none' || menu.style.display === '') {
      menu.style.display = 'block';
      // Update mobile user info on open
      updateMobileUserInfo();
    } else {
      menu.style.display = 'none';
    }
  }
  
  // Update mobile user info
  function updateMobileUserInfo() {
    const isMobile = window.innerWidth <= 768;
    const mobileUserInfo = document.getElementById('mobileUserInfo');
    const mobileUserName = document.getElementById('mobileUserName');
    const headerUserInfo = document.getElementById('headerUserInfo');
    const mobileResumeActions = document.getElementById('mobileResumeActions');
    
    if (isMobile && mobileUserInfo && mobileUserName) {
      // Update mobile menu with user name
      updateHeaderUserDisplay();
      mobileUserInfo.style.display = 'block';
      
      // Show resume actions only on View Resume tab
      if (mobileResumeActions) {
        const resumeContainer = document.getElementById('resumeFormContainer');
        if (resumeContainer && resumeContainer.classList.contains('active')) {
          mobileResumeActions.style.display = 'block';
        } else {
          mobileResumeActions.style.display = 'none';
        }
      }
    } else {
      if (mobileUserInfo) mobileUserInfo.style.display = 'none';
      if (mobileResumeActions) mobileResumeActions.style.display = 'none';
    }
  }
  
  // Update on resize
  window.addEventListener('resize', updateMobileUserInfo);

  // Close header menu when clicking outside
  document.addEventListener('click', function(event) {
    const menu = document.getElementById('headerDropdownMenu');
    const menuBtn = document.getElementById('menuToggleBtn');
    
    if (menu && menuBtn && !menuBtn.contains(event.target) && !menu.contains(event.target)) {
      menu.style.display = 'none';
    }
  });

  // Handle Main Logout
  function handleMainLogout() {
    try {
      console.log('[LOGOUT] Starting logout process...');
      
      // Close the dropdown menu first
      const menu = document.getElementById('headerDropdownMenu');
      if (menu) menu.style.display = 'none';
      
      if (formHasChanges) {
        showNotification('‚ö†Ô∏è You have unsaved changes. Please save before logging out.', 'warning', 4000);
        return;
      }
      
      dashboardCredentials = null;
      currentUsername = null;
      currentPassword = null;
      
      // Clear session storage (email history)
      sessionStorage.removeItem('emailHistory');
    
    // Clear dashboard data
    const dashboardHistory = document.getElementById('dashboardHistory');
    if (dashboardHistory) {
      dashboardHistory.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No resumes generated yet</p>';
    }
    
    // Clear resume history table
    const resumeHistoryBody = document.getElementById('resumeHistoryBody');
    if (resumeHistoryBody) {
      resumeHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 1.2em; margin: 0;">No resumes yet</p><p style="margin: 8px 0 0 0;">Start creating your first resume!</p></td></tr>';
    }
    
    // Clear result count
    const resultCount = document.getElementById('resultCount');
    if (resultCount) {
      resultCount.textContent = '';
    }
    
    const jobSearchResults = document.getElementById('jobSearchResults');
    if (jobSearchResults) {
      jobSearchResults.innerHTML = '';
    }
    
    // Clear stats
    const statsElements = ['statTotalResumes', 'statActiveJobs', 'statThisWeek', 'statLastLogin'];
    statsElements.forEach(id => {
      const elem = document.getElementById(id);
      if (elem) elem.textContent = '0';
    });
    
    // Clear job search fields (with null checks)
    const jobSearchTitle = document.getElementById('jobSearchTitle');
    const jobSearchLocation = document.getElementById('jobSearchLocation');
    if (jobSearchTitle) jobSearchTitle.value = '';
    if (jobSearchLocation) jobSearchLocation.value = '';
    
    // Clear dashboard filters
    const filterCompany = document.getElementById('filterCompany');
    const filterJobTitle = document.getElementById('filterJobTitle');
    const filterStatus = document.getElementById('filterStatus');
    if (filterCompany) filterCompany.value = '';
    if (filterJobTitle) filterJobTitle.value = '';
    if (filterStatus) filterStatus.value = '';
    
    // Reset pagination variables
    currentPage = 1;
    totalJobs = 0;
    
    // Clear pagination container
    const paginationContainer = document.getElementById('paginationContainer');
    if (paginationContainer) {
      paginationContainer.innerHTML = '';
    }
    
    // Show auth screen, hide main app
    document.getElementById('authScreen').style.display = 'grid';
    document.getElementById('mainApp').style.display = 'none';
    
    // Hide buttons in header
    document.getElementById('headerLogoutBtn').style.display = 'none';
    document.getElementById('headerProfileBtn').style.display = 'none';
    
    // Hide header and footer
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainFooter').style.display = 'none';
    
    // Clear forms
    document.getElementById('mainLoginUsername').value = '';
    document.getElementById('mainLoginPassword').value = '';
    document.getElementById('mainRegisterUsername').value = '';
    document.getElementById('mainRegisterPassword').value = '';
    document.getElementById('mainRegisterPasswordConfirm').value = '';
    
    // Clear poll intervals
    Object.values(dashboardPollIntervals).forEach(clearInterval);
    dashboardPollIntervals = {};
    
    // Switch back to login tab
    switchMainAuthTab('login');
    
    console.log('[LOGOUT] Logout completed successfully');
    showNotification('‚úÖ Logged out successfully', 'success', 2000);
    
    } catch (error) {
      console.error('[LOGOUT] Error during logout:', error);
      // Force logout anyway
      document.getElementById('authScreen').style.display = 'grid';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'none';
      document.getElementById('mainFooter').style.display = 'none';
    }
  }

  // On page load, check if user is already logged in (from sessionStorage)
  window.addEventListener('DOMContentLoaded', () => {
    // Auth screen is shown by default (no auto-login)
    
    // Clear email history if not logged in (on page load/refresh)
    if (!dashboardCredentials) {
      sessionStorage.removeItem('emailHistory');
    }
  });

  // ===== EMAIL WRITER FUNCTIONALITY =====
  
  let currentEmailInputs = null;
  
  // Show custom email mode (default)
  function showCustomEmailMode() {
    const formHTML = `
      <div class="email-form-card">
        <h3>Describe the email you need</h3>
        <p class="help-text">
          Examples: "Email to my manager about taking time off for interview", 
          "Message to alumni requesting coffee chat", "Follow-up after networking event"
        </p>
        
        <textarea id="customEmailRequest" class="email-input" 
                  placeholder="What email do you need? Be specific about your situation..." 
                  rows="4" 
                  required></textarea>
        
        <textarea id="additionalContext" class="email-input"
                  placeholder="Additional context (optional): names, dates, specific details..." 
                  rows="3"></textarea>
        
        <div class="email-form-row">
          <div class="email-form-group">
            <label>Tone</label>
            <select id="emailTone">
              <option value="professional">Professional</option>
              <option value="enthusiastic">Enthusiastic</option>
              <option value="formal">Formal</option>
              <option value="conversational">Conversational</option>
              <option value="friendly">Friendly</option>
              <option value="assertive">Assertive</option>
            </select>
          </div>
          
          <div class="email-form-group">
            <label>Length</label>
            <select id="emailLength">
              <option value="short">Short (0-100 words)</option>
              <option value="medium" selected>Medium (100-150 words)</option>
              <option value="long">Long (150-250 words)</option>
            </select>
          </div>
        </div>
        
        <label class="email-checkbox-wrapper">
          <input type="checkbox" id="includeResume"> 
          <span>Include my resume context (if relevant)</span>
        </label>
        
        <button onclick="generateEmail('custom')" class="email-generate-btn">
          Generate Email
        </button>
      </div>
    `;
    
    document.getElementById('emailInputArea').innerHTML = formHTML;
    // Reset template selector
    document.getElementById('emailTemplateSelector').value = '';
  }
  
  // Handle template change
  function handleEmailTemplateChange(templateType) {
    if (!templateType) return;
    renderTemplateForm(templateType);
  }
  
  // Render template-specific form
  function renderTemplateForm(type) {
    let formHTML = '';
    
    if (type === 'cover_letter') {
      formHTML = `
        <div class="email-form-card">
          <h3>Cover Letter Generator</h3>
          <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">Create a personalized cover letter tailored to the job description</p>
          <input type="text" id="emailCompany" class="email-input" placeholder="Company Name *" required>
          <input type="text" id="emailJobTitle" class="email-input" placeholder="Job Title *" required>
          <textarea id="emailJD" class="email-input" placeholder="Paste Job Description *" rows="10" required></textarea>
          
          <div class="email-form-row">
            <div class="email-form-group">
              <label>Tone</label>
              <select id="emailTone">
                <option value="professional">Professional</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="formal">Formal</option>
                <option value="conversational">Conversational</option>
              </select>
            </div>
            <div class="email-form-group">
              <label>Length</label>
              <select id="emailLength">
                <option value="short">Short (~150 words)</option>
                <option value="medium" selected>Medium (~250 words)</option>
                <option value="long">Long (~350 words)</option>
              </select>
            </div>
          </div>
          
          <label class="email-checkbox-wrapper">
            <input type="checkbox" id="includeResume" checked> 
            <span>Use My Resume Data</span>
          </label>
          
          <button onclick="generateEmail('cover_letter')" class="email-generate-btn">
            Generate Cover Letter
          </button>
        </div>
      `;
    } else if (type === 'job_application') {
      formHTML = `
        <div class="email-form-card">
          <h3>Job Application Email</h3>
          <input type="text" id="emailCompany" class="email-input" placeholder="Company Name *" required>
          <input type="text" id="emailJobTitle" class="email-input" placeholder="Job Title *" required>
          <textarea id="emailJD" class="email-input" placeholder="Paste Job Description *" rows="8" required></textarea>
          
          <div class="email-form-row">
            <div class="email-form-group">
              <label>Tone</label>
              <select id="emailTone">
                <option value="professional">Professional</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="formal">Formal</option>
              </select>
            </div>
            <div class="email-form-group">
              <label>Length</label>
              <select id="emailLength">
                <option value="short">Short</option>
                <option value="medium" selected>Medium</option>
                <option value="long">Long</option>
              </select>
            </div>
          </div>
          
          <label class="email-checkbox-wrapper">
            <input type="checkbox" id="includeResume" checked> 
            <span>Include Resume Summary</span>
          </label>
          
          <button onclick="generateEmail('job_application')" class="email-generate-btn">
            Generate Application Email
          </button>
        </div>
      `;
    } else if (type === 'reply') {
      formHTML = `
        <div class="email-form-card">
          <h3>Reply to Recruiter</h3>
          <textarea id="recruiterEmail" class="email-input" placeholder="Paste Recruiter's Email *" rows="10" required></textarea>
          <textarea id="additionalContext" class="email-input" placeholder="Additional Context (optional)" rows="4"></textarea>
          
          <div class="email-form-row">
            <div class="email-form-group">
              <label>Tone</label>
              <select id="emailTone">
                <option value="professional">Professional</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="conversational">Conversational</option>
              </select>
            </div>
            <div class="email-form-group">
              <label>Length</label>
              <select id="emailLength">
                <option value="short" selected>Short</option>
                <option value="medium">Medium</option>
              </select>
            </div>
          </div>
          
          <button onclick="generateEmail('reply')" class="email-generate-btn">
                        Generate Reply
          </button>
        </div>
      `;
    } else {
      // Generic template for other types
      formHTML = `
        <div class="email-form-card">
          <h3>${getTemplateTitle(type)}</h3>
          <input type="text" id="emailCompany" class="email-input" placeholder="Company Name">
          <input type="text" id="emailJobTitle" class="email-input" placeholder="Job Title">
          <textarea id="additionalContext" class="email-input" placeholder="Additional Context" rows="6"></textarea>
          
          <div class="email-form-row">
            <div class="email-form-group">
              <label>Tone</label>
              <select id="emailTone">
                <option value="professional">Professional</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="formal">Formal</option>
                <option value="conversational">Conversational</option>
              </select>
            </div>
            <div class="email-form-group">
              <label>Length</label>
              <select id="emailLength">
                <option value="short">Short</option>
                <option value="medium" selected>Medium</option>
                <option value="long">Long</option>
              </select>
            </div>
          </div>
          
          <button onclick="generateEmail('${type}')" class="email-generate-btn">
            Generate Email
          </button>
        </div>
      `;
    }
    
    document.getElementById('emailInputArea').innerHTML = formHTML;
  }
  
  function getTemplateTitle(type) {
    const titles = {
      'cover_letter': 'Cover Letter',
      'followup': 'Follow-up Email',
      'thankyou': 'Thank You Email',
      'networking': 'Networking Email',
      'salary_negotiation': 'Salary Negotiation',
      'resignation': 'Resignation Email',
      'referral_request': 'Request Referral',
      'decline_offer': 'Decline Offer',
      'feedback_request': 'Request Feedback',
      'interview_scheduling': 'Schedule Interview'
    };
    return titles[type] || 'Email';
  }
  
  // Generate email function
  async function generateEmail(type) {
    const outputArea = document.getElementById('emailOutputArea');
    outputArea.innerHTML = '<div class="email-loading"><div class="spinner"></div><p>Generating your email...</p></div>';
    
    let payload = { 
      email_type: type,
      tone: document.getElementById('emailTone')?.value || 'professional',
      length: document.getElementById('emailLength')?.value || 'medium'
    };
    
    if (type === 'custom') {
      payload.custom_request = document.getElementById('customEmailRequest')?.value || '';
      payload.context = document.getElementById('additionalContext')?.value || '';
      payload.include_resume = document.getElementById('includeResume')?.checked || false;
      
      if (!payload.custom_request || payload.custom_request.trim().length < 10) {
        outputArea.innerHTML = '';
        showNotification('Please describe the email you need (at least 10 characters)', 'warning');
        return;
      }
    } else if (type === 'job_application') {
      payload.company = document.getElementById('emailCompany')?.value || '';
      payload.job_title = document.getElementById('emailJobTitle')?.value || '';
      payload.jd = document.getElementById('emailJD')?.value || '';
      payload.include_resume = document.getElementById('includeResume')?.checked || false;
      
      if (!payload.company || !payload.job_title || !payload.jd) {
        outputArea.innerHTML = '';
        showNotification('Please fill in all required fields (Company, Job Title, Job Description)', 'warning');
        return;
      }
    } else if (type === 'cover_letter') {
      payload.company = document.getElementById('emailCompany')?.value || '';
      payload.job_title = document.getElementById('emailJobTitle')?.value || '';
      payload.jd = document.getElementById('emailJD')?.value || '';
      payload.include_resume = document.getElementById('includeResume')?.checked || false;
      
      if (!payload.company || !payload.job_title || !payload.jd) {
        outputArea.innerHTML = '';
        showNotification('Please fill in Company, Job Title, and Job Description', 'warning');
        return;
      }
    } else if (type === 'reply') {
      payload.recruiter_email = document.getElementById('recruiterEmail')?.value || '';
      payload.context = document.getElementById('additionalContext')?.value || '';
      
      if (!payload.recruiter_email) {
        outputArea.innerHTML = '';
        showNotification('Please paste the recruiter\'s email', 'warning');
        return;
      }
    } else {
      payload.company = document.getElementById('emailCompany')?.value || '';
      payload.job_title = document.getElementById('emailJobTitle')?.value || '';
      payload.context = document.getElementById('additionalContext')?.value || '';
    }
    
    try {
      const headers = { 
        'Content-Type': 'application/json'
      };
      
      // Add Basic Auth if user is logged in
      if (dashboardCredentials) {
        headers['Authorization'] = 'Basic ' + btoa(`${dashboardCredentials.username}:${dashboardCredentials.password}`);
      }
      
      const response = await fetch('/api/email/generate', {
        method: 'POST',
        headers: headers,
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText || 'Failed to generate email');
      }
      
      const result = await response.json();
      currentEmailInputs = payload;
      displayGeneratedEmail(result);
      saveToEmailHistory(result, payload);
      
    } catch (error) {
      console.error('Error generating email:', error);
      outputArea.innerHTML = `<div class="email-error"><p>Error: ${error.message}</p></div>`;
    }
  }
  
  // Display generated email
  function displayGeneratedEmail(result) {
    const outputHTML = `
      <div class="email-output-card">
        <h3>Generated Email</h3>
        
        <div class="email-field-group">
          <label>Subject</label>
          <input type="text" id="emailSubject" value="${result.subject.replace(/"/g, '&quot;')}">
        </div>
        
        <div class="email-field-group">
          <label>Body</label>
          <textarea id="emailBody" rows="12">${result.body}</textarea>
        </div>
        
        <div class="email-action-buttons">
          <button onclick="copyEmail()" class="btn-primary">
            Copy Email
          </button>
          <button onclick="regenerateEmailWithFeedback()" class="btn-secondary">
            Regenerate
          </button>
        </div>
      </div>
    `;
    
    document.getElementById('emailOutputArea').innerHTML = outputHTML;
  }
  
  // Copy email to clipboard
  function copyEmail() {
    const subject = document.getElementById('emailSubject')?.value || '';
    const body = document.getElementById('emailBody')?.value || '';
    const fullEmail = `Subject: ${subject}\n\n${body}`;
    
    navigator.clipboard.writeText(fullEmail).then(() => {
      showToast('Email copied to clipboard!', 'success');
    }).catch(err => {
      console.error('Failed to copy:', err);
      showToast('Failed to copy email', 'error');
    });
  }
  
  // Regenerate email
  function regenerateEmailWithFeedback() {
    if (!currentEmailInputs) {
      showToast('‚ùå No previous inputs found', 'error');
      return;
    }
    
    // Get current edited values
    const editedSubject = document.getElementById('emailSubject')?.value;
    const editedBody = document.getElementById('emailBody')?.value;
    
    // Add feedback context
    if (editedSubject || editedBody) {
      const feedback = 'Please improve the email based on these user edits:\n';
      currentEmailInputs.context = (currentEmailInputs.context || '') + '\n' + feedback;
    }
    
    // Regenerate
    generateEmail(currentEmailInputs.email_type);
  }
  
  // Save to session storage
  function saveToEmailHistory(result, inputs) {
    let history = JSON.parse(sessionStorage.getItem('emailHistory') || '[]');
    
    history.unshift({
      id: Date.now(),
      type: inputs.email_type,
      inputs: inputs,
      result: result,
      timestamp: new Date().toISOString()
    });
    
    // Keep only last 20
    if (history.length > 20) history = history.slice(0, 20);
    
    sessionStorage.setItem('emailHistory', JSON.stringify(history));
    loadEmailHistory();
  }
  
  // Load email history
  function loadEmailHistory() {
    const history = JSON.parse(sessionStorage.getItem('emailHistory') || '[]');
    const historyList = document.getElementById('emailHistoryList');
    
    if (!historyList) return;
    
    if (history.length === 0) {
      historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No emails generated yet. Generate your first email above!</p>';
      return;
    }
    
    const historyHTML = history.map(item => {
      const icon = getEmailTypeIcon(item.type);
      
      // Generate better title based on email type
      let title;
      if (item.inputs.custom_request) {
        title = item.inputs.custom_request.substring(0, 50) + (item.inputs.custom_request.length > 50 ? '...' : '');
      } else if (item.inputs.company && item.inputs.job_title) {
        title = `${item.inputs.company} - ${item.inputs.job_title}`;
      } else if (item.inputs.company) {
        title = `${item.inputs.company} (${getEmailTypeName(item.type)})`;
      } else if (item.type === 'reply' && item.inputs.recruiter_email) {
        // For reply emails, extract subject or company from recruiter email
        const emailPreview = item.inputs.recruiter_email.substring(0, 60).trim();
        title = `Reply: ${emailPreview}${emailPreview.length < item.inputs.recruiter_email.length ? '...' : ''}`;
      } else {
        title = getEmailTypeName(item.type);
      }
      
      const timeAgo = formatTimeAgo(item.timestamp);
      
      return `
        <div class="history-item" onclick="loadEmailFromHistory(${item.id})" 
          style="background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;"
          onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'"
          onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
          <div style="display: flex; align-items: start; gap: 12px;">
            <div style="font-size: 24px;">${icon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${title}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">${timeAgo}</div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                <span style="background: var(--bg); padding: 2px 8px; border-radius: 4px; display: inline-block;">
                  ${item.inputs.tone} ‚Ä¢ ${item.inputs.length}
                </span>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    historyList.innerHTML = historyHTML;
  }
  
  // Load email from history
  function loadEmailFromHistory(id) {
    const history = JSON.parse(sessionStorage.getItem('emailHistory') || '[]');
    const item = history.find(h => h.id === id);
    
    if (!item) return;
    
    currentEmailInputs = item.inputs;
    displayGeneratedEmail(item.result);
    
    // Scroll to output
    document.getElementById('emailOutputArea').scrollIntoView({ behavior: 'smooth' });
  }
  
  // Helper functions
  function getEmailTypeIcon(type) {
    // Return empty string for minimal/clean UI
    return '';
  }
  
  function getEmailTypeName(type) {
    const names = {
      'job_application': 'Job Application',
      'reply': 'Reply to Recruiter',
      'followup': 'Follow-up',
      'thankyou': 'Thank You',
      'networking': 'Networking',
      'salary_negotiation': 'Salary Negotiation',
      'resignation': 'Resignation',
      'referral_request': 'Referral Request',
      'decline_offer': 'Decline Offer',
      'feedback_request': 'Feedback Request',
      'interview_scheduling': 'Interview Scheduling',
      'custom': 'Custom Email'
    };
    return names[type] || 'Email';
  }
  
  function formatTimeAgo(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const seconds = Math.floor((now - then) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
  }

  // ===== JOB SEARCH FUNCTIONALITY =====
  
  const searchJobsBtn = document.getElementById('searchJobsBtn');
  if (searchJobsBtn) {
    searchJobsBtn.addEventListener('click', searchJobs);
  }

  async function searchJobs() {
    const jobTitle = document.getElementById('jobSearchTitle').value.trim();
    
    // Use custom location input if filled, otherwise fall back to select
    const customLocation = document.getElementById('jobSearchLocationCustom').value.trim();
    const location = customLocation || 'remote OR us OR usa';
    
    // Get date posted with null check
    const datePostedEl = document.getElementById('jobSearchDate');
    const datePosted = datePostedEl ? datePostedEl.value : 'week';
    
    // Get sort by with null check
    const sortByEl = document.getElementById('jobSearchSort');
    const sortBy = sortByEl ? sortByEl.value : 'relevance';
    
    const maxResults = parseInt(document.getElementById('jobSearchMaxResults').value);
    
    // Get employment types (with null checks)
    const employmentTypes = [];
    const fullTimeEl = document.getElementById('typeFullTime');
    const partTimeEl = document.getElementById('typePartTime');
    const contractEl = document.getElementById('typeContract');
    const internEl = document.getElementById('typeIntern');
    
    if (fullTimeEl && fullTimeEl.checked) employmentTypes.push('FULLTIME');
    if (partTimeEl && partTimeEl.checked) employmentTypes.push('PARTTIME');
    if (contractEl && contractEl.checked) employmentTypes.push('CONTRACTOR');
    if (internEl && internEl.checked) employmentTypes.push('INTERN');
    
    // Default to full-time if no employment types selected
    if (employmentTypes.length === 0) {
      employmentTypes.push('FULLTIME');
    }
    
    // Get experience level
    const experienceLevelEl = document.getElementById('jobExperienceLevel');
    const experienceLevel = experienceLevelEl ? experienceLevelEl.value : '';
    
    // Get remote work preference
    const remoteEl = document.getElementById('typeRemote');
    const workFromHome = remoteEl && remoteEl.checked;
    
    // Get salary range (with null checks)
    const salaryMinEl = document.getElementById('salaryMin');
    const salaryMaxEl = document.getElementById('salaryMax');
    const salaryFrequencyEl = document.getElementById('salaryFrequency');
    
    const salaryMin = salaryMinEl ? salaryMinEl.value : '';
    const salaryMax = salaryMaxEl ? salaryMaxEl.value : '';
    const salaryFrequency = salaryFrequencyEl ? salaryFrequencyEl.value : 'yearly';
    
    // Get selected source
    const jobSourceEl = document.getElementById('jobSearchSource');
    const selectedSource = jobSourceEl ? jobSourceEl.value : 'jsearch';
    
    // Map source to backend sources list
    let sources = ['jsearch'];
    if (selectedSource === 'workday') {
      sources = ['workday'];
    } else if (selectedSource === 'lever') {
      sources = ['lever'];
    } else if (selectedSource === 'icims') {
      sources = ['icims'];
    } else if (selectedSource === 'bamboohr') {
      sources = ['bamboohr'];
    } else if (selectedSource === 'greenhouse') {
      sources = ['greenhouse'];
    }
    
    if (!jobTitle) {
      showNotification('Please enter a job title', 'warning');
      return;
    }
    
    console.log('[JOB_SEARCH] Starting search with params:', {
      job_title: jobTitle,
      location: location,
      max_results: maxResults,
      employment_types: employmentTypes,
      source: selectedSource,
      sort_by: sortBy
    });
    
    // Show loading
    document.getElementById('jobSearchLoading').style.display = 'block';
    document.getElementById('jobSearchResults').innerHTML = '';
    searchJobsBtn.disabled = true;
    searchJobsBtn.textContent = 'Searching...';
    
    try {
      const searchParams = {
        job_title: jobTitle,
        location: location,
        date_posted: datePosted,
        sources: sources,
        max_results: maxResults,
        employment_types: employmentTypes,
        experience_level: experienceLevel,
        work_from_home: workFromHome,
        salary_min: salaryMin ? parseInt(salaryMin) : undefined,
        salary_max: salaryMax ? parseInt(salaryMax) : undefined,
        salary_frequency: salaryFrequency,
        sort_by: sortBy
      };
      
      // Remove undefined values
      Object.keys(searchParams).forEach(key => 
        searchParams[key] === undefined && delete searchParams[key]
      );

      const data = await dashApiCall('/api/search-jobs', {
        method: 'POST',
        body: JSON.stringify(searchParams)
      });
      
      if (data.success) {
        displayJobResults(data.jobs, data.cached, data.cache_hits);
      } else {
        throw new Error(data.detail || 'Failed to search jobs');
      }
    } catch (error) {
      console.error('Error searching jobs:', error);
      showNotification('Error searching jobs. Please try again.', 'error');
      document.getElementById('jobSearchResults').innerHTML = `
        <div class="no-results">
          <h3>Error occurred</h3>
          <p>${error.message}</p>
        </div>
      `;
    } finally {
      document.getElementById('jobSearchLoading').style.display = 'none';
      searchJobsBtn.disabled = false;
      searchJobsBtn.textContent = 'Search Jobs';
    }
  }

  function displayJobResults(jobs, cached = false, cacheHits = 0) {
    const resultsContainer = document.getElementById('jobSearchResults');
    
    if (jobs.length === 0) {
      resultsContainer.innerHTML = `
        <div class="no-results">
          <h3>No jobs found</h3>
          <p>Try adjusting your search criteria</p>
        </div>
      `;
      return;
    }
    
    // Create cache info banner
    const cacheInfo = cached ? `
      <div class="cache-info-banner" style="background: var(--success-bg, #d4edda); color: var(--success-text, #155724); padding: 12px 16px; border-radius: var(--radius-md); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm-1 13v-2h2v2H9zm0-4V7h2v4H9z"/>
        </svg>
        <span><strong>Cached Results</strong> - Loaded from cache (${cacheHits} hits) ‚Ä¢ Faster & resource-efficient</span>
      </div>
    ` : '';
    
    resultsContainer.innerHTML = `
      ${cacheInfo}
      <h3 style="margin-bottom: 20px; color: var(--text);">Found ${jobs.length} jobs</h3>
      ${jobs.map(job => createJobCard(job)).join('')}
    `;
  }

  function createJobCard(job) {
    return `
      <div class="job-card">
        <div class="job-header">
          <div>
            <h3 class="job-title">${escapeHtml(job.title)}</h3>
            <p class="job-company">${escapeHtml(job.company)}</p>
            <p class="job-location">üìç ${escapeHtml(job.location)}</p>
          </div>
          <span class="job-source">${escapeHtml(job.source)}</span>
        </div>
        
        ${job.snippet ? `<p class="job-snippet">${escapeHtml(job.snippet)}</p>` : ''}
        
        <div class="job-actions">
          <a href="${escapeHtml(job.link)}" target="_blank" rel="noopener noreferrer" class="job-link-btn">
            View Job ‚Üí
          </a>
          <button class="job-use-btn" onclick='useJobForResume(${JSON.stringify(job).replace(/'/g, "&#39;")})'>
            Use for Resume
          </button>
        </div>
      </div>
    `;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function useJobForResume(job) {
    if (!job) {
      showNotification('Invalid job data', 'error');
      return;
    }
    
    console.log('[USE_FOR_RESUME] Job data:', job);
    
    // Switch to JD/Resume tab
    switchTab('jd');
    
    // Get form fields with null checks
    const companyField = document.getElementById('companyNameJD');
    const titleField = document.getElementById('jobTitleJD');
    const linkField = document.getElementById('jobLinkJD');
    const jdField = document.getElementById('jdTextarea');
    
    // Fill company and title
    if (companyField) companyField.value = job.company || '';
    if (titleField) titleField.value = job.title || '';
    if (linkField) linkField.value = job.link || job.url || '';
    
    // For description, use: job_description (full) > description > snippet
    let description = job.job_description || job.description || job.snippet || '';
    
    // If we only have a snippet and there's a valid link, try to fetch full description
    if (!job.job_description && !job.description && job.snippet && (job.link || job.url)) {
      const jobUrl = job.link || job.url;
      console.log('[USE_FOR_RESUME] Only snippet available, attempting to fetch full description from:', jobUrl);
      
      try {
        showResult('Fetching full job description...', 'info');
        
        const response = await fetch('/api/scrape-job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: jobUrl })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.job && data.job.description) {
            description = data.job.description;
            console.log('[USE_FOR_RESUME] Successfully fetched full description');
          }
        }
      } catch (error) {
        console.warn('[USE_FOR_RESUME] Failed to fetch full description:', error);
        // Continue with snippet - not a critical error
      }
    }
    
    if (jdField) jdField.value = description;
    
    // Show appropriate message
    if (description && description.length > 300) {
      showResult('‚úÖ Job details loaded! Review and generate your resume.', 'success');
    } else if (description && description.length > 100) {
      showResult('‚ö†Ô∏è Limited job description available. You may want to copy more details from the job posting.', 'warning');
    } else {
      showResult('‚ö†Ô∏è No full description available. Please click "View Job" and copy the description manually.', 'warning');
    }
  }

  // Cache Stats Functions
  async function loadCacheStats() {
    try {
      const response = await fetch('/api/cache/stats');
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        displayCacheStats(data.stats);
      } else {
        throw new Error(data.detail || 'Failed to load cache stats');
      }
    } catch (error) {
      console.error('Error loading cache stats:', error);
      showResult('‚ùå Failed to load cache statistics', 'error');
    }
  }

  function displayCacheStats(stats) {
    const display = document.getElementById('cacheStatsDisplay');
    
    const popularSearchesHTML = stats.popular_searches.length > 0 ? `
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 10px;">Most Popular Searches</h4>
        <div style="display: grid; gap: 10px;">
          ${stats.popular_searches.map(search => `
            <div style="padding: 10px; background: var(--bg); border-radius: var(--radius-md); display: flex; justify-content: space-between;">
              <span><strong>${escapeHtml(search.job_title)}</strong> in ${escapeHtml(search.location)}</span>
              <span style="color: var(--accent); font-weight: 600;">${search.hits} hits</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : '<p style="margin-top: 20px; color: var(--text-secondary);">No popular searches yet</p>';
    
    display.innerHTML = `
      <h3 style="margin-bottom: 20px;">Cache Statistics</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div class="stat-card">
          <div class="stat-value">${stats.total_cache_entries}</div>
          <div class="stat-label">Total Cache Entries</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${stats.active_entries}</div>
          <div class="stat-label">Active Entries</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${stats.expired_entries}</div>
          <div class="stat-label">Expired Entries</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${stats.total_cache_hits}</div>
          <div class="stat-label">Total Cache Hits</div>
        </div>
      </div>
      
      ${popularSearchesHTML}
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button onclick="clearExpiredCache()" class="secondary-btn" style="margin-right: 10px;">
          Clear Expired Cache
        </button>
        <button onclick="clearAllCache()" class="secondary-btn" style="background: var(--danger, #dc3545); color: white;">
          ‚ö†Ô∏è Clear All Cache
        </button>
      </div>
    `;
    
    display.style.display = 'block';
  }

  async function clearExpiredCache() {
    console.log('[DEBUG] clearExpiredCache function called');
    
    if (!confirm('Clear expired cache entries?')) {
      console.log('[DEBUG] User cancelled clear expired cache action');
      return;
    }
    
    console.log('[DEBUG] User confirmed, sending request to clear expired cache');
    
    try {
      const response = await fetch('/api/cache/clear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'expired' })
      });
      
      console.log('[DEBUG] Clear expired cache response:', response.status, response.statusText);
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        showResult(`‚úÖ ${data.message}`, 'success');
        loadCacheStats(); // Reload stats
      } else {
        throw new Error(data.detail || 'Failed to clear cache');
      }
    } catch (error) {
      console.error('Error clearing cache:', error);
      showResult('‚ùå Failed to clear cache', 'error');
    }
  }

  async function clearAllCache() {
    console.log('[DEBUG] clearAllCache function called');
    
    if (!confirm('‚ö†Ô∏è This will clear ALL cached job searches. Are you sure?')) {
      console.log('[DEBUG] User cancelled clear cache action');
      return;
    }
    
    console.log('[DEBUG] User confirmed, sending request to clear cache');
    
    try {
      const response = await fetch('/api/cache/clear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'all' })
      });
      
      console.log('[DEBUG] Clear cache response:', response.status, response.statusText);
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        showResult(`‚úÖ ${data.message}`, 'success');
        loadCacheStats(); // Reload stats
      } else {
        throw new Error(data.detail || 'Failed to clear cache');
      }
    } catch (error) {
      console.error('Error clearing cache:', error);
      showResult('‚ùå Failed to clear cache', 'error');
    }
  }

  // Setup cache stats button
  document.getElementById('viewCacheStatsBtn').addEventListener('click', function() {
    const display = document.getElementById('cacheStatsDisplay');
    if (display.style.display === 'none') {
      loadCacheStats();
      this.textContent = 'Hide Cache Statistics';
    } else {
      display.style.display = 'none';
      this.textContent = 'View Cache Statistics';
    }
  });

  // Show cache stats button when job results are displayed
  const originalDisplayJobResults = displayJobResults;
  displayJobResults = function(...args) {
    originalDisplayJobResults.apply(this, args);
    document.getElementById('viewCacheStatsBtn').style.display = 'inline-block';
  };

  // Debug function for testing cache clear - can be called from console
  window.testClearCache = async function() {
    console.log('[TEST] Testing clear cache API call directly');
    try {
      const response = await fetch('/api/cache/clear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'all' })
      });
      
      console.log('[TEST] Response status:', response.status);
      console.log('[TEST] Response headers:', [...response.headers.entries()]);
      
      const data = await response.json();
      console.log('[TEST] Response data:', data);
      
      if (response.ok) {
        console.log('[TEST] ‚úÖ Clear cache API is working!');
        return data;
      } else {
        console.error('[TEST] ‚ùå Clear cache API failed:', data);
        return data;
      }
    } catch (error) {
      console.error('[TEST] ‚ùå Error calling clear cache API:', error);
      return error;
    }
  };

  // ===== DYNAMIC JOB SEARCH FUNCTIONS =====
  
  // ===== UNIFIED SEARCH FUNCTIONALITY =====
  
  // Handle job type dropdown
  const jobTypeDisplay = document.getElementById('jobTypeDisplay');
  jobTypeDisplay.addEventListener('change', function() {
    const selectedValue = this.value;
    const selectedTypes = selectedValue.split(',');
    
    // Sync with hidden checkboxes
    document.getElementById('typeFullTime').checked = selectedTypes.includes('FULLTIME');
    document.getElementById('typePartTime').checked = selectedTypes.includes('PARTTIME');
    document.getElementById('typeContract').checked = selectedTypes.includes('CONTRACTOR');
    document.getElementById('typeRemote').checked = selectedTypes.includes('remote');
  });
  
  // Show/hide Greenhouse company selection based on source dropdown
  document.getElementById('jobSearchSource').addEventListener('change', function() {
    const toggleRow = document.getElementById('greenhouseToggleRow');
    const section = document.getElementById('greenhouseCompanySection');
    
    if (this.value === 'greenhouse') {
      toggleRow.style.display = 'block';
      updateSelectedCompanyCount();
    } else {
      toggleRow.style.display = 'none';
      section.style.display = 'none';
    }
  });
  
  // Toggle company selection when button is clicked
  document.getElementById('showCompanySelectionBtn').addEventListener('click', function() {
    const section = document.getElementById('greenhouseCompanySection');
    if (section.style.display === 'none' || section.style.display === '') {
      section.style.display = 'block';
    } else {
      section.style.display = 'none';
    }
  });
  
  // Update selected company count
  function updateSelectedCompanyCount() {
    const checkboxes = document.querySelectorAll('#greenhouseCompanySection input[type="checkbox"]:checked');
    document.getElementById('selectedCompanyCount').textContent = checkboxes.length;
  }
  
  // Select/clear all Greenhouse companies
  function selectAllGreenhouse() {
    const checkboxes = document.querySelectorAll('#greenhouseCompanySection input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedCompanyCount();
  }
  
  function clearAllGreenhouse() {
    const checkboxes = document.querySelectorAll('#greenhouseCompanySection input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedCompanyCount();
  }
  
  // Add listeners to all company checkboxes to update count
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('#greenhouseCompanySection input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateSelectedCompanyCount);
    });
  });
  
  // Unified search button handler
  document.getElementById('searchJobsBtn').addEventListener('click', function() {
    const source = document.getElementById('jobSearchSource').value;
    if (source === 'greenhouse') {
      searchGreenhouseJobs();
    } else {
      searchJobs();
    }
  });
  
  async function searchGreenhouseJobs() {
    const jobTitle = document.getElementById('jobSearchTitle').value.trim();
    const customLocation = document.getElementById('jobSearchLocationCustom').value.trim();
    const location = customLocation || 'remote OR us OR usa';
    const maxResults = parseInt(document.getElementById('jobSearchMaxResults').value);
    
    // Get selected companies
    const selectedCompanies = [];
    const checkboxes = document.querySelectorAll('#greenhouseCompanySection input[type="checkbox"]:checked');
    checkboxes.forEach(cb => selectedCompanies.push(cb.value));
    
    // Get job type filters (same as JSearch)
    const employmentTypes = [];
    if (document.getElementById('typeFullTime').checked) employmentTypes.push('FULLTIME');
    if (document.getElementById('typePartTime').checked) employmentTypes.push('PARTTIME');
    if (document.getElementById('typeContract').checked) employmentTypes.push('CONTRACTOR');
    
    const remoteOnly = document.getElementById('typeRemote').checked;
    
    // Get date posted filter
    const datePosted = document.getElementById('jobSearchDate').value;
    
    if (!jobTitle) {
      showNotification('Please enter a job title', 'error');
      return;
    }
    
    if (selectedCompanies.length === 0) {
      showNotification('Please select at least one company', 'error');
      return;
    }
    
    // Show filter info
    const filterInfo = [];
    if (employmentTypes.length > 0) filterInfo.push(`Types: ${employmentTypes.join(', ')}`);
    if (remoteOnly) filterInfo.push('Remote Only');
    if (datePosted && datePosted !== 'all') {
      const dateLabels = {
        'today': 'Posted Today',
        '3days': 'Last 3 Days',
        'week': 'This Week',
        'month': 'This Month'
      };
      filterInfo.push(dateLabels[datePosted] || datePosted);
    }
    if (filterInfo.length > 0) {
      showNotification(`Searching ${selectedCompanies.length} companies with filters: ${filterInfo.join(' | ')}`, 'info');
    }
    
    // Show loading
    document.getElementById('jobSearchLoading').style.display = 'block';
    document.getElementById('jobSearchResults').innerHTML = '';
    const searchBtn = document.getElementById('searchJobsBtn');
    searchBtn.disabled = true;
    searchBtn.textContent = 'Searching...';
    
    try {
      const searchParams = {
        job_title: jobTitle,
        location: location,
        max_results: maxResults,
        company_tokens: selectedCompanies,
        employment_types: employmentTypes,
        remote_jobs_only: remoteOnly,
        date_posted: datePosted
      };
      
      console.log('[GREENHOUSE_SEARCH] Search params:', searchParams);
      console.log('[GREENHOUSE_SEARCH] Employment types:', employmentTypes);
      console.log('[GREENHOUSE_SEARCH] Remote only:', remoteOnly);
      console.log('[GREENHOUSE_SEARCH] Date posted:', datePosted);
      
      const data = await dashApiCall('/api/search-greenhouse-jobs', {
        method: 'POST',
        body: JSON.stringify(searchParams)
      });
      
      if (data.success) {
        displayGreenhouseResults(data.jobs, data.companies_searched);
      } else {
        throw new Error(data.detail || 'Failed to search Greenhouse jobs');
      }
    } catch (error) {
      console.error('Error searching Greenhouse jobs:', error);
      showNotification('Error searching Greenhouse jobs. Please try again.', 'error');
      document.getElementById('jobSearchResults').innerHTML = `
        <div class="no-results">
          <h3>Error occurred</h3>
          <p>${error.message}</p>
        </div>
      `;
    } finally {
      document.getElementById('jobSearchLoading').style.display = 'none';
      searchBtn.disabled = false;
      searchBtn.textContent = 'Search Jobs';
    }
  }
  
  function displayGreenhouseResults(jobs, companiesSearched) {
    const resultsContainer = document.getElementById('jobSearchResults');
    
    if (jobs.length === 0) {
      resultsContainer.innerHTML = `
        <div class="no-results">
          <h3>No jobs found</h3>
          <p>Try different companies or adjust your search criteria</p>
          <p style="margin-top: 10px; color: var(--text-secondary);">
            Searched: ${companiesSearched.join(', ')}
          </p>
        </div>
      `;
      return;
    }
    
    // Create Greenhouse info banner
    const greenhouseInfo = `
      <div class="cache-info-banner" style="background: var(--primary-light, #e3f2fd); color: var(--primary-dark, #1565c0); padding: 12px 16px; border-radius: var(--radius-md); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span><strong>Greenhouse Results</strong> - High-quality jobs from ${companiesSearched.length} tech companies: ${companiesSearched.slice(0,3).join(', ')}${companiesSearched.length > 3 ? ` +${companiesSearched.length-3} more` : ''}</span>
      </div>
    `;
    
    resultsContainer.innerHTML = `
      ${greenhouseInfo}
      <h3 style="margin-bottom: 20px; color: var(--text);">Found ${jobs.length} jobs from ${companiesSearched.length} companies</h3>
      ${jobs.map(job => createJobCard(job)).join('')}
    `;
  }
  
  // Job Title Suggestions
  function selectJobTitle(title) {
    document.getElementById('jobSearchTitle').value = title;
    document.getElementById('jobTitleSuggestions').style.display = 'none';
  }

  // Location Suggestions
  function showLocationSuggestions(value) {
    const suggestions = document.getElementById('locationSuggestions');
    if (value.length > 0) {
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  }

  function selectLocation(location) {
    document.getElementById('jobSearchLocationCustom').value = location;
    document.getElementById('locationSuggestions').style.display = 'none';
  }

  // Hide suggestions when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.location-input-container')) {
      document.getElementById('locationSuggestions').style.display = 'none';
    }
    if (!event.target.closest('#jobSearchTitle') && !event.target.closest('#jobTitleSuggestions')) {
      document.getElementById('jobTitleSuggestions').style.display = 'none';
    }
  });

  // Advanced Filters Toggle
  function toggleAdvancedFilters() {
    const content = document.getElementById('advancedFiltersContent');
    const toggle = document.getElementById('advancedFilterToggle');
    
    if (content.style.display === 'none') {
      content.style.display = 'block';
      toggle.textContent = '‚ñ≤ Hide';
    } else {
      content.style.display = 'none';
      toggle.textContent = '‚ñº Show';
    }
  }

  // Show job title suggestions on focus
  document.getElementById('jobSearchTitle').addEventListener('focus', function() {
    document.getElementById('jobTitleSuggestions').style.display = 'block';
  });

</script>

<!-- Custom Confirm Modal - Positioned at body level -->
<div id="customConfirmModalBodyLevel" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;align-items:center;justify-content:center;background:rgba(15,23,42,0.7);">
  <div style="width:400px;max-width:90%;min-height:150px;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);background:#ffffff;position:relative;">
    <h3 id="confirmModalTitleBodyLevel" style="margin:0 0 8px 0;color:#333;font-size:18px;font-weight:600;text-align:center;">Confirm Action</h3>
    <p id="confirmModalMessageBodyLevel" style="margin:0 0 20px 0;color:#666;font-size:14px;line-height:1.4;text-align:center;">Are you sure?</p>
    <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
      <button id="confirmModalCancelBodyLevel" style="padding:8px 20px;border:1px solid #ddd;background:#ffffff;color:#333;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;">Cancel</button>
      <button id="confirmModalOkBodyLevel" style="padding:8px 20px;border:none;background:#e74c3c;color:#ffffff;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;">OK</button>
    </div>
  </div>
</div>

<script src="/static/js/main.js?v=23.0"></script>

<!-- Tutorial/Onboarding System -->
<div class="tutorial-overlay" id="tutorialOverlay"></div>

<div class="tutorial-tooltip" id="tutorialTooltip">
  <div class="tutorial-header">
    <div class="tutorial-step-badge">
      <span class="step-icon">üìö</span>
      <span id="tutorialStepText">Step 1 of 10</span>
    </div>
    <button class="tutorial-close-btn" onclick="endTutorial()">‚úï</button>
  </div>
  <div class="tutorial-body">
    <h3 class="tutorial-title" id="tutorialTitle">
      <span class="title-icon" id="tutorialTitleIcon"></span>
      <span id="tutorialTitleText">Welcome!</span>
    </h3>
    <p class="tutorial-description" id="tutorialDescription">
      Let's get started with Resume Builder Pro.
    </p>
    <div class="tutorial-tip" id="tutorialTip" style="display: none;">
      <p id="tutorialTipText"></p>
    </div>
  </div>
  <div class="tutorial-footer">
    <div class="tutorial-progress" id="tutorialProgress"></div>
    <div class="tutorial-nav">
      <button class="tutorial-btn tutorial-btn-secondary" id="tutorialPrevBtn" onclick="prevTutorialStep()">
        ‚Üê Back
      </button>
      <button class="tutorial-btn tutorial-btn-primary" id="tutorialNextBtn" onclick="nextTutorialStep()">
        Next ‚Üí
      </button>
    </div>
  </div>
</div>

<div class="tutorial-welcome-modal" id="tutorialWelcomeModal">
  <button class="tutorial-welcome-close" onclick="hideTutorialWelcome()" title="Close">‚úï</button>
  <div class="tutorial-welcome-header">
    <h2 class="tutorial-welcome-title">Welcome! Let's Get Started</h2>
    <p class="tutorial-welcome-subtitle">Follow these simple steps to build your perfect resume</p>
  </div>
  <div class="tutorial-welcome-body">
    <ul class="tutorial-feature-list">
      <li>
        <span class="tutorial-feature-icon" style="background: linear-gradient(135deg, #10b981, #059669); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">1</span>
        <div class="tutorial-feature-text">
          <strong>Upload Your Resume First!</strong>
          <span>This is required - upload PDF or Word to parse your info</span>
        </div>
      </li>
      <li>
        <span class="tutorial-feature-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">2</span>
        <div class="tutorial-feature-text">
          <strong>Generate Tailored Resumes</strong>
          <span>Paste a job description, AI optimizes your resume</span>
        </div>
      </li>
      <li>
        <span class="tutorial-feature-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">3</span>
        <div class="tutorial-feature-text">
          <strong>Search & Apply for Jobs</strong>
          <span>Find jobs and generate resumes in one click</span>
        </div>
      </li>
      <li>
        <span class="tutorial-feature-icon" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">4</span>
        <div class="tutorial-feature-text">
          <strong>Write Professional Emails</strong>
          <span>AI-generated follow-ups and cover letters</span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tutorial-welcome-footer">
    <button class="tutorial-start-btn" onclick="startTutorial()">
      <span>Take the Tour</span>
    </button>
    <button class="tutorial-skip-link" onclick="skipTutorialAndUpload()">
      Skip & Upload Resume Now ‚Üí
    </button>
  </div>
</div>

<!-- Tutorial now accessible from header menu -->

<script>
// ===== ONBOARDING TUTORIAL SYSTEM =====

const tutorialSteps = [
  {
    target: '.resume-builder-actions',
    title: 'Step 1: Upload Your Resume',
    titleIcon: '',
    description: 'Click the "Upload" button to upload your PDF or Word resume. This is the first and most important step!',
    tip: 'Your resume will be automatically parsed and all fields will be filled in. You can edit any section after uploading.',
    position: 'bottom',
    beforeShow: function() {
      switchTab('resume');
    }
  },
  {
    target: '.form-nav',
    title: 'Step 2: Review Your Resume',
    titleIcon: '',
    description: 'After uploading, use this navigation to review and edit each section: Basic Info, Contact, Skills, Experience, Education, Projects, and Certifications.',
    tip: 'Make sure all your information is correct before generating tailored resumes.',
    position: 'right',
    beforeShow: function() {
      switchTab('resume');
      // Close the action menu
      var menu = document.getElementById('actionDropdownMenu');
      if (menu) menu.style.display = 'none';
    }
  },
  {
    target: '#tabEditJDBtn',
    title: 'Step 3: Generate Tailored Resumes',
    titleIcon: '',
    description: 'Click this tab to create AI-optimized resumes. Paste a job description and our AI will tailor your resume to match!',
    tip: 'You must upload your resume first (Step 1) before you can generate tailored versions.',
    position: 'right'
  },
  {
    target: '#tabJobSearchBtn',
    title: 'Step 4: Search for Jobs',
    titleIcon: '',
    description: 'Search for jobs from multiple platforms. When you find a match, you can generate a resume for that job with one click!',
    tip: 'Use specific job titles and locations to find the best matches.',
    position: 'right'
  },
  {
    target: '#tabEmailWriterBtn',
    title: 'Step 5: Write Emails',
    titleIcon: '',
    description: 'Generate professional emails for applications, follow-ups, and networking using AI.',
    tip: 'Perfect for thank-you notes after interviews!',
    position: 'right'
  },
  {
    target: '#tabDashboardBtn',
    title: 'Step 6: Track Everything',
    titleIcon: '',
    description: 'View all your generated resumes, saved jobs, and application history in your dashboard.',
    tip: 'Check your dashboard to download previously generated resumes.',
    position: 'bottom'
  },
  {
    target: '#menuToggleBtn',
    title: "You're Ready!",
    titleIcon: '',
    description: "That's it! Click the menu button anytime to access Tutorial and other options. Now go upload your resume and get started!",
    tip: 'Remember: Upload Resume -> Generate Tailored Versions -> Apply for Jobs. Good luck!',
    position: 'bottom',
    beforeShow: function() {
      switchTab('resume');
      // Open the header menu to show tutorial option
      setTimeout(function() {
        var menu = document.getElementById('headerDropdownMenu');
        if (menu) menu.style.display = 'block';
      }, 200);
    },
    afterHide: function() {
      var menu = document.getElementById('headerDropdownMenu');
      if (menu) menu.style.display = 'none';
    }
  }
];

let currentTutorialStep = 0;
let tutorialActive = false;

function initTutorial() {
  // Only initialize tutorial if user is logged in (mainApp is visible)
  const mainApp = document.getElementById('mainApp');
  if (!mainApp || mainApp.style.display === 'none') {
    return; // Don't show tutorial on login page
  }
  
  // Show the Tutorial button in header when logged in
  const headerTutorialBtn = document.getElementById('headerTutorialBtn');
  if (headerTutorialBtn) {
    headerTutorialBtn.style.display = 'block';
  }
  
  // Check if user has seen the tutorial before
  const hasSeenTutorial = localStorage.getItem('resumeBuilderTutorialSeen');
  
  if (!hasSeenTutorial) {
    // Show welcome modal after a short delay for first-time users
    setTimeout(function() {
      showTutorialWelcome();
    }, 1000);
  }
  
  // Render progress dots
  renderProgressDots();
}

function renderProgressDots() {
  const progressContainer = document.getElementById('tutorialProgress');
  progressContainer.innerHTML = '';
  
  for (let i = 0; i < tutorialSteps.length; i++) {
    const dot = document.createElement('div');
    dot.className = 'tutorial-progress-dot';
    if (i === currentTutorialStep) dot.classList.add('active');
    if (i < currentTutorialStep) dot.classList.add('completed');
    progressContainer.appendChild(dot);
  }
}

function showTutorialWelcome() {
  // Only show if logged in
  const mainApp = document.getElementById('mainApp');
  if (!mainApp || mainApp.style.display === 'none') {
    return;
  }
  document.getElementById('tutorialOverlay').classList.add('active');
  document.getElementById('tutorialWelcomeModal').classList.add('active');
}

function hideTutorialWelcome() {
  document.getElementById('tutorialWelcomeModal').classList.remove('active');
}

function startTutorial() {
  hideTutorialWelcome();
  tutorialActive = true;
  currentTutorialStep = 0;
  showTutorialStep(0);
}

function skipTutorial() {
  hideTutorialWelcome();
  document.getElementById('tutorialOverlay').classList.remove('active');
  localStorage.setItem('resumeBuilderTutorialSeen', 'true');
}

function showTutorialStep(stepIndex) {
  const step = tutorialSteps[stepIndex];
  
  // Execute beforeShow callback if exists
  if (step.beforeShow) {
    step.beforeShow();
    // Give the DOM time to update
    setTimeout(function() { positionTooltip(step); }, 300);
  } else {
    positionTooltip(step);
  }
}

function positionTooltip(step) {
  // Remove previous highlight
  document.querySelectorAll('.tutorial-highlight').forEach(function(el) {
    el.classList.remove('tutorial-highlight');
  });
  
  const targetElement = document.querySelector(step.target);
  const tooltip = document.getElementById('tutorialTooltip');
  const overlay = document.getElementById('tutorialOverlay');
  
  if (!targetElement) {
    console.warn('Tutorial target not found:', step.target);
    nextTutorialStep();
    return;
  }
  
  // Highlight target element
  targetElement.classList.add('tutorial-highlight');
  
  // Scroll target into view
  targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Update tooltip content
  document.getElementById('tutorialStepText').textContent = 'Step ' + (currentTutorialStep + 1) + ' of ' + tutorialSteps.length;
  document.getElementById('tutorialTitleIcon').textContent = step.titleIcon;
  document.getElementById('tutorialTitleText').textContent = step.title;
  document.getElementById('tutorialDescription').textContent = step.description;
  
  // Show/hide tip
  const tipElement = document.getElementById('tutorialTip');
  if (step.tip) {
    tipElement.style.display = 'block';
    document.getElementById('tutorialTipText').innerHTML = '<strong>Pro Tip:</strong> ' + step.tip;
  } else {
    tipElement.style.display = 'none';
  }
  
  // Update navigation buttons
  document.getElementById('tutorialPrevBtn').style.display = currentTutorialStep === 0 ? 'none' : 'inline-flex';
  
  const nextBtn = document.getElementById('tutorialNextBtn');
  if (currentTutorialStep === tutorialSteps.length - 1) {
    nextBtn.textContent = 'Finish ‚úì';
  } else {
    nextBtn.innerHTML = 'Next ‚Üí';
  }
  
  // Render progress dots
  renderProgressDots();
  
  // Position tooltip
  setTimeout(function() {
    const targetRect = targetElement.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const padding = 16;
    
    let top, left;
    let arrowClass = 'arrow-top';
    
    // Remove existing arrow classes
    tooltip.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right');
    
    switch (step.position) {
      case 'bottom':
        top = targetRect.bottom + padding;
        left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
        arrowClass = 'arrow-top';
        break;
      case 'top':
        top = targetRect.top - tooltipRect.height - padding;
        left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
        arrowClass = 'arrow-bottom';
        break;
      case 'left':
        top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
        left = targetRect.left - tooltipRect.width - padding;
        arrowClass = 'arrow-right';
        break;
      case 'right':
        top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
        left = targetRect.right + padding;
        arrowClass = 'arrow-left';
        break;
      default:
        top = targetRect.bottom + padding;
        left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
    }
    
    // Keep tooltip within viewport
    if (left < padding) left = padding;
    if (left + tooltipRect.width > window.innerWidth - padding) {
      left = window.innerWidth - tooltipRect.width - padding;
    }
    if (top < padding) top = padding;
    if (top + tooltipRect.height > window.innerHeight - padding) {
      top = window.innerHeight - tooltipRect.height - padding;
    }
    
    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';
    tooltip.classList.add(arrowClass);
    
    // Show overlay and tooltip
    overlay.classList.add('active');
    tooltip.classList.add('active');
  }, 100);
}

function nextTutorialStep() {
  // Call afterHide on current step if exists
  var currentStep = tutorialSteps[currentTutorialStep];
  if (currentStep && currentStep.afterHide) {
    currentStep.afterHide();
  }
  
  if (currentTutorialStep < tutorialSteps.length - 1) {
    currentTutorialStep++;
    showTutorialStep(currentTutorialStep);
  } else {
    endTutorial();
  }
}

function prevTutorialStep() {
  // Call afterHide on current step if exists
  var currentStep = tutorialSteps[currentTutorialStep];
  if (currentStep && currentStep.afterHide) {
    currentStep.afterHide();
  }
  
  if (currentTutorialStep > 0) {
    currentTutorialStep--;
    showTutorialStep(currentTutorialStep);
  }
}

function endTutorial() {
  tutorialActive = false;
  
  // Call afterHide on current step if exists
  var currentStep = tutorialSteps[currentTutorialStep];
  if (currentStep && currentStep.afterHide) {
    currentStep.afterHide();
  }
  
  // Close any open menus
  var actionMenu = document.getElementById('actionDropdownMenu');
  if (actionMenu) actionMenu.style.display = 'none';
  var headerMenu = document.getElementById('headerDropdownMenu');
  if (headerMenu) headerMenu.style.display = 'none';
  
  // Remove highlight
  document.querySelectorAll('.tutorial-highlight').forEach(function(el) {
    el.classList.remove('tutorial-highlight');
  });
  
  // Hide tooltip and overlay
  document.getElementById('tutorialTooltip').classList.remove('active');
  document.getElementById('tutorialOverlay').classList.remove('active');
  document.getElementById('tutorialWelcomeModal').classList.remove('active');
  
  // Mark tutorial as seen
  localStorage.setItem('resumeBuilderTutorialSeen', 'true');
  
  // Switch back to View Resume tab
  switchTab('resume');
}

function skipTutorialAndUpload() {
  // Close tutorial modal
  document.getElementById('tutorialWelcomeModal').classList.remove('active');
  document.getElementById('tutorialOverlay').classList.remove('active');
  
  // Mark tutorial as seen
  localStorage.setItem('resumeBuilderTutorialSeen', 'true');
  
  // Switch to resume tab and trigger upload
  switchTab('resume');
  
  // Slight delay then trigger upload
  setTimeout(function() {
    triggerResumeUpload();
  }, 300);
}

// Tutorial is initialized after login via initTutorial() call
// No DOMContentLoaded initialization - tutorial only shows after authentication

// Handle keyboard navigation
document.addEventListener('keydown', function(e) {
  if (!tutorialActive) return;
  
  if (e.key === 'ArrowRight' || e.key === 'Enter') {
    nextTutorialStep();
  } else if (e.key === 'ArrowLeft') {
    prevTutorialStep();
  } else if (e.key === 'Escape') {
    endTutorial();
  }
});
</script>

</html>
